<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qibla Compass</title>
<style>
body { margin:0; font-family:'Inter',sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; background:#f6eee0;}
.compass-wrapper {position:relative; width:320px; height:320px; margin-bottom:16px;}
.compass-dial {position:absolute; width:100%; height:100%; border-radius:50%; background: radial-gradient(circle at center, #fff, #e0cfa5); box-shadow: inset -4px -4px 15px rgba(0,0,0,0.1), 4px 4px 10px rgba(0,0,0,0.1);}
.needle {position:absolute; width:8px; height:50%; top:0; left:50%; transform-origin:bottom center; background: linear-gradient(to top, #d9534f, #a93226); border-radius:4px; transition: transform 0.05s linear;}
.center-dot {position:absolute; width:20px; height:20px; background:#d3a97c; border-radius:50%; left:calc(50% - 10px); top:calc(50% - 10px); box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3), 2px 2px 4px rgba(0,0,0,0.2);}
.info {text-align:center; font-size:1rem; margin-bottom:12px; color:#333;}
button {margin:4px; padding:6px 12px; border:none; border-radius:5px; background:#a67734; color:#fff; cursor:pointer; transition:0.3s;}
button:hover {background:#c48c58;}
</style>
</head>
<body>

<h2>Qibla Compass</h2>
<div class="compass-wrapper" id="compassWrapper">
  <div class="compass-dial"></div>
  <div class="needle" id="needle"></div>
  <div class="center-dot"></div>
</div>

<div class="info" id="distance">Distance: -- km</div>
<div class="info" id="status">Status: Waiting for GPS...</div>
<button onclick="recalibrate()">Recalibrate</button>

<script>
const KAABA = {lat:21.4225, lon:39.8262};
let userLat = null, userLon = null, heading = 0, qibla = 0;

function deg2rad(d){ return d*Math.PI/180; }
function rad2deg(r){ return r*180/Math.PI; }

function calcQibla(lat, lon){
  const φ1 = deg2rad(lat), φ2 = deg2rad(KAABA.lat), Δλ = deg2rad(KAABA.lon-lon);
  const y = Math.sin(Δλ)*Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return (rad2deg(Math.atan2(y,x))+360)%360;
}

function calcDistance(lat, lon){
  const R = 6371;
  const dLat = deg2rad(KAABA.lat-lat);
  const dLon = deg2rad(KAABA.lon-lon);
  const a = Math.sin(dLat/2)**2 + Math.cos(deg2rad(lat))*Math.cos(deg2rad(KAABA.lat))*Math.sin(dLon/2)**2;
  return (R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1);
}

function rotateNeedle(angle){
  document.getElementById('needle').style.transform = `rotate(${angle}deg)`;
}

function updateCompass(){
  if(userLat==null||userLon==null) return;
  qibla = calcQibla(userLat, userLon);
  const relative = (qibla - heading + 360) % 360;
  rotateNeedle(relative);
  document.getElementById('distance').textContent = `Distance: ${calcDistance(userLat, userLon)} km`;
}

function tryGetLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;
      document.getElementById('status').textContent = `Location: ${userLat.toFixed(4)}, ${userLon.toFixed(4)}`;
      updateCompass();
    }, err=>{
      userLat=3.1390; userLon=101.6869;
      document.getElementById('status').textContent = "GPS unavailable, using KL";
      updateCompass();
    }, {enableHighAccuracy:true, timeout:10000});
  } else {
    userLat=3.1390; userLon=101.6869;
    updateCompass();
  }
}

function handleOrientation(event){
  let alpha = event.alpha;
  if(typeof event.webkitCompassHeading==='number') alpha = event.webkitCompassHeading;
  if(alpha==null) return;
  heading = alpha;
  updateCompass();
}

function startCompass(){
  tryGetLocation();
  if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(resp=>{
      if(resp==='granted'){
        window.addEventListener('deviceorientation', handleOrientation, true);
        document.getElementById('status').textContent='Compass active';
      } else document.getElementById('status').textContent='Permission denied, static Qibla';
    });
  } else if('DeviceOrientationEvent' in window){
    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
    window.addEventListener('deviceorientation', handleOrientation, true);
    document.getElementById('status').textContent='Compass active';
  }
}

function recalibrate(){
  tryGetLocation();
  document.getElementById('status').textContent='Recalibrating...';
}

window.addEventListener('DOMContentLoaded', startCompass);
</script>
</body>
</html>
