<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qibla Compass</title>
<style>
  body { margin:0; font-family:system-ui; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:linear-gradient(#061226,#071026); color:#e8f5ff;}
  h1 {margin-bottom:10px; text-align:center;}
  .compass-face {width:250px; height:250px; border-radius:50%; background:radial-gradient(circle at 50% 40%, rgba(255,255,255,0.02), transparent 40%), linear-gradient(180deg,#071935,#031124); display:flex; align-items:center; justify-content:center; position:relative; border:3px solid rgba(255,255,255,0.03);}
  .needle {width:6px; height:45%; position:absolute; top:5%; left:50%; transform-origin:50% 90%; transition:transform 180ms linear;}
  .needle .head {width:0; height:0; border-left:12px solid transparent; border-right:12px solid transparent; border-bottom:50px solid #f97316; border-radius:2px; position:absolute; top:0; left:50%; transform:translateX(-50%);}
  .needle .tail {width:5px; height:36px; background:rgba(255,255,255,0.06); border-radius:3px; position:absolute; top:36px; left:50%; transform:translateX(-50%);}
  .center {width:12px; height:12px; border-radius:50%; background:#e8f5ff; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);}
  .readout {margin-top:15px; text-align:center;}
  .bigdeg {font-size:28px; font-weight:700;}
  button {margin-top:12px; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:#f97316; color:#041218; font-weight:700;}
  .status {margin-top:8px; font-size:13px; color:#9fb0c8;}
</style>
</head>
<body>

<h1>Qibla Compass</h1>
<div class="compass-face">
  <div class="needle" id="needle">
    <div class="head"></div>
    <div class="tail"></div>
  </div>
  <div class="center"></div>
</div>

<div class="readout">
  <div>Qibla Angle: <span id="qiblaAngle">—</span>°</div>
  <button id="startBtn">Start Compass</button>
  <div class="status" id="status">Press Start. iOS requires permission popup.</div>
</div>

<script>
// Kaaba coordinates
const kaabaLat = 21.422487;
const kaabaLon = 39.826206;

const needle = document.getElementById('needle');
const qiblaAngleEl = document.getElementById('qiblaAngle');
const startBtn = document.getElementById('startBtn');
const status = document.getElementById('status');

let lastRotation = 0;
let qiblaBearing = 0;

// Shortest rotation helper
function rotateNeedle(deg) {
  let diff = (deg - lastRotation + 540) % 360 - 180;
  lastRotation += diff;
  needle.style.transform = `rotate(${lastRotation}deg)`;
}

// Calculate Qibla bearing
function calcQibla(lat1, lon1) {
  const φ1 = lat1 * Math.PI/180;
  const λ1 = lon1 * Math.PI/180;
  const φ2 = kaabaLat * Math.PI/180;
  const λ2 = kaabaLon * Math.PI/180;

  const y = Math.sin(λ2 - λ1) * Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2 - λ1);
  let θ = Math.atan2(y, x) * 180/Math.PI;
  return (θ + 360) % 360;
}

// Screen orientation helper
function getScreenAngle() {
  if (screen && screen.orientation && typeof screen.orientation.angle === 'number') return screen.orientation.angle;
  if (typeof window.orientation === 'number') return window.orientation || 0;
  return 0;
}

// Handle device orientation
function handleOrientation(e) {
  let heading = null;
  if (typeof e.webkitCompassHeading === 'number') {
    heading = e.webkitCompassHeading;
  } else if (e.absolute && typeof e.alpha === 'number') {
    heading = e.alpha;
  } else if (typeof e.alpha === 'number') {
    heading = e.alpha;
  } else return;

  const screenAngle = getScreenAngle();
  const magnetic = (360 - heading + screenAngle + 360) % 360;

  // Needle rotation = Qibla bearing - current magnetic
  rotateNeedle(qiblaBearing - magnetic);
}

// Start compass
async function startCompass() {
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const resp = await DeviceOrientationEvent.requestPermission();
      if (resp !== 'granted') {
        status.textContent = 'Permission denied';
        return;
      }
    } catch(err) {
      status.textContent = 'Permission error';
      return;
    }
  }

  if (!navigator.geolocation) {
    status.textContent = 'Geolocation not supported';
    return;
  }

  status.textContent = 'Getting location...';
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    qiblaBearing = calcQibla(lat, lon);
    qiblaAngleEl.textContent = Math.round(qiblaBearing);
    status.textContent = 'Compass running';
  }, err => {
    status.textContent = 'GPS error: ' + err.message;
  }, {enableHighAccuracy:true, timeout:10000});

  window.addEventListener('deviceorientationabsolute', handleOrientation, true);
  window.addEventListener('deviceorientation', handleOrientation, true);
  startBtn.disabled = true;
}

startBtn.addEventListener('click', startCompass);
</script>
</body>
    </html>
