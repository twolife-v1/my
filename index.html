<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Waktu Solat — Unified</title>
  <meta name="theme-color" content="#F6EEE0">
  <style>
    :root{
      --bg:#F6EEE0; --card:#FFF; --muted:#6f604f; --accent:#A67734; --soft:#FFF6EE;
      --glass: rgba(255,255,255,0.28); --hero-height:360px;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans', Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#FFFDF8);color:#2e2a24;-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}

    /* HERO */
    .hero{position:relative;min-height:var(--hero-height);display:flex;align-items:center;justify-content:center;padding:18px;background-size:cover;background-position:center}
    .hero::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.12),rgba(0,0,0,0.02));z-index:0;border-bottom-left-radius:20px;border-bottom-right-radius:20px}
    .hero-card-bg{position:relative;z-index:2;width:100%;max-width:1100px;border-radius:16px;backdrop-filter: blur(10px);background:var(--glass);padding:16px;box-shadow:0 10px 30px rgba(16,12,8,0.08)}
    .hero-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .hero-left{display:flex;flex-direction:column;gap:6px}
    #locationName{font-weight:700;font-size:16px}
    #heroDate{font-size:13px;color:var(--muted)}
    .hero-right{text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    #heroTime{font-size:34px;font-weight:700;letter-spacing:0.6px}
    #countdown{font-size:20px;font-weight:600;color:rgba(255,255,255,0.95)}
    #heroPrayers{margin-top:12px}
    #prayerNames,#prayerTimes{display:flex;justify-content:space-between;align-items:center;width:100%;font-weight:700}
    #prayerNames div,#prayerTimes div{flex:1;text-align:center;font-size:14px;color:var(--muted)}
    #prayerTimes div{color:#2e2a24}

    /* NAV */
    .site-nav{position:sticky;top:0;background:var(--accent);z-index:120;padding:10px 0;box-shadow:0 3px 12px rgba(0,0,0,0.08)}
    .nav-list{list-style:none;margin:0;padding:0;display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap}
    .nav-list a{color:#fff;font-weight:700;padding:8px 14px;border-radius:8px;transition:transform .15s,background .15s}
    .nav-list a:hover{transform:translateY(-3px);background:rgba(255,255,255,0.12)}
    .nav-list a.active{background:#fff;color:var(--accent)}

    .container{max-width:1100px;margin:14px auto;padding:0 12px}

    main{padding:18px;max-width:1100px;margin:18px auto}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:14px}
    .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 6px 20px rgba(18,15,12,0.06)}
    .prayer-table table{width:50%;border-collapse:collapse;margin-top:8px}
    .prayer-table th,.prayer-table td{padding:10px 8px;text-align:left;border-bottom:1px solid #f3f3f3}
    .current-row{background:linear-gradient(90deg,rgba(166,119,52,0.06),rgba(255,255,255,0));}
    .btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;background:#A67734;color:white;font-weight:600}
    .btn.ghost{background:#fff;border:1px solid #A67734;color:#A67734}
    iframe.takwim-frame{width:100%;height:420px;border-radius:12px;border:0;background:#fff}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr 1fr} }
    @media (max-width:900px){ .grid{grid-template-columns:1fr} .hero{min-height:260px} #heroTime{font-size:28px} iframe.takwim-frame{height:520px} }
iframe.qiblat-frame {
  width: 180px;
  height: 180px;
  border-radius: 50%;
  border: 2px solid #A67734;
  display: block;
  overflow: hidden; /* hide scroll */
}
  </style>
</head>
<body>
  <!-- HERO -->
    <header class="hero" id="hero" role="banner" aria-label="Prayer hero">
    <div class="hero-card-bg" id="heroCard">
      <div class="hero-top">
        <div class="hero-left">
          <div id="locationName">—</div>
          <div id="heroDate">—</div>
        </div>

        <div class="hero-right">
          <div id="heroTime">--:--:--</div>
          <div id="countdown">—</div>
          <div id="nextPrayer">Next: —</div>
        </div>
      </div>

      <div style="height:1px;background:rgba(0,0,0,0.03);margin:10px 0;border-radius:2px" aria-hidden="true"></div>

      <div id="heroPrayers" aria-live="polite">
        <div id="prayerNames" aria-hidden="false"></div>
        <div id="prayerTimes" aria-hidden="false"></div>
      </div>
    </div>
  </header>

  <!-- NAV (sticky top on scroll) -->
  <nav class="site-nav" aria-label="Primary">
    <div class="nav-bar container" style="background:transparent;">
      <ul class="nav-list" role="menubar" aria-label="Main navigation">
        <li role="none"><a role="menuitem" href="#prayer" class="active">Prayer</a></li>
        <li role="none"><a role="menuitem" href="quran.html">Al Quran</a></li>
        <li role="none"><a role="menuitem" href="qibla.html">Qiblat</a></li>
        <li role="none"><a role="menuitem" href="#calendar">Takwim</a></li>
        <li role="none"><a role="menuitem" href="#hadith">Daily Hadis</a></li>
        <li role="none"><a role="menuitem" href="#about">About</a></li>
      </ul>
    </div>
  </nav>

  <main class="container">
    <div class="grid" id="mainGrid">
      <!-- LEFT BOX: Prayer Times -->
      <section>
        <div class="card prayer-table" id="prayer">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div>
              <strong id="locationNameSmall">Unknown</strong>
              <div style="color:var(--muted);font-size:13px">Prayer times today</div>
            </div>
            <div style="text-align:right">
              <div id="worldTime" style="font-weight:700"></div>
              <div style="color:var(--muted);font-size:12px">Local time</div>
            </div>
          </div>

          <div id="tableWrapper" style="margin-top:10px;">
            <table aria-label="Prayer times table">
              <thead><tr><th>Prayer</th><th>Time</th></tr></thead>
              <tbody id="prayerTableBody">
                <tr id="row-fajr"><td>Fajr</td><td id="pt-fajr">--:--</td></tr>
                <tr id="row-dhuhr"><td>Dhuhr</td><td id="pt-dhuhr">--:--</td></tr>
                <tr id="row-asr"><td>Asr</td><td id="pt-asr">--:--</td></tr>
                <tr id="row-maghrib"><td>Maghrib</td><td id="pt-maghrib">--:--</td></tr>
                <tr id="row-isha"><td>Isha</td><td id="pt-isha">--:--</td></tr>
              </tbody>
            </table>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn" id="toggle24">24h: On</button>
              <button class="btn ghost" id="setLocationBtn">Set Location</button>
            </div>
            <div style="color:var(--muted);font-size:13px">Next: <span id="nextPrayerLabel">—</span></div>
          </div>
        </div>

        <div class="card" id="hadith" style="margin-top:14px">
          <div style="display:flex;justify-content:space-between;align-items:center"><strong>Daily Hadith</strong><div style="color:var(--muted);font-size:13px">Quote image (offline friendly)</div></div>
          <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
            <canvas id="hadithCanvas" width="160" height="160" style="border-radius:8px;background:linear-gradient(180deg,#fff,#FFF6EE)"></canvas>
            <div><div id="hadithText" style="font-weight:600">Loading hadith…</div><div style="color:var(--muted);font-size:13px">Source: sample</div></div>
          </div>
        </div>
      </section>

      <!-- RIGHT BOX: Takwim (embedded file) -->
      <aside>
        <div class="card" id="takwimCard" style="display:flex;flex-direction:column;gap:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Takwim & Hijri</strong>
            <div style="font-size:13px;color:var(--muted)">7-day view • Full takwim below</div>
          </div>

          <!-- Embed Takwim-hijri.html as iframe (same folder). H1: auto height inside iframe -->
          <iframe id="takwimFrame" class="takwim-frame" src="takwim-hijri.html" title="Takwim Hijri (embedded)"></iframe>

          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn" id="openTakwimFull">Open Full</button>
          </div>
        </div>
<div class="card" style="margin-top:14px;">
  <!-- Responsive embedded Qibla iframe -->
  <div id="qiblaWrapper" style="margin-top:12px; display:flex; justify-content:center; overflow:hidden; width:100%; max-width:400px; cursor:pointer;">
    <iframe id="qiblatFrame"
            src="qiblat.html"
            style="width:100%; height:400px; border:none;"
            scrolling="no">
    </iframe>
  </div>

  <!-- Display Qibla bearing -->
  <div style="margin-top:8px;text-align:center;color:var(--muted)">
    <span id="qiblaDegDisplay">—°</span>
  </div>
</div>
</div>
</div>

      </aside>
    </div>
  </main>

  <footer style="text-align:center;padding:12px;color:var(--muted)">Built with care • Works offline-ish • Customize translations/data</footer>

  <!-- Adhan.js fallback (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/adhan@4.4.0/dist/Adhan.js"></script>

<script>
/***********************
 * App state + helpers
 ***********************/
const APP = {
  name: 'Waktu Solat',
  kaaba: { lat: 21.422487, lon: 39.826206 },
  use24: false,
  location: null
};

// LocalStorage helper
const storage = {
  get(k){ try { return JSON.parse(localStorage.getItem(k)) } catch(e){ return null } },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
};
  // Format time string
function formatTimeStr(str){
  if(!str) return '--:--';
  const [hh, mm] = str.split(':').map(n => parseInt(n,10));
  const now = new Date();
  now.setHours(hh, mm, 0, 0);
  return now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12: !APP.use24});
}

// Format date/time with seconds
function formatDateTime(dt){
  return dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:!APP.use24});
}

// Get user location (geolocation + fallback)
async function getLocation(){
  let loc = storage.get('loc') || APP.location;
  if(!loc && navigator.geolocation){
    try {
      const pos = await new Promise((res, rej) =>
        navigator.geolocation.getCurrentPosition(res, rej, { timeout:10000 })
      );
      loc = { lat: pos.coords.latitude, lon: pos.coords.longitude, name:'My Location' };
      storage.set('loc', loc);
    } catch(e){
      loc = { lat:3.1390, lon:101.6869, name:'Kuala Lumpur (fallback)' };
    }
  }
  APP.location = loc;
  return loc;
}

/***********************
 * Prayer Times
 ***********************/
async function getTimingsForDate(date, lat, lon){
  // Aladhan API
  try {
    const ts = Math.floor(date.getTime()/1000);
    const url = `https://api.aladhan.com/v1/timings/${ts}?latitude=${lat}&longitude=${lon}&method=2`;
    const res = await fetch(url);
    if(res.ok){
      const json = await res.json();
      return json.data.timings;
    }
  } catch(e){ console.warn('Aladhan API failed', e); }

  // Fallback with adhan.js
  try {
    const coords = new adhan.Coordinates(lat, lon);
    const params = adhan.CalculationMethod.MuslimWorldLeague();
    params.madhab = adhan.Madhab.Shafi;
    params.adjustments = { fajr:2, dhuhr:1, asr:1, maghrib:2, isha:2 };
    const times = new adhan.PrayerTimes(coords, date, params);
    return {
      Fajr: times.fajr.toTimeString().slice(0,5),
      Sunrise: times.sunrise.toTimeString().slice(0,5),
      Dhuhr: times.dhuhr.toTimeString().slice(0,5),
      Asr: times.asr.toTimeString().slice(0,5),
      Maghrib: times.maghrib.toTimeString().slice(0,5),
      Isha: times.isha.toTimeString().slice(0,5)
    };
  } catch(e){ console.warn('Adhan compute failed', e); }
  return null;
}

function showPrayerTimesObj(t){
  if(!t) return;
  const map = {Fajr:'fajr', Dhuhr:'dhuhr', Asr:'asr', Maghrib:'maghrib', Isha:'isha'};
  Object.keys(map).forEach(k=>{
    const el = document.getElementById('pt-'+map[k]);
    if(el) el.textContent = formatTimeStr(t[k] || t[k.charAt(0).toUpperCase()+k.slice(1)]);
  });
}

/***********************
 * Hero section
 ***********************/
let heroInterval = null;

function renderHeroPrayers(timings){
  const prayerOrder = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];
  const namesDiv = document.getElementById('prayerNames');
  const timesDiv = document.getElementById('prayerTimes');
  namesDiv.innerHTML = '';
  timesDiv.innerHTML = '';
  prayerOrder.forEach(p => {
    const nameEl = document.createElement('div'); nameEl.textContent = p; namesDiv.appendChild(nameEl);
    const timeEl = document.createElement('div'); timeEl.textContent = formatTimeStr(timings[p]); timesDiv.appendChild(timeEl);
  });
}

function updateHeroTiming(timings){
  if(heroInterval) clearInterval(heroInterval);

  heroInterval = setInterval(()=>{
    const now = new Date();
    let nextPrayer = '';
    let countdownStr = '--:--:--';

    for(const p of ['Fajr','Dhuhr','Asr','Maghrib','Isha']){
      const tParts = timings[p].split(':');
      const tDate = new Date();
      tDate.setHours(parseInt(tParts[0]), parseInt(tParts[1]),0,0);

      if(tDate > now){
        nextPrayer = p;
        const diffMs = tDate - now;

        const hours = Math.floor(diffMs / 1000 / 60 / 60);
        const minutes = Math.floor((diffMs / 1000 / 60) % 60);
        const seconds = Math.floor((diffMs / 1000) % 60);

        countdownStr = `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
        break;
      }
    }

    document.getElementById('nextPrayer').textContent = 'Next: ' + nextPrayer;
    document.getElementById('countdown').textContent = countdownStr;
    document.getElementById('heroTime').textContent = formatDateTime(new Date());
  },1000);
}

/***********************
 * Takwim / Qibla
 ***********************/
function sendLocationToTakwim(loc, timings){
  const f = document.getElementById('takwimFrame');
  f.contentWindow && f.contentWindow.postMessage({type:'app.location.update', detail:{ loc, timings }}, '*');
}

function calcQibla(lat, lon){
  // simple bearing formula
  const toRad = Math.PI/180;
  const toDeg = 180/Math.PI;
  const lat1 = lat*toRad;
  const lon1 = lon*toRad;
  const lat2 = APP.kaaba.lat*toRad;
  const lon2 = APP.kaaba.lon*toRad;
  const y = Math.sin(lon2-lon1)*Math.cos(lat2);
  const x = Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(lon2-lon1);
  return (Math.atan2(y,x)*toDeg+360)%360;
}

function setQiblaNeedle(deg){
  const qEl = document.getElementById('qiblaDegDisplay');
  if(qEl) qEl.textContent = `${Math.round(deg)}°`;
  // optionally send to iframe
  const f = document.getElementById('qiblatFrame');
  f.contentWindow && f.contentWindow.postMessage({type:'app.location.update', detail:APP.location},'*');
}

/***********************
 * Hadith canvas
 ***********************/
function drawHadith(text){
  const canvas = document.getElementById('hadithCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#2e2a24'; ctx.font='14px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
  const words = text.split(' '); let line=''; let lines=[]; 
  words.forEach(w=>{
    const testLine = line+' '+w;
    const metrics = ctx.measureText(testLine);
    if(metrics.width>canvas.width-10){ lines.push(line); line=w; } else { line=testLine; }
  });
  lines.push(line);
  const startY = canvas.height/2 - (lines.length-1)*10;
  lines.forEach((l,i)=>ctx.fillText(l.trim(), canvas.width/2, startY+i*20));
}

/***********************
 * Main
 ***********************/
async function runAll(){
  try{
    const now = new Date();
    document.getElementById('heroDate').textContent = now.toDateString();
    document.getElementById('worldTime').textContent = formatDateTime(now);

    const loc = await getLocation();
    document.getElementById('locationName').textContent = loc.name;
    document.getElementById('locationNameSmall').textContent = loc.name;

    const timings = await getTimingsForDate(now, loc.lat, loc.lon) || {
      Fajr:'05:45', Dhuhr:'13:00', Asr:'16:30', Maghrib:'19:00', Isha:'20:15'
    };

    renderHeroPrayers(timings);
    showPrayerTimesObj(timings);
    updateHeroTiming(timings);

    sendLocationToTakwim(loc, timings);
    setQiblaNeedle(calcQibla(loc.lat, loc.lon));

    document.getElementById('hadithText').textContent='“The best among you are those who have the best manners and character.”';
    drawHadith(document.getElementById('hadithText').textContent);

  } catch(e){ console.warn('runAll error', e); }
}

/***********************
 * Events
 ***********************/
window.addEventListener('message', (ev)=>{
  const m = ev.data;
  if(!m || !m.type) return;
  if(m.type==='takwim.request.location'){
    if(APP.location) sendLocationToTakwim(APP.location,null);
  }
});

document.getElementById('toggle24')?.addEventListener('click', ()=>{
  APP.use24 = !APP.use24;
  document.getElementById('toggle24').textContent = '24h: ' + (APP.use24 ? 'On' : 'Off');
  runAll();
});

document.getElementById('setLocationBtn')?.addEventListener('click', async ()=>{
  const lat = prompt('Enter latitude:', APP.location?.lat || 3.1390);
  const lon = prompt('Enter longitude:', APP.location?.lon || 101.6869);
  const name = prompt('Enter location name:', APP.location?.name || 'Custom');
  if(lat && lon){
    APP.location={lat:parseFloat(lat),lon:parseFloat(lon),name:name}; storage.set('loc', APP.location); runAll();
  }
});

document.getElementById('openTakwimFull')?.addEventListener('click', ()=>{
  window.open('takwim-hijri.html','_blank');
});

/***********************
 * Run on load
 ***********************/
window.addEventListener('DOMContentLoaded', async ()=>{
  await runAll();
  setInterval(()=>{
    document.getElementById('heroTime').textContent=formatDateTime(new Date());
  },1000);
});
</script>
  <script>
const qiblaWrapper = document.getElementById('qiblaWrapper');
const qiblaIframe = document.getElementById('qiblatFrame');

// Click on iframe area triggers recalibration
qiblaWrapper.addEventListener('click', () => {
  qiblaIframe.contentWindow.postMessage({ type: 'recalibrate' }, '*');
});

// Listen for updated bearing from iframe
window.addEventListener('message', (event) => {
  const data = event.data;
  if (!data) return;

  if (data.type === 'qibla.update') {
    document.getElementById('qiblaDegDisplay').textContent = `${data.bearing.toFixed(0)}°`;
  }
});
</script>
<script>
const qiblaWrapper = document.getElementById('qiblaWrapper');
const qiblaIframe = document.getElementById('qiblatFrame');

// Click on iframe area triggers recalibration in qiblat.html
qiblaWrapper.addEventListener('click', () => {
  if(qiblaIframe.contentWindow) {
    qiblaIframe.contentWindow.postMessage({ type: 'recalibrate' }, '*');
  }
});

// Listen for updated bearing from iframe
window.addEventListener('message', (event) => {
  const data = event.data;
  if (!data) return;

  if (data.type === 'qibla.update') {
    document.getElementById('qiblaDegDisplay').textContent = `${data.bearing.toFixed(0)}°`;
  }
});
</script>
</body>
</html>
