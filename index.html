<!doctype html>
<html lang="en">
<head>
  <link rel="apple-touch-icon" href="/Images/icon-512.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#d2b48c">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Waktu Solat — Unified</title>
  <style>
    :root{
      --bg:#F6EEE0; --card:#FFF; --muted:#6f604f; --accent:#A67734; --soft:#FFF6EE;
      --glass: rgba(255,255,255,0.28); --hero-height:360px;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans', Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#FFFDF8);color:#2e2a24;-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}

    /* HERO */
    .hero {
      position: relative;
      min-height: var(--hero-height);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background-size: cover;
      background-position: center;
      transition: background 1s ease;
      background-repeat: no-repeat;
    }
    .hero::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.12),rgba(0,0,0,0.02));z-index:0;border-bottom-left-radius:20px;border-bottom-right-radius:20px}
    .hero-card-bg{position:relative;z-index:2;width:100%;max-width:1100px;border-radius:16px;backdrop-filter: blur(10px);background:var(--glass);padding:16px;box-shadow:0 10px 30px rgba(16,12,8,0.0.5)}
    .hero-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .hero-left{display:flex;flex-direction:column;gap:6px}
    #locationName{font-weight:700;font-size:16px}
    #heroDate{font-size:13px;color:var(--muted)}
    .hero-right{text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    #heroTime{font-size:34px;font-weight:700;letter-spacing:0.6px}
    #countdown{font-size:20px;font-weight:600;color:var(--muted)}
    #nextPrayer{font-size:16px;font-weight:600}
    #heroPrayers{margin-top:12px}
    #prayerNames,#prayerTimes{display:flex;justify-content:space-between;align-items:center;width:100%;font-weight:700}
    /* FIX: Removed flex:1 here to allow better spacing for 6 columns */
    #prayerNames div,#prayerTimes div{text-align:center;font-size:14px;color:var(--muted)}
    #prayerTimes div{color:#2e2a24}

    /* NAV */
    .site-nav{position:sticky;top:0;background:var(--accent);z-index:120;padding:10px 0;box-shadow:0 3px 12px rgba(0,0,0,0.08)}
    .nav-list{list-style:none;margin:0;padding:0;display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap}
    .nav-list a{color:#fff;font-weight:700;padding:8px 14px;border-radius:8px;transition:transform .15s,background .15s}
    .nav-list a:hover{transform:translateY(-3px);background:rgba(255,255,255,0.12)}
    .nav-list a.active{background:#fff;color:var(--accent)}

    .container{max-width:1100px;margin:14px auto;padding:0 12px}

    /* MODIFIED: Added centering for the main grid */
    main{padding:18px;max-width:1100px;margin:18px auto; display:flex; justify-content:center;}
    
    /* MODIFIED: Changed 420px to 1fr for responsive width */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px; width:100%;}
    .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 6px 20px rgba(18,15,12,0.06)}
    .prayer-table table{width:100%;border-collapse:collapse;margin-top:8px}
    .prayer-table th,.prayer-table td{padding:10px 8px;text-align:left;border-bottom:1px solid #f3f3f3}
    .current-row{background:linear-gradient(90deg,rgba(166,119,52,0.06),rgba(255,255,255,0));}
    .btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;background:#A67734;color:white;font-weight:600}
    .btn.ghost{background:#fff;border:1px solid #A67734;color:#A67734}
    iframe.takwim-frame{width:100%;height:420px;border-radius:12px;border:0;background:#fff}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr 1fr} }
    @media (max-width:900px){ .grid{grid-template-columns:1fr} .hero{min-height:260px} #heroTime{font-size:28px} iframe.takwim-frame{height:520px} }

    iframe.qiblat-frame { width: 180px; height: 180px; border-radius:50%; border:2px solid #A67734; display:block; overflow:hidden; }
    
    /* NEW ADDITION: Prevents any horizontal scrolling/movability on the Takwim card */
    #takwimCard {
      overflow-x: hidden;
    }
  </style>
</head>
<body>

<header class="hero" id="hero" role="banner" aria-label="Prayer hero">
  <div class="hero-card-bg" id="heroCard">
    <div class="hero-top">
      <div class="hero-left">
        <div id="locationName">—</div>
        <div id="heroDate">—</div>
      </div>

      <div class="hero-right">
        <div id="heroTime">--:--:--</div>
        <div id="countdown">—</div>
        <div id="nextPrayer">Next: —</div>
      </div>
    </div>

    <div style="height:1px;background:rgba(0,0,0,0.03);margin:10px 0;border-radius:2px" aria-hidden="true"></div>

    <div id="heroPrayers" aria-live="polite">
      <div id="prayerNames" aria-hidden="false"></div>
      <div id="prayerTimes" aria-hidden="false"></div>
    </div>
  </div>
</header>

<nav class="site-nav" aria-label="Primary">
  <div class="nav-bar container" style="background:transparent;">
    <ul class="nav-list" role="menubar" aria-label="Main navigation">
      <li role="none"><a role="menuitem" href="#prayer" class="active">Prayer</a></li>
      <li role="none"><a role="menuitem" href="quran.html">Al Quran</a></li>
      <li role="none"><a role="menuitem" href="#qiblaWrapper">Qiblat</a></li>
      <li role="none"><a role="menuitem" href="#takwimFrame">Takwim</a></li>
      <li role="none"><a role="menuitem" href="#hadith">Daily Hadith</a></li>
      <li role="none"><a role="menuitem" href="#about">About</a></li>
    </ul>
  </div>
</nav>

<main class="container">
  <div class="grid" id="mainGrid">
    <section>
      <div class="card prayer-table" id="prayer">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <div>
            <strong id="locationNameSmall">—</strong>
            <div style="color:var(--muted);font-size:13px">Prayer times today</div>
          </div>
          <div style="text-align:right">
            <div id="worldTime" style="font-weight:700">--:--:--</div>
            <div style="color:var(--muted);font-size:12px">Local time</div>
          </div>
        </div>

        <div id="tableWrapper" style="margin-top:10px;">
          <table aria-label="Prayer times table">
            <thead><tr><th>Prayer</th><th>Time</th></tr></thead>
            <tbody id="prayerTableBody">
              <tr id="row-imsak"><td>Imsak</td><td id="pt-imsak">--:--</td></tr>
              <tr id="row-fajr"><td>Subuh</td><td id="pt-fajr">--:--</td></tr>
              <tr id="row-dhuhr"><td>Zohor</td><td id="pt-dhuhr">--:--</td></tr>
              <tr id="row-asr"><td>Asar</td><td id="pt-asr">--:--</td></tr>
              <tr id="row-maghrib"><td>Maghrib</td><td id="pt-maghrib">--:--</td></tr>
              <tr id="row-isha"><td>Ishaa</td><td id="pt-isha">--:--</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="card" id="hadith" style="margin-top:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Daily Hadith</strong>
          <div style="color:var(--muted);font-size:13px">Quote image (offline friendly)</div>
        </div>
        <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
          <canvas id="hadithCanvas" width="160" height="160" style="border-radius:8px;background:linear-gradient(180deg,#fff,#FFF6EE)"></canvas>
          <div>
            <div id="hadithText" style="font-weight:600">Loading hadith…</div>
            <div style="color:var(--muted);font-size:13px">Source: sample</div>
          </div>
        </div>
      </div>
    </section>

    <aside style="display:contents;">
      <div class="card" style="margin-top:0; height:400px; display:flex; flex-direction:column; gap:8px;">
        <div id="qiblaWrapper" style="flex:1; width:100%; display:flex; justify-content:center; align-items:center; overflow:hidden;">
          <iframe id="qiblatFrame" src="qiblat.html"
                  style="width:100%; height:100%; border:none; border-radius:0; display:block;"></iframe>
        </div>
        <div style="text-align:center; color:var(--muted); font-size:14px;">
          <span id="qiblaDegDisplay">—°</span>
        </div>
      </div>

      <div class="card" id="takwimCard" style="margin-top:14px; display:flex; flex-direction:column; gap:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Takwim & Hijri</strong>
          <div style="font-size:13px;color:var(--muted)">7-day view • Full takwim below</div>
        </div>
        <iframe id="takwimFrame" class="takwim-frame" src="Takwim-hijri.html"
                style="width:100%; height:450px; max-width:100%; border-radius:12px; border:0;"></iframe>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" id="openTakwimFull">Open Full</button>
        </div>
      </div>
    </aside>
  </div>
</main>

<footer style="text-align:center;padding:12px;color:var(--muted)">
  Built with care • Works offline-ish • Customize translations/data
</footer>
  <script>
const APP = { location: null, use24:false, kaaba:{lat:21.422487, lon:39.826206} };
const storage = { get(k){try{return JSON.parse(localStorage.getItem(k))}catch(e){return null}}, set(k,v){localStorage.setItem(k,JSON.stringify(v))} };

// Default times for fallback (Imsak added here: 10 mins before Fajr)
const DEFAULT_TIMINGS = {Imsak:'05:35', Fajr:'05:45',Dhuhr:'13:00',Asr:'16:30',Maghrib:'19:00',Isha:'20:15'};

// --- NOTIFICATION & SOUND FUNCTIONS ---
let sentNotifications = new Set(); 

async function requestNotificationPermission() {
    if ('Notification' in window) {
        if (Notification.permission === 'default') {
            await Notification.requestPermission();
        }
    } else {
        console.warn("Notifications not supported in this browser.");
    }
}

function showPrayerNotification(prayerName) {
    if (Notification.permission === 'granted' && !sentNotifications.has(prayerName)) {
        
        // 1. Display the standard browser notification (Customized text)
        new Notification(`Allahu Akbar!`, { 
            body: `Waktunya solat ${prayerName} telah tiba.`, 
            icon: '/Images/icon-512.png',
            vibrate: [200, 100, 200]
        });
        
        // 2. Play a custom sound using the HTML Audio API
        try {
            // !!! IMPORTANT: CHANGE '/audio/azan.mp3' to your actual file path !!!
            const audio = new Audio('Images/noti.mp3'); 
            audio.volume = 0.8; 
            audio.play().catch(error => {
                console.warn("Audio playback failed (browser may require user interaction first):", error);
            });
        } catch (e) {
            console.error("Error initializing audio:", e);
        }

        // 3. Mark the notification as sent for today
        sentNotifications.add(prayerName);
    }
}

function resetDailySentNotifications() {
    const today = new Date().toDateString();
    const lastReset = storage.get('lastNotificationReset');
    if (lastReset !== today) {
        sentNotifications.clear();
        storage.set('lastNotificationReset', today);
    }
}
// ------------------------------------

// --- UTILITY FUNCTIONS ---

// Function to adjust HH:MM time string by N minutes (for +1 minute adjustment)
function adjustTime(timeStr, minutes) {
  if (!timeStr || timeStr === '--:--') return timeStr;
  const [h, m] = timeStr.split(':').map(Number);
  const date = new Date();
  date.setHours(h, m, 0, 0); 
  date.setMinutes(date.getMinutes() + minutes);
  const newH = date.getHours().toString().padStart(2, '0');
  const newM = date.getMinutes().toString().padStart(2, '0');
  return `${newH}:${newM}`;
}

// Placeholder for Reverse Geocoding
async function reverseGeocode(lat, lon) {
  console.log(`Attempting reverse geocoding for: ${lat}, ${lon}`);
  return "Current GPS Location"; 
}

// Format time
function formatTime(t){
  if(!t) return '--:--';
  const [h,m]=t.split(':').map(n=>parseInt(n));
  const dt=new Date(); dt.setHours(h,m,0,0);
  return dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:!APP.use24});
}

// Get user location (with improved name handling)
async function getLocation(){
  let loc=storage.get('loc') || APP.location;
  if(loc?.lat && loc?.lon && loc?.name) { 
      APP.location=loc; 
      return loc; 
  }
  
  if(navigator.geolocation){
    try{
      const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:12000,enableHighAccuracy:true}));
      const name = await reverseGeocode(pos.coords.latitude, pos.coords.longitude);
      loc = { lat: pos.coords.latitude, lon: pos.coords.longitude, name };
      
      APP.location = loc;
      storage.set('loc', loc);
      return loc;
      
    }catch(e){
        console.warn('Geolocation error (user denied or timeout):', e);
    }
  }
  // Fallback location if Geolocation fails or is unsupported
  const fallbackLoc = { lat: 3.1390, lon: 101.6869, name: 'Kuala Lumpur (Default)' };
  APP.location = fallbackLoc;
  return fallbackLoc;
}

// Fetch accurate prayer times (Prioritizes online, falls back to cached/default)
async function fetchOnlinePrayerTimes(lat, lon) {
  try {
    const ts = Math.floor(Date.now() / 1000);
    // METHOD 11 (Singapore) used for JAKIM accuracy
    const res = await fetch(`https://api.aladhan.com/v1/timings/${ts}?latitude=${lat}&longitude=${lon}&method=11`);
    const data = await res.json();
    const timings = { 
        Imsak: data.data.timings.Imsak, Fajr: data.data.timings.Fajr, Dhuhr: data.data.timings.Dhuhr, 
        Asr: data.data.timings.Asr, Maghrib: data.data.timings.Maghrib, Isha: data.data.timings.Isha
    };
    
    // Apply +1 minute adjustment before caching
    const adjustedTimings = {};
    for (const key in timings) {
        adjustedTimings[key] = adjustTime(timings[key], 1); 
    }
    
    localStorage.setItem('lastPrayerTimes', JSON.stringify(adjustedTimings));
    return adjustedTimings;
  } catch(e) {
    console.warn("API Error: Unable to fetch fresh data.");
    return null; // Return null on failure
  }
}

// --- UI Rendering Functions ---

// Mapping for display names
const prayerDisplayMap = {
    'Imsak': 'Imsak',
    'Fajr': 'Subuh',
    'Dhuhr': 'Zohor',
    'Asr': 'Asar',
    'Maghrib': 'Maghrib',
    'Isha': 'Ishaa'
};

// Update hero prayers (5 stacked + Imsak)
function renderHeroPrayers(timings){
  // Use API keys for iteration, but display the local names
  const order=['Imsak','Fajr','Dhuhr','Asr','Maghrib','Isha'];
  const namesDiv=document.getElementById('prayerNames');
  const timesDiv=document.getElementById('prayerTimes');
  namesDiv.innerHTML=''; timesDiv.innerHTML='';
  order.forEach(key=>{
    const nameEl=document.createElement('div'); 
    nameEl.textContent=prayerDisplayMap[key]; // Use the converted name
    namesDiv.appendChild(nameEl);
    const timeEl=document.createElement('div'); 
    timeEl.textContent=formatTime(timings[key]); 
    timesDiv.appendChild(timeEl);
  });
}

// Update the detailed prayer table (HTML rows already updated)
function renderPrayerTable(timings) {
  // Use API keys for accessing data from the `timings` object
  for(const key of ['Imsak', 'Fajr','Dhuhr','Asr','Maghrib','Isha']){
    const id = key.toLowerCase(); // IDs match the original keys (imsak, fajr, dhuhr, etc.)
    const timeElement = document.getElementById('pt-'+id);
    if(timeElement) {
        timeElement.textContent = formatTime(timings[key] || '--:--'); 
    }
  }
}

// Next prayer logic
function getNextPrayer(timings){
  const now=new Date();
  // Use API keys for logic
  const prayerKeys = ['Imsak', 'Fajr','Dhuhr','Asr','Maghrib','Isha'];
  for(const key of prayerKeys){
    const timeValue = timings[key];
    if (!timeValue) continue;

    const [h,m]=timeValue.split(':').map(n=>parseInt(n));
    const dt=new Date(); dt.setHours(h,m,0,0);
    if(dt>now) return prayerDisplayMap[key]; // Return the DISPLAY name
  }
  return prayerDisplayMap['Imsak']; // Loop back to Imsak (display name)
}

// Hero countdown, clock, and Notification check
let heroInterval=null;
function updateHero(timings){
  if(heroInterval) clearInterval(heroInterval);
  resetDailySentNotifications(); // Check and reset daily tracking
  
  // Initial time update
  document.getElementById('heroTime').textContent=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:!APP.use24});

  // Get all today's prayer times as Date objects for precise checking
  const todayPrayers = {};
  const prayerKeys = ['Imsak', 'Fajr','Dhuhr','Asr','Maghrib','Isha'];
  
  prayerKeys.forEach(key => {
    const timeValue = timings[key];
    if (!timeValue) return;
    const [h,m]=timeValue.split(':').map(n=>parseInt(n));
    const dt=new Date(); 
    dt.setHours(h,m,0,0);
    todayPrayers[key] = dt;
  });

  heroInterval=setInterval(()=>{
    const now = new Date();
    
    // Check for Prayer Time for Notification
    for (const key of prayerKeys) {
        const prayerDate = todayPrayers[key];
        const displayName = prayerDisplayMap[key];
        
        // Check if current time is within 1 second of the prayer time
        if (prayerDate && Math.abs(now - prayerDate) < 1000) {
            // Check if notification hasn't been sent yet for this prayer today
            if (!sentNotifications.has(displayName)) {
                showPrayerNotification(displayName);
            }
        }
    }
    
    // Countdown Logic
    const nextDisplayName = getNextPrayer(timings);
    let nextKey = Object.keys(prayerDisplayMap).find(key => prayerDisplayMap[key] === nextDisplayName) || 'Fajr';
    
    const [h,m]=timings[nextKey].split(':').map(n=>parseInt(n));
    let t=new Date(); t.setHours(h,m,0,0);
    
    if((nextKey==='Imsak' || nextKey==='Fajr') && t<=new Date()) t.setDate(t.getDate()+1);
    
    const diff=t-new Date();
    const hours=Math.floor(diff/1000/3600);
    const minutes=Math.floor((diff/1000/60)%60);
    const seconds=Math.floor((diff/1000)%60);
    
    document.getElementById('nextPrayer').textContent='Next: '+nextDisplayName; 
    document.getElementById('countdown').textContent=`${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
    document.getElementById('heroTime').textContent=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:!APP.use24});
  },1000);
}

// Hero background changer 
function updateHeroBackground(timings) {
  const hero = document.getElementById("hero");
  // UPDATED IMAGE NAMES
  const bgImages = {
    Fajr: "Images/subuh.jpg", Dhuhr: "Images/zohor.jpg", Asr: "Images/asar.jpg", 
    Maghrib: "Images/maghrib.jpg", Isha: "Images/isyak.jpg"
  };

  function getCurrentPrayerPeriod() {
    const now = new Date();
    const timeToDate = (time) => {
      const [h, m] = time.split(":").map(Number);
      const d = new Date();
      d.setHours(h, m, 0, 0);
      return d;
    };

    // Use API keys for comparison
    const order = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];
    let current = "Isha"; 

    for (let i = 0; i < order.length; i++) {
      const prayerKey = order[i];
      const prayerTime = timeToDate(timings[prayerKey]);
      const before30min = new Date(prayerTime.getTime() - 30 * 60 * 1000);

      if (now >= before30min && now < prayerTime) {
        return prayerKey; // Return the key (Fajr, Dhuhr...) to map to image
      }
      if (now >= prayerTime && i < order.length - 1) {
        current = order[i + 1];
      }
    }
    return current;
  }

  function refreshHeroBackground() {
    const currentPrayerKey = getCurrentPrayerPeriod();
    const bg = bgImages[currentPrayerKey];
    hero.style.backgroundImage = `url('${bg}')`;
  }

  refreshHeroBackground();
  setInterval(refreshHeroBackground, 60 * 1000);
}

// --- Main Execution ---

async function runAll(){
  // Request Notification permission on load
  await requestNotificationPermission(); 
  
  // 1. Get Location (uses fallback if needed)
  const loc=await getLocation();
  document.getElementById('locationName').textContent=loc.name;
  document.getElementById('locationNameSmall').textContent=loc.name;
  document.getElementById('heroDate').textContent=new Date().toDateString();
  document.getElementById('worldTime').textContent=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:!APP.use24});
  
  // 2. Load cached/default timings IMMEDIATELY (robust fix)
  let timings = JSON.parse(localStorage.getItem('lastPrayerTimes')) || DEFAULT_TIMINGS;
  
  // Apply +1 minute adjustment for cached/default data
  const initialTimings = {};
  for (const key in timings) {
      initialTimings[key] = adjustTime(timings[key], 1); 
  }
  timings = initialTimings;
  
  // 3. Update UI with the initial data (using adjusted cached/default times)
  renderHeroPrayers(timings);
  renderPrayerTable(timings);
  updateHero(timings);
  updateHeroBackground(timings);
  
  // 4. ASYNCHRONOUSLY fetch fresh data
  const freshTimings = await fetchOnlinePrayerTimes(loc.lat, loc.lon);

  if (freshTimings) {
    // If fresh data is available (already adjusted by +1 min), update the UI again
    timings = freshTimings;
    renderHeroPrayers(timings);
    renderPrayerTable(timings);
    updateHero(timings);
    updateHeroBackground(timings);
  }
  
  // Qibla calculation 
  const deg=Math.atan2(Math.sin(APP.kaaba.lon*Math.PI/180-loc.lon*Math.PI/180)*Math.cos(APP.kaaba.lat*Math.PI/180),
    Math.cos(loc.lat*Math.PI/180)*Math.sin(APP.kaaba.lat*Math.PI/180)-Math.sin(loc.lat*Math.PI/180)*Math.cos(APP.kaaba.lat*Math.PI/180)*Math.cos(APP.kaaba.lon*Math.PI/180-loc.lon*Math.PI/180)
  )*180/Math.PI;
  document.getElementById('qiblaDegDisplay').textContent=Math.round((deg+360)%360)+'°';
}

// --- Event Handlers ---

document.getElementById('toggle24')?.addEventListener('click',()=>{
  APP.use24=!APP.use24;
  document.getElementById('toggle24').textContent='24h: '+(APP.use24?'On':'Off');
  runAll();
});
document.getElementById('setLocationBtn')?.addEventListener('click',async ()=>{
  const lat=prompt('Enter latitude:',APP.location?.lat||3.1390);
  const lon=prompt('Enter longitude:',APP.location?.lon||101.6869);
  const name=prompt('Enter location name:','My Location');
  if(lat && lon){APP.location={lat:parseFloat(lat),lon:parseFloat(lon),name:name||'My Location'};storage.set('loc',APP.location);await runAll();}
});
document.getElementById('openTakwimFull')?.addEventListener('click',()=>window.open('Takwim-hijri.html','_blank'));

// Run on load
window.addEventListener('DOMContentLoaded',runAll);
</script>
</body>
</html>
