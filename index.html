<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#A67734">
    <title>Mukmin.com</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root[data-theme="light"] { --primary:#A67734; --primary-light:#FDF8F0; --bg:#F8F9FA; --surface:#FFFFFF; --text:#1F2937; --text-muted:#6B7280; --border:#E5E7EB; --glass: rgba(255, 255, 255, 0.15); --glass-border: rgba(255, 255, 255, 0.2); --glass-text: #FFFFFF; --header-scrolled: rgba(255, 255, 255, 0.85); --header-text-scrolled: #1F2937; --shadow:0 10px 30px -10px rgba(0,0,0,0.1); }
        :root[data-theme="dark"] { --primary:#D4AF37; --primary-light:#2A2012; --bg:#121212; --surface:#1E1E1E; --text:#F3F4F6; --text-muted:#9CA3AF; --border:#374151; --glass: rgba(0, 0, 0, 0.4); --glass-border: rgba(255, 255, 255, 0.1); --glass-text: #FFFFFF; --header-scrolled: rgba(30, 30, 30, 0.85); --header-text-scrolled: #F3F4F6; --shadow:0 10px 30px -10px rgba(0,0,0,0.5); }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { min-height: 100%; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 100px; transition: background 0.3s; }

        /* HEADER */
        .header-overlay { position: fixed; top: 0; left: 0; right: 0; z-index: 100; padding: 10px 20px; padding-top: max(10px, env(safe-area-inset-top)); display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; }
        .header-overlay.scrolled { background: var(--header-scrolled); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding-bottom: 15px; }
        .header-overlay.scrolled .header-greeting { color: var(--text-muted); text-shadow: none; }
        .header-overlay.scrolled .header-title-overlay { color: var(--header-text-scrolled); text-shadow: none; }
        .header-overlay.scrolled .icon-btn-glass { background: var(--bg); color: var(--text); border-color: var(--border); }
        .header-greeting { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 1px 3px rgba(0,0,0,0.5); transition: color 0.3s; }
        .header-title-overlay { font-size: 20px; font-weight: 800; color: white; margin: 0; text-shadow: 0 1px 3px rgba(0,0,0,0.5); transition: color 0.3s; }
        .icon-btn-glass { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; backdrop-filter: blur(4px); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.3s; font-size: 12px; }

        /* HERO & GRADIENTS */
        .hero-wrapper { position: relative; width: 100%; min-height: 350px; overflow: hidden; border-bottom-left-radius: 32px; border-bottom-right-radius: 32px; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.3); margin-bottom: 25px; }
        .hero { position: absolute; inset: 0; transition: background 1s ease-in-out; display: flex; align-items: flex-end; justify-content: center; padding: 20px; padding-bottom: 30px; }
        .hero { background: linear-gradient(135deg, #0f172a 0%, #312e81 100%); }
        .bg-fajr { background: linear-gradient(135deg, #4c1d95 0%, #c2410c 100%) !important; }
        .bg-dhuhr { background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%) !important; }
        .bg-asr { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important; }
        .bg-maghrib { background: linear-gradient(135deg, #be185d 0%, #7c3aed 100%) !important; }
        
        .hero-card-bg { position: relative; z-index: 2; width: 100%; max-width: 500px; background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 24px; padding: 20px; color: #fff; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); }
        .hero-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        
        #heroTime { font-size: 34px; font-weight: 800; line-height: 1; letter-spacing: -1px; }
        #countdown { font-size: 14px; font-weight: 600; opacity: 0.9; font-variant-numeric: tabular-nums; }
        #locationName { font-size: 14px; font-weight: 700; margin-bottom: 4px;}
        .hero-date-group { display: flex; flex-direction: column; gap: 2px; }
        
        .hero-divider { height: 1px; background: rgba(255,255,255,0.2); margin: 15px 0; }
        #prayerNames, #prayerTimes { display: flex; justify-content: space-between; width: 100%; }
        #prayerNames div { font-size: 10px; opacity: 0.7; text-transform: uppercase; text-align: center; width: 16%; font-weight: 800; }
        #prayerTimes div { font-size: 13px; font-weight: 700; text-align: center; width: 16%; margin-top: 5px; }

        /* FEATURES GRID */
        #app-container { padding: 0 20px; }
        .section-header { font-size: 13px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; margin-top: 25px; display: flex; align-items: center; gap: 8px; }
        .section-header:first-of-type { margin-top: 0; }
        .feature-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .feature-btn { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 18px 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; cursor: pointer; box-shadow: var(--shadow); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .feature-btn:active { transform: scale(0.96); background: var(--primary-light); }
        .feature-btn svg { width: 28px; height: 28px; color: var(--primary); }
        .feature-btn i { font-size: 28px; color: var(--primary); }
        .feature-btn span { font-size: 12px; font-weight: 700; color: var(--text); text-align: center; line-height: 1.2; }

        /* SIDE PANEL */
        #sidePanelOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 290; opacity: 0; pointer-events: none; transition: 0.3s; }
        #sidePanelOverlay.open { opacity: 1; pointer-events: auto; }
        #sidePanel { position: fixed; top: 0; right: 0; bottom: 0; width: 85%; max-width: 380px; background: var(--bg); z-index: 300; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; padding-top: env(safe-area-inset-top); }
        #sidePanel.open { transform: translateX(0); }
        .panel-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--surface); }
        .panel-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* QURAN & MODALS */
        .card { background: var(--surface); border-radius: 20px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .view { display: none; animation: fadeIn 0.4s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #readerModal, #qiblaModal { position: fixed; inset: 0; background: var(--bg); z-index: 500; display: none; flex-direction: column; padding-top: env(safe-area-inset-top); }
        #readerModal.open, #qiblaModal.active { display: flex; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { padding: 15px 20px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        /* Quran Text Styles */
        .ayah-block { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px dashed var(--border); transition: all 0.4s ease; border-left: 0 solid var(--primary); }
        .ayah-block.playing { background: var(--primary-light); border-left: 5px solid var(--primary); padding-left: 15px; box-shadow: inset 0 0 20px rgba(166, 119, 52, 0.05); }
        .ayah-tools { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .ayah-arabic { font-family: 'Amiri', serif; font-size: 26px; text-align: right; margin-bottom: 10px; line-height: 2.2; }
        .ayah-trans { font-size: 14px; line-height: 1.6; color: var(--text-muted); }
        .surah-item { display: flex; align-items: center; padding: 16px; background: var(--surface); margin-bottom: 10px; border-radius: 16px; border: 1px solid var(--border); cursor: pointer; }
        .surah-num { background: var(--primary-light); color: var(--primary); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-weight: 700; margin-right: 15px; }

        /* NAVBAR */
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: calc(70px + env(safe-area-inset-bottom)); background: var(--surface); display: grid; grid-template-columns: repeat(3, 1fr); border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom); z-index: 200; box-shadow: 0 -5px 20px rgba(0,0,0,0.03); }
        .nav-item { border: none; background: none; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; color: var(--text-muted); transition: 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-label { font-size: 10px; font-weight: 700; }

        .compass-ring { 
            width: 260px; height: 260px; 
            border-radius: 50%; border: 6px solid var(--border); 
            position: relative; display: flex; 
            align-items: center; justify-content: center; 
            background: var(--surface); margin: 40px auto;
            transform: none !important; /* Ring stays still */
        }
        .compass-arrow { 
            width: 0; height: 0; 
            border-left: 15px solid transparent; border-right: 15px solid transparent; 
            border-bottom: 90px solid var(--primary); 
            position: absolute; top: 30px; 
            transform-origin: bottom center; 
            transition: transform 180ms linear; /* Smooth movement */
        }
        .kaaba-icon { position: absolute; top: -45px; font-size: 32px; }

        .bookmark-btn { background: none; border: none; color: var(--border); cursor: pointer; padding: 5px; }
        .bookmark-btn.saved { color: var(--primary); }
        .bookmark-btn svg { width: 22px; height: 22px; fill: currentColor; }

        /* PWA Prompt */
        #pwaInstall { z-index: 600; display: none; position: fixed; bottom: 20px; left: 20px; right: 20px; background: var(--surface); color: var(--text); padding: 20px; border-radius: 20px; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid var(--border); animation: slideUp 0.4s ease; }
    </style>
</head>
<body>

    <header class="header-overlay" id="stickyHeader">
        <div class="header-left">
            <div class="header-greeting" id="greetings">Assalamualaikum</div>
            <h1 class="header-title-overlay">Mukmin.com</h1>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="icon-btn-glass" onclick="toggleLang()" id="langBtn">EN</button>
            <button class="icon-btn-glass" onclick="toggleTheme()"><svg id="themeIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
            <button class="icon-btn-glass" onclick="toggleSidePanel()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
        </div>
    </header>

    <div id="view-home" class="view active">
        <div class="hero-wrapper">
            <div class="hero" id="hero">
                <div class="hero-card-bg">
                    <div class="hero-top">
                        <div class="hero-left">
                            <div id="locationName">Detecting...</div>
                            <div class="hero-date-group">
                                <div id="heroDate" style="font-size:12px; opacity:0.9; font-weight:600;">...</div>
                                <div id="hijriDate" style="font-size:11px; opacity:0.75; font-family:'Amiri', sans-serif;">...</div>
                            </div>
                        </div>
                        <div class="hero-right" style="text-align:right;">
                            <div id="heroTime">--:--</div>
                            <div id="countdown">--:--:--</div>
                            <div id="nextPrayer" style="font-size:11px; font-weight:800; color:#FFD700; margin-top:4px; text-transform:uppercase;">Next: --</div>
                        </div>
                    </div>
                    <div class="hero-divider"></div>
                    <div id="heroPrayers">
                        <div id="prayerNames"></div>
                        <div id="prayerTimes"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="app-container">
            <div id="last-read-container" style="display:none; margin-bottom: 20px;">
                <div class="section-header">üìñ Terakhir Dibaca</div>
                <div class="card" onclick="resumeLastRead()" style="display:flex; align-items:center; gap:15px; cursor:pointer; background: var(--primary-light); border-color: var(--primary);">
                    <div class="surah-num" id="lr-num">0</div>
                    <div style="flex:1">
                        <div id="lr-name" style="font-weight:800; font-size:14px;">Surah Name</div>
                        <div id="lr-meta" style="font-size:11px; color:var(--text-muted);">Ayat 0</div>
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </div>
            </div>

            <div class="section-header" id="cat-tools">üõ†Ô∏è Alatan & Ibadah</div>
            <div class="feature-grid">
                <div class="feature-btn" onclick="toggleQibla(true)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>
                    <span id="txt-tool-qibla">Qibla Finder</span>
                </div>
                <div class="feature-btn" onclick="openDuas()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                    <span id="txt-tool-duas">Daily Duas</span>
                </div>
            </div>

            <div class="section-header" id="cat-knowledge">üìö Ilmu & Hikmah</div>
            <div class="feature-grid">
                <div class="feature-btn" onclick="openHadithModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path><path d="M12 6h4"></path><path d="M12 10h4"></path></svg>
                    <span id="txt-tool-hadith">Hadis Harian</span>
                </div>
                <div class="feature-btn" onclick="openExternalPanduan()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <span id="txt-tool-guide">Panduan</span>
                </div>
                <div class="feature-btn" onclick="openQuiz()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    <span id="txt-tool-quiz">Islamic Quiz</span>
                </div>
                <div class="feature-btn" onclick="openHadith40()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"></path></svg>
                    <span>Hadis 40</span>
                </div>
                <div class="feature-btn" onclick="openKutub()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                    <span>Kitab Sahih</span>
                </div>
                <div class="feature-btn" onclick="openAsbab()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                        <circle cx="12" cy="12" r="3"></circle> </svg>
                    <span>Asbab Nuzul</span>
                </div>
            </div>

            <div class="section-header" id="cat-lifestyle">‚ú® Ekstra</div>
            <div class="feature-grid">
                <div class="feature-btn" onclick="openSmartVibes()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    <span id="txt-tool-vibes">Positive Vibes</span>
                </div>
            </div>
        </div>
    </div>

    <div id="view-quran" class="view" style="padding: 20px; padding-top: 85px;">
        <h1 id="txt-quran-title" style="font-size:24px; font-weight:800; margin-bottom:20px;">Al Quran</h1>
        <select id="quranLangSelect" style="width:100%; padding:12px; border-radius:12px; margin-bottom:15px; background:var(--surface); color:var(--text); border:1px solid var(--border);">
            <option value="en.sahih">English</option>
            <option value="ms.basmeih">Malay</option>
            <option value="id.indonesian">Indonesian</option>
        </select>
        <div id="surahList"></div>
    </div>

    <div id="view-saved" class="view" style="padding: 20px; padding-top: 85px;">
        <h1 id="txt-saved-title" style="font-size:24px; font-weight:800; margin-bottom:20px;">Saved</h1>
        <div id="bookmarksList" class="card"></div>
    </div>

    <div id="sidePanelOverlay" onclick="toggleSidePanel()"></div>
    <aside id="sidePanel">
        <div class="panel-header">
            <div id="txt-menu-title" style="font-weight:800">Menu</div>
            <button onclick="toggleSidePanel()" style="background:none; border:none; color:var(--text);"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        </div>
        <div class="panel-content">
            <div id="txt-legacy" class="section-header" style="margin-top:0;">Utiliti Lama</div>
            <div class="card" style="padding:10px; margin-bottom:25px;">
                <div id="txt-takwim" style="font-size:13px; font-weight:700; margin-bottom:8px;">Takwim Hijri</div>
                <div class="iframe-wrap" style="height: 320px;"><iframe src="Takwim-hijri.html" style="width:100%; height:100%; border:none;"></iframe></div>
            </div>

            <div id="txt-contact" class="section-header">Hubungi & Kredit</div>
            <a href="https://wa.me/60133128914" target="_blank" style="text-decoration:none;">
                <div class="card" style="display:flex; align-items:center; background:#25D366; color:white; border:none;">
                    <span id="txt-whatsapp" style="font-weight:800; font-size:14px;">WhatsApp Feedback</span>
                </div>
            </a>
        </div>
    </aside>

    <div id="pwaInstall">
        <div class="pwa-header">
            <div style="font-weight:700; font-size:14px;">Install App</div>
            <div style="font-size:11px; opacity:0.8;">Add to home screen for offline access</div>
        </div>
        
        <div id="pwa-android" style="display:none; gap:10px; margin-top:10px;">
            <button onclick="closePWA()" style="background:rgba(128,128,128,0.2); color:var(--text); border:none; padding:8px 12px; border-radius:8px; font-weight:600; font-size:12px;">Close</button>
            <button onclick="installPWA()" style="background:var(--primary); color:var(--surface); border:none; padding:8px 16px; border-radius:8px; font-weight:700; font-size:12px;">Install</button>
        </div>

        <div id="pwa-ios" style="display:none; flex-direction:column; margin-top:10px; font-size:12px; gap:8px;">
            <div style="display:flex; align-items:center; gap:8px;">1. Tap the Share button <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg></div>
            <div style="display:flex; align-items:center; gap:8px;">2. Select "Add to Home Screen" <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg></div>
            <button onclick="closePWA()" style="align-self:flex-end; background:rgba(128,128,128,0.2); color:var(--text); border:none; padding:6px 12px; border-radius:6px; font-weight:600; margin-top:5px;">Close</button>
        </div>
    </div>

    <div id="hadithModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:600; display:none; align-items:center; justify-content:center; padding:20px; animation:fadeIn 0.3s ease;">
        <div class="card" style="width:100%; max-width:400px; margin:0; max-height:80vh; overflow-y:auto; position:relative;">
            <button onclick="closeHadithModal()" style="position:absolute; top:15px; right:15px; background:none; border:none; font-size:24px;">&times;</button>
            <div style="font-weight:800; font-size:18px; margin-bottom:15px; padding-right:30px;" id="lbl-hadith-title">Hadis Harian</div>
            
            <div style="font-style:italic; font-size:15px; margin-bottom:20px; line-height:1.6;" id="hadithTextContent">Loading...</div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size:12px; font-weight:800; color:var(--primary);" id="hadithSourceContent"></div>
                <button class="bookmark-btn" id="hadithBookmark" onclick="toggleHadithBookmark(this)"><svg viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg></button>
            </div>
            <button onclick="nextHadith()" style="width:100%; margin-top:20px; padding:12px; background:var(--bg); border:1px solid var(--border); border-radius:12px; font-weight:600;">Random Hadith</button>
        </div>
    </div>

    <div id="qiblaModal">
        <div class="modal-header">
            <div style="font-weight:800">Qibla Finder</div>
            <button onclick="toggleQibla(false)" style="background:none; border:none; font-size:24px;">&times;</button>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
            <div class="compass-ring" id="compassRing">
                <div class="kaaba-icon">üïã</div>
                <div class="compass-arrow"></div>
            </div>
            <div style="font-size:36px; font-weight:800;" id="qiblaDeg">0¬∞</div>
            <div style="font-size:13px; color:var(--text-muted); text-align:center; margin-top:15px;" id="txt-qibla-note">Keep phone flat and away from magnets.</div>
        </div>
    </div>

    <div id="readerModal">
        <div class="modal-header">
            <div style="display:flex; flex-direction:column;">
                <div style="font-weight:800" id="readerTitle">Reader</div>
                <span id="readerSubtitle" style="font-size:11px; color:var(--text-muted);"></span>
            </div>
            <button onclick="closeReader()" style="background:none; border:none; font-size:28px; line-height:1;">&times;</button>
        </div>
        <div class="reader-content" id="readerContent" style="flex:1; overflow-y:auto; padding:20px;"></div>
    </div>

    <nav class="nav-bar">
        <button class="nav-item active" onclick="switchTab('home', this)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span class="nav-label" id="txt-nav-home">Home</span></button>
        <button class="nav-item" onclick="switchTab('quran', this)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg><span class="nav-label" id="txt-nav-quran">Quran</span></button>
        <button class="nav-item" onclick="switchTab('saved', this)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg><span class="nav-label" id="txt-nav-saved">Saved</span></button>
    </nav>

<script>
    /* OFFLINE HADITH DATABASE (EXPANDED) */
    const HADITH_DB = [
        { en: "The best among you is the one who learns the Quran and teaches it.", ms: "Sebaik-baik kamu adalah orang yang belajar Al-Quran dan mengajarkannya.", src: "Bukhari" },
        { en: "Actions are judged by intentions.", ms: "Sesungguhnya setiap amalan itu bergantung kepada niat.", src: "Bukhari & Muslim" },
        { en: "None of you truly believes until he loves for his brother what he loves for himself.", ms: "Tidak sempurna iman seseorang kamu sehingga dia mengasihi saudaranya sepertimana dia mengasihi dirinya sendiri.", src: "Bukhari & Muslim" },
        { en: "He who is not merciful to others, will not be treated mercifully.", ms: "Sesiapa yang tidak menyayangi, dia tidak akan disayangi.", src: "Muslim" },
        { en: "A good word is a charity.", ms: "Perkataan yang baik adalah sedekah.", src: "Bukhari & Muslim" },
        { en: "The strong man is not the good wrestler; the strong man is the only one who controls himself when he is angry.", ms: "Orang yang kuat bukanlah yang pandai bergusti, tetapi orang yang kuat adalah yang mampu menahan dirinya ketika marah.", src: "Bukhari" },
        { en: "Cleanliness is half of faith.", ms: "Kebersihan itu sebahagian daripada iman.", src: "Muslim" },
        { en: "Make things easy and do not make them difficult, cheer the people up by conveying glad tidings to them and do not repulse (them).", ms: "Permudahkanlah dan jangan menyukarkan, berilah khabar gembira dan jangan membuat orang lari.", src: "Bukhari" },
        { en: "Smiling in the face of your brother is charity.", ms: "Senyummu di hadapan saudaramu adalah sedekah.", src: "Tirmidhi" },
        { en: "The most perfect believers are the best in conduct.", ms: "Orang mukmin yang paling sempurna imannya adalah yang paling baik akhlaknya.", src: "Tirmidhi" },
        { en: "Allah does not look at your shapes or bodies, but He looks at your hearts.", ms: "Sesungguhnya Allah tidak melihat kepada rupa dan harta kamu, tetapi Allah melihat kepada hati dan amalan kamu.", src: "Muslim" },
        { en: "Be in this world as if you were a stranger or a traveler.", ms: "Jadilah kamu di dunia ini seakan-akan orang asing atau pengembara.", src: "Bukhari" },
        { en: "He who believes in Allah and the Last Day must speak good or remain silent.", ms: "Barangsiapa beriman kepada Allah dan Hari Akhirat, hendaklah dia berkata baik atau diam.", src: "Bukhari & Muslim" },
        { en: "The best of you are those who are best to their families.", ms: "Sebaik-baik kamu adalah yang paling baik terhadap ahlinya (keluarganya).", src: "Tirmidhi" },
        { en: "Seeking knowledge is a duty upon every Muslim.", ms: "Menuntut ilmu adalah kewajipan bagi setiap Muslim.", src: "Ibn Majah" },
        { en: "Exchange gifts, you will love one another.", ms: "Saling memberi hadiahlah kamu, nescaya kamu akan saling berkasih sayang.", src: "Al-Bukhari (Adab)" },
        { en: "Allah helps His servant as long as the servant helps his brother.", ms: "Allah sentiasa menolong hamba-Nya selama hamba itu menolong saudaranya.", src: "Muslim" },
        { en: "Richness is not having many belongings, but richness is contentment of the soul.", ms: "Kekayaan itu bukanlah banyaknya harta benda, tetapi kekayaan itu adalah kaya hati (cukup apa yang ada).", src: "Bukhari" },
        { en: "Do not get angry, and Paradise is yours.", ms: "Janganlah kamu marah, maka bagimu Syurga.", src: "Tabrani" },
        { en: "Fear Allah wherever you are.", ms: "Bertakwalah kepada Allah di mana sahaja kamu berada.", src: "Tirmidhi" },
        { en: "Modesty brings nothing but good.", ms: "Sifat malu itu tidak mendatating sesuatu melainkan kebaikan.", src: "Bukhari & Muslim" },
        { en: "The Dua (supplication) is the essence of worship.", ms: "Doa itu adalah otak (inti) ibadah.", src: "Tirmidhi" },
        { en: "Cleanliness invites towards Faith, and Faith leads its possessor to the Garden.", ms: "Kebersihan mengajak kepada keimanan, dan keimanan membawa pemiliknya ke Syurga.", src: "Tabrani" },
        { en: "Whoever follows a path to seek knowledge, Allah will make the path to Jannah easy for him.", ms: "Barangsiapa menempuh jalan untuk menuntut ilmu, Allah akan memudahkannya jalan ke Syurga.", src: "Muslim" },
        { en: "Give the worker his wages before his sweat dries.", ms: "Berikanlah upah kepada pekerja sebelum kering peluhnya.", src: "Ibn Majah" },
        { en: "A person will be with those whom he loves.", ms: "Seseorang itu akan bersama dengan orang yang dicintainya (di Akhirat kelak).", src: "Bukhari & Muslim" },
        { en: "There is no disease that Allah has created, except that He also has created its treatment.", ms: "Tidaklah Allah menurunkan penyakit kecuali Dia juga menurunkan penawarnya.", src: "Bukhari" },
        { en: "The best charity is that given by one who has little.", ms: "Sebaik-baik sedekah adalah usaha daripada orang yang sedikit hartanya.", src: "Abu Dawud" },
        { en: "Oppression will be a darkness on the Day of Resurrection.", ms: "Kezaliman itu adalah kegelapan pada Hari Kiamat.", src: "Bukhari & Muslim" },
        { en: "Gentleness does not enter anything except that it beautifies it.", ms: "Sesungguhnya kelembutan tidak ada pada sesuatu melainkan ia menghiasinya.", src: "Muslim" }
    ];

    /* PRAYER CALCULATION ENGINE */
    const PrayerCalc = {
        calc: function(lat, lng, timezone, date) {
            let julianDate = this.julian(date.getFullYear(), date.getMonth() + 1, date.getDate());
            return {
                Imsak: this.computeTime(19.5, julianDate, lat, lng, timezone, 'fajr') - (10/60), 
                Fajr: this.computeTime(20, julianDate, lat, lng, timezone, 'fajr'),
                Dhuhr: this.computeTime(0, julianDate, lat, lng, timezone, 'dhuhr'),
                Asr: this.computeTime(0, julianDate, lat, lng, timezone, 'asr'),
                Maghrib: this.computeTime(0.833, julianDate, lat, lng, timezone, 'maghrib'),
                Isha: this.computeTime(18, julianDate, lat, lng, timezone, 'isha')
            };
        },
        julian: function(year, month, day) {
            if (month <= 2) { year -= 1; month += 12; }
            let A = Math.floor(year / 100);
            let B = 2 - A + Math.floor(A / 4);
            return Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + B - 1524.5;
        },
        computeTime: function(angle, jd, lat, lng, tz, type) {
            let n = jd - 2451545.0;
            let g = 357.529 + 0.98560028 * n;
            let q = 280.459 + 0.98564736 * n;
            let L = q + 1.915 * Math.sin(g * Math.PI/180) + 0.020 * Math.sin(2 * g * Math.PI/180);
            let e = 23.439 - 0.00000036 * n;
            let RA = Math.atan2(Math.cos(e * Math.PI/180) * Math.sin(L * Math.PI/180), Math.cos(L * Math.PI/180)) * 180/Math.PI;
            RA = RA / 15; if(RA < 0) RA += 24;
            let D = Math.asin(Math.sin(e * Math.PI/180) * Math.sin(L * Math.PI/180)) * 180/Math.PI;
            let EqT = q/15 - RA;
            let HA = 0;
            let latRad = lat * Math.PI/180;
            let dRad = D * Math.PI/180;
            if(type === 'dhuhr') { HA = 0; } 
            else if (type === 'asr') {
                let alt = Math.atan(1 / (1 + Math.tan(Math.abs(lat - D) * Math.PI/180)));
                HA = Math.acos((Math.sin(alt) - Math.sin(latRad)*Math.sin(dRad)) / (Math.cos(latRad)*Math.cos(dRad))) * 180/Math.PI;
            } else {
                let factor = (type === 'maghrib' || type === 'fajr' && angle < 1) ? 0.833 : angle;
                let alt = -factor * Math.PI/180; 
                let cosHA = (Math.sin(alt) - Math.sin(latRad)*Math.sin(dRad)) / (Math.cos(latRad)*Math.cos(dRad));
                HA = (cosHA < -1 || cosHA > 1) ? 0 : Math.acos(cosHA) * 180/Math.PI;
            }
            let time = 12 + EqT;
            if (type === 'fajr') time = time - HA/15;
            else if (type !== 'dhuhr') time = time + HA/15;
            time = time + tz - lng/15;
            return (time + 24) % 24; 
        },
        getHijriDate: function(date) {
            let jd = this.julian(date.getFullYear(), date.getMonth() + 1, date.getDate());
            let l = jd - 1948440 + 10632;
            let n = Math.floor((l - 1) / 10631);
            let l1 = l - 10631 * n + 354;
            let j = (Math.floor((10985 - l1) / 5316)) * (Math.floor((50 * l1) / 17719)) + (Math.floor(l1 / 5670)) * (Math.floor((43 * l1) / 15238));
            let l2 = l1 - (Math.floor((30 - j) / 15)) * (Math.floor((17719 * j) / 50)) - (Math.floor(j / 16)) * (Math.floor((15238 * j) / 43)) + 29;
            let m = Math.floor((24 * l2) / 709);
            let d = l2 - Math.floor((709 * m) / 24);
            let y = 30 * n + j - 30;
            return { day: d, month: m - 1, year: y };
        }
    };

    /* STATE MANAGEMENT */
    function safeParse(key, fallback) {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : fallback;
        } catch (e) {
            console.error("Corrupt data in " + key, e);
            return fallback;
        }
    }

    const prayerDisplayMap = {
        Imsak: "Imsak", Fajr: "Subuh", Dhuhr: "Zohor", Asr: "Asar", Maghrib: "Maghrib", Isha: "Isyak"
    };

    const HIJRI_MONTHS = {
        en: ["Muharram","Safar","Rabi' al-Awwal","Rabi' al-Thani","Jumada al-Ula","Jumada al-Akhirah","Rajab","Sha'ban","Ramadan","Shawwal","Dhu al-Qi'dah","Dhu al-Hijjah"],
        ms: ["Muharram","Safar","Rabiul Awal","Rabiul Akhir","Jamadil Awal","Jamadil Akhir","Rejab","Syaaban","Ramadan","Syawal","Zulkaedah","Zulhijjah"]
    };

    const savedCoords = safeParse('wsl_coords', null);
    
    window.STATE = { 
        lat: savedCoords ? savedCoords.lat : 3.1390, 
        lon: savedCoords ? savedCoords.lon : 101.6869, 
        prayerTimes: {}, 
        theme: localStorage.getItem('wsl_theme') || 'light', 
        lang: localStorage.getItem('wsl_lang') || 'en',
        bookmarks: safeParse('wsl_bookmarks', []), 
        notified: safeParse('wsl_notified', {}) 
    };

    const TRANSLATIONS = {
        en: {
            greetingMorning: "Good Morning", greetingAfternoon: "Good Afternoon", greetingEvening: "Good Evening",
            currentLoc: "Current Location", savedLoc: "Saved Location", defaultLoc: "Kuala Lumpur",
            catTools: "üõ†Ô∏è Tools & Ibadah", catKnowledge: "üìö Knowledge & Wisdom", catLifestyle: "‚ú® Extras",
            mainFeatures: "Main Features", dailyHadith: "Daily Hadith", qibla: "Qibla Finder", 
            duas: "Daily Duas", guide: "Panduan", vibes: "Positive Vibes", quiz: "Islamic Quiz",
            legacy: "Other Utils", contact: "Contact & Credits", navHome: "Home",
            noBookmarks: "No saved items.", next: "NEXT",
            menu: "Menu", savedTitle: "Saved", quranTitle: "Al Quran"
        },
        ms: {
            greetingMorning: "Selamat Pagi", greetingAfternoon: "Selamat Tengahari", greetingEvening: "Selamat Malam",
            currentLoc: "Lokasi Semasa", savedLoc: "Lokasi Disimpan", defaultLoc: "Kuala Lumpur",
            catTools: "üõ†Ô∏è Alatan & Ibadah", catKnowledge: "üìö Ilmu & Hikmah", catLifestyle: "‚ú® Ekstra",
            mainFeatures: "Ciri Utama", dailyHadith: "Hadis Harian", qibla: "Cari Kiblat", 
            duas: "Doa Harian", guide: "Panduan", vibes: "Vibes Positif", quiz: "Kuiz Islamik",
            legacy: "Utiliti Lain", contact: "Hubungi & Kredit", navHome: "Utama",
            noBookmarks: "Tiada simpanan.", next: "SETERUSNYA",
            menu: "Menu", savedTitle: "Disimpan", quranTitle: "Al-Quran"
        }
    };

    const azanAudio = new Audio('azan.mp3'); 
    let heroInterval = null; 
    let dp = null;

    /* CORE INIT */
    window.addEventListener('DOMContentLoaded', () => {
        applyTheme(); updateLanguageUI(); updateGreeting(); calculateLocalTimes(); 
        getLocation(); renderBookmarksList();
        updateLastReadUI(); 
        
        window.addEventListener('scroll', () => {
            const h = document.getElementById('stickyHeader');
            if(window.scrollY > 40) h.classList.add('scrolled'); else h.classList.remove('scrolled');
        });

        document.body.addEventListener('click', () => { 
            if (azanAudio.paused) { 
                azanAudio.play().then(() => { azanAudio.pause(); azanAudio.currentTime = 0; }).catch(console.log); 
            } 
            if(('Notification' in window) && Notification.permission !== 'granted') Notification.requestPermission();
        }, {once:true});
    });

    /* LOCATION & TIME */
    function getLocation() {
        const locText = document.getElementById('locationName');
        const t = TRANSLATIONS[window.STATE.lang];
        const onSuccess = (p) => {
            window.STATE.lat = p.coords.latitude; window.STATE.lon = p.coords.longitude;
            localStorage.setItem('wsl_coords', JSON.stringify({lat: window.STATE.lat, lon: window.STATE.lon}));
            locText.textContent = t.currentLoc; calculateLocalTimes();
        };
        const onError = () => { locText.textContent = savedCoords ? t.savedLoc : t.defaultLoc; calculateLocalTimes(); };
        if(navigator.geolocation) { navigator.geolocation.getCurrentPosition(onSuccess, onError, { timeout: 6000 }); } else { onError(); }
    }

    function calculateLocalTimes() {
        const date = new Date();
        const tz = date.getTimezoneOffset() / -60;
        const raw = PrayerCalc.calc(window.STATE.lat, window.STATE.lon, tz, date);
        const fmt = (t) => { let h=Math.floor(t), m=Math.floor((t-h)*60); return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; };
        window.STATE.prayerTimes = { Imsak: fmt(raw.Imsak), Fajr: fmt(raw.Fajr), Dhuhr: fmt(raw.Dhuhr), Asr: fmt(raw.Asr), Maghrib: fmt(raw.Maghrib), Isha: fmt(raw.Isha) };
        renderHeroPrayers(); updateHero();
    }

    function renderHeroPrayers() {
        const order = ['Imsak','Fajr','Dhuhr','Asr','Maghrib','Isha'];
        const nDiv = document.getElementById('prayerNames'); const tDiv = document.getElementById('prayerTimes');
        nDiv.innerHTML = ''; tDiv.innerHTML = '';
        order.forEach(k => {
            nDiv.innerHTML += `<div>${prayerDisplayMap[k].substring(0,3)}</div>`;
            tDiv.innerHTML += `<div>${window.STATE.prayerTimes[k]}</div>`;
        });
    }

    function updateHero() {
        if(heroInterval) clearInterval(heroInterval);
        const tick = () => {
            const now = new Date();
            const nowMins = (now.getHours() * 60) + now.getMinutes();
            document.getElementById('heroTime').textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12: true});
            document.getElementById('heroDate').textContent = now.toLocaleDateString([], {weekday:'long', day:'numeric', month:'short'});
            
            const hObj = PrayerCalc.getHijriDate(now);
            const mList = HIJRI_MONTHS[window.STATE.lang];
            const hStr = `${hObj.day} ${mList[hObj.month]} ${hObj.year}`;
            document.getElementById('hijriDate').textContent = hStr;

            let minDiff = Infinity; let nextKey = 'Fajr';
            const timings = window.STATE.prayerTimes;
            ['Imsak','Fajr','Dhuhr','Asr','Maghrib','Isha'].forEach(k => {
                const [h,m] = timings[k].split(':').map(Number);
                const pMins = (h*60) + m;
                const notifKey = `${k}_${now.toDateString()}`;
                if (nowMins === pMins && !window.STATE.notified[notifKey]) {
                    window.STATE.notified[notifKey] = true;
                    sessionStorage.setItem('wsl_notified', JSON.stringify(window.STATE.notified));
                    azanAudio.play().catch(console.log);
                    if (Notification.permission === 'granted') new Notification(`Time for ${prayerDisplayMap[k]}`);
                }
                let tDate = new Date(); tDate.setHours(h,m,0,0);
                if(tDate < now) tDate.setDate(tDate.getDate()+1);
                const diff = tDate - now;
                if(diff < minDiff) { minDiff = diff; nextKey = k; }
            });
            
            const hh = Math.floor(minDiff/3600000).toString().padStart(2,'0');
            const mm = Math.floor((minDiff%3600000)/60000).toString().padStart(2,'0');
            const ss = Math.floor((minDiff%60000)/1000).toString().padStart(2,'0');
            document.getElementById('countdown').textContent = `- ${hh}:${mm}:${ss}`;
            document.getElementById('nextPrayer').textContent = `${TRANSLATIONS[window.STATE.lang].next}: ${prayerDisplayMap[nextKey]}`;
            
            const hero = document.getElementById('hero'); hero.className = 'hero';
            const hr = now.getHours();
            if(hr >= 5 && hr < 12) hero.classList.add('bg-fajr');
            else if(hr >= 12 && hr < 16) hero.classList.add('bg-dhuhr');
            else if(hr >= 16 && hr < 19) hero.classList.add('bg-asr');
            else if(hr >= 19 && hr < 21) hero.classList.add('bg-maghrib');
        };
        tick(); heroInterval = setInterval(tick, 1000);
    }

    /* UI HELPERS */
    function toggleSidePanel() { document.getElementById('sidePanel').classList.toggle('open'); document.getElementById('sidePanelOverlay').classList.toggle('open'); }
    function toggleTheme() { window.STATE.theme = window.STATE.theme === 'light' ? 'dark' : 'light'; localStorage.setItem('wsl_theme', window.STATE.theme); applyTheme(); }
    function applyTheme() { document.documentElement.setAttribute('data-theme', window.STATE.theme); }
    function toggleLang() { window.STATE.lang = window.STATE.lang === 'en' ? 'ms' : 'en'; localStorage.setItem('wsl_lang', window.STATE.lang); updateLanguageUI(); updateGreeting(); calculateLocalTimes(); }
    
    function updateLanguageUI() {
        const t = TRANSLATIONS[window.STATE.lang];
        document.getElementById('langBtn').textContent = window.STATE.lang.toUpperCase();
        document.getElementById('cat-tools').textContent = t.catTools;
        document.getElementById('cat-knowledge').textContent = t.catKnowledge;
        document.getElementById('cat-lifestyle').textContent = t.catLifestyle;
        document.getElementById('txt-tool-qibla').textContent = t.qibla;
        document.getElementById('txt-tool-duas').textContent = t.duas;
        document.getElementById('txt-tool-guide').textContent = t.guide;
        document.getElementById('txt-tool-vibes').textContent = t.vibes;
        document.getElementById('txt-tool-quiz').textContent = t.quiz;
        document.getElementById('txt-tool-hadith').textContent = t.dailyHadith;
        document.getElementById('txt-menu-title').textContent = t.menu;
        document.getElementById('txt-legacy').textContent = t.legacy;
        document.getElementById('txt-contact').textContent = t.contact;
        document.getElementById('txt-nav-home').textContent = t.navHome;
        document.getElementById('txt-saved-title').textContent = t.savedTitle;
        document.getElementById('txt-quran-title').textContent = t.quranTitle;
        document.getElementById('lbl-hadith-title').textContent = t.dailyHadith;
        if(document.getElementById('view-quran').classList.contains('active')) {
             const langMap = { 'en': 'en.sahih', 'ms': 'ms.basmeih' };
             if(langMap[window.STATE.lang]) document.getElementById('quranLangSelect').value = langMap[window.STATE.lang];
        }
    }

    function switchTab(id, btn) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        btn.classList.add('active');
        if(id === 'quran') {
            const langMap = { 'en': 'en.sahih', 'ms': 'ms.basmeih' };
            const select = document.getElementById('quranLangSelect');
            if(langMap[window.STATE.lang]) { select.value = langMap[window.STATE.lang]; }
            loadQuran();
        }
    }

    function updateGreeting() {
        const h = new Date().getHours();
        const t = TRANSLATIONS[window.STATE.lang];
        let g = t.greetingEvening; if(h < 12) g = t.greetingMorning; else if(h < 18) g = t.greetingAfternoon;
        document.getElementById('greetings').textContent = `Assalamualaikum, ${g}`;
    }

    /* HADITH LOGIC */
    function openHadithModal() { document.getElementById('hadithModal').style.display = 'flex'; nextHadith(); }
    function closeHadithModal() { document.getElementById('hadithModal').style.display = 'none'; }
    function nextHadith() {
        const h = HADITH_DB[Math.floor(Math.random() * HADITH_DB.length)];
        const text = window.STATE.lang === 'ms' ? h.ms : h.en;
        document.getElementById('hadithTextContent').textContent = `"${text}"`;
        document.getElementById('hadithSourceContent').textContent = h.src;
        checkHadithBookmark();
    }

    /* QURAN & READER LOGIC */
    async function loadQuran() {
        const list = document.getElementById('surahList');
        if(list.children.length > 5) return; 
        list.innerHTML = "Loading...";
        try {
            const r = await fetch('https://api.alquran.cloud/v1/surah');
            const d = await r.json();
            list.innerHTML = '';
            d.data.forEach(s => {
                // FIX: Escape single quotes (e.g. Al-Isra' -> Al-Isra\')
                const safeName = s.englishName.replace(/'/g, "\\'");
                
                list.innerHTML += `<div class="surah-item" onclick="openSurah(${s.number}, '${safeName}')">
                    <div class="surah-num">${s.number}</div>
                    <div style="flex:1"><b>${s.englishName}</b><br><small>${s.name}</small></div>
                </div>`;
            });
        } catch(e) { list.innerHTML = "Internet required for Quran."; }
    }

    const SURAH_CACHE = {};

    async function openSurah(num, name) {
        const m = document.getElementById('readerModal');
        const c = document.getElementById('readerContent');
        m.classList.add('open');
        document.getElementById('readerTitle').textContent = name;
        document.getElementById('readerSubtitle').textContent = `Surah ${num}`;
        c.innerHTML = '<div style="text-align:center; padding:20px;">Loading...</div>';
        
        const lang = document.getElementById('quranLangSelect').value;
        const cacheKey = `${num}_${lang}`;

        try {
            let d1, d2;
            // 1. Check Cache
            if(SURAH_CACHE[cacheKey]) {
                d1 = SURAH_CACHE[cacheKey].d1;
                d2 = SURAH_CACHE[cacheKey].d2;
            } else {
                // 2. Fetch Live Data
                const [r1, r2] = await Promise.all([
                    fetch(`https://api.alquran.cloud/v1/surah/${num}`),
                    fetch(`https://api.alquran.cloud/v1/surah/${num}/${lang}`)
                ]);
                d1 = await r1.json();
                d2 = await r2.json();
                
                // Cache whatever we got
                SURAH_CACHE[cacheKey] = { d1, d2 };
            }

            // 3. Safety Check: Did Arabic load?
            if (!d1 || d1.code !== 200 || !d1.data) {
                throw new Error("Arabic text unavailable");
            }

            // 4. Safety Check: Did Translation load?
            const hasTranslation = (d2 && d2.code === 200 && d2.data && d2.data.ayahs);

            let html = (num!==1 && num!==9) ? '<div style="text-align:center;font-family:Amiri;font-size:24px;margin-bottom:20px;">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>' : '';
            
            d1.data.ayahs.forEach((a, i) => {
                const trans = (hasTranslation && d2.data.ayahs[i]) ? d2.data.ayahs[i].text : '';
                
                const saved = window.STATE.bookmarks.some(b => b.id === `ayah_${num}_${a.numberInSurah}`);
                const safeAr = encodeURIComponent(a.text);
                const safeTr = encodeURIComponent(trans);
                const audioUrl = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${a.number}.mp3`;
                
                html += `<div class="ayah-block" id="ayah-${num}-${a.numberInSurah}">
                    <div class="ayah-tools">
                        <div style="display:flex; gap:12px; align-items:center;">
                            <span style="font-size:12px;color:var(--text-muted)">${num}:${a.numberInSurah}</span>
                            <button class="icon-btn-glass" style="width:28px; height:28px; background:var(--primary-light); color:var(--primary); border:none;" 
                                onclick="playAyah('${audioUrl}', this)">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                            </button>
                        </div>
                        <button class="bookmark-btn ${saved?'saved':''}" onclick="togAyah(this,${num},${a.numberInSurah},'${safeAr}','${safeTr}','${name}')">
                            <svg viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                        </button>
                    </div>
                    <div class="ayah-arabic">${a.text}</div>
                    <div class="ayah-trans">${trans || '<em style="opacity:0.5; font-size:12px;">(Translation unavailable)</em>'}</div>
                </div>`;
            });
            c.innerHTML = html;
        } catch(e) { 
            console.error(e);
            c.innerHTML = `<div style='text-align:center; padding:20px; color:red;'>
                Unable to load Surah.<br>
                <small>Check your internet or try a different language.</small>
                <br><br>
                <button onclick="closeReader()" style="padding:10px 20px; border-radius:10px; border:1px solid #ccc;">Close</button>
            </div>`; 
        }
    }

    // Global Audio Player
    const audioPlayer = new Audio();
    let currentPlayBtn = null;
    let isAutoNextEnabled = true;

    function playAyah(url, btn) {
        const ayahBlock = btn.closest('.ayah-block');

        if (currentPlayBtn === btn) {
            if (audioPlayer.paused) {
                audioPlayer.play();
                btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
                ayahBlock.classList.add('playing');
            } else {
                audioPlayer.pause();
                btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
                ayahBlock.classList.remove('playing');
            }
            return;
        }

        if (currentPlayBtn) {
            currentPlayBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            const oldBlock = currentPlayBtn.closest('.ayah-block');
            if (oldBlock) oldBlock.classList.remove('playing');
        }

        currentPlayBtn = btn;
        audioPlayer.src = url;
        audioPlayer.load();

        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
        ayahBlock.classList.add('playing');
        ayahBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });

        const playPromise = audioPlayer.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error("Auto-play blocked:", error);
                btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
                ayahBlock.classList.remove('playing');
            });
        }

        audioPlayer.onended = () => {
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            ayahBlock.classList.remove('playing');

            if (isAutoNextEnabled) {
                const nextBlock = ayahBlock.nextElementSibling;
                if (nextBlock && nextBlock.classList.contains('ayah-block')) {
                    const nextBtn = nextBlock.querySelector('button[onclick^="playAyah"]');
                    if (nextBtn) nextBtn.click();
                }
            }
        };
    }

    async function jumpToAyah(surahNum, surahName, ayahNum) {
        const quranNavItem = document.querySelectorAll('.nav-item')[1];
        switchTab('quran', quranNavItem);
        await openSurah(surahNum, surahName);
        setTimeout(() => {
            const readerContent = document.getElementById('readerContent');
            const ayahBlocks = readerContent.getElementsByClassName('ayah-block');
            for (let block of ayahBlocks) {
                if (block.innerText.includes(`${surahNum}:${ayahNum}`)) {
                    block.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    block.style.background = 'var(--primary-light)';
                    setTimeout(() => block.style.background = 'transparent', 2000);
                    break;
                }
            }
        }, 500);
    }

    function openReader(t, s, f) {
        document.getElementById('readerTitle').textContent = t;
        document.getElementById('readerSubtitle').textContent = s;
        document.getElementById('readerContent').innerHTML = `<iframe src="${f}" style="width:100%; height:100%; border:none;"></iframe>`;
        document.getElementById('readerModal').classList.add('open');
    }
    function closeReader() { document.getElementById('readerModal').classList.remove('open'); }
    
    window.openExternalPanduan = () => openReader("Pustaka Panduan", "Islamic Guides", "panduan.html");
    window.openDuas = () => openReader("Himpunan Doa", "Daily Duas", "doa.html");
    window.openSmartVibes = () => openReader("Positive Vibes", "Mood & Tasbih", "vibes.html");
    window.openQuiz = () => openReader("Islamic Quiz", "Test Your Knowledge", "quiz.html");
    window.openHadith40 = () => openReader("Hadis 40", "Imam Nawawi", "hadith40.html");
    window.openKutub = () => openReader("Kitab Sahih", "Bukhari & Muslim", "kutub.html");
    window.openAsbab = () => openReader("Asbabun Nuzul", "Kisah Di Sebalik Ayat", "asbab.html");

    window.togAyah = function(btn, s, a, ar, tr, name) {
        ar = decodeURIComponent(ar); tr = decodeURIComponent(tr);
        const id = `ayah_${s}_${a}`;
        const lastRead = { id, surahNum: s, ayahNum: a, surahName: name, time: new Date().getTime() };
        localStorage.setItem('wsl_last_read', JSON.stringify(lastRead));
        updateLastReadUI();
        const idx = window.STATE.bookmarks.findIndex(x => x.id === id);
        if(idx > -1) { window.STATE.bookmarks.splice(idx, 1); btn.classList.remove('saved'); }
        else { window.STATE.bookmarks.push({id, type:'ayah', surahNum:s, ayahNum:a, arText:ar, trText:tr, surahName:name}); btn.classList.add('saved'); }
        localStorage.setItem('wsl_bookmarks', JSON.stringify(window.STATE.bookmarks));
        renderBookmarksList();
    };

    function updateLastReadUI() {
        const lr = JSON.parse(localStorage.getItem('wsl_last_read'));
        const container = document.getElementById('last-read-container');
        if (lr) {
            container.style.display = 'block';
            document.getElementById('lr-num').textContent = lr.surahNum;
            document.getElementById('lr-name').textContent = lr.surahName;
            document.getElementById('lr-meta').textContent = `Ayat ${lr.ayahNum}`;
        }
    }

    function resumeLastRead() {
        const lr = JSON.parse(localStorage.getItem('wsl_last_read'));
        if (lr) { jumpToAyah(lr.surahNum, lr.surahName, lr.ayahNum); }
    }

    window.toggleHadithBookmark = function(btn) {
        const t = document.getElementById('hadithTextContent').textContent;
        const src = document.getElementById('hadithSourceContent').textContent;
        const id = `hadith_${t.substring(0,10)}`;
        const idx = window.STATE.bookmarks.findIndex(x => x.id === id);
        if(idx > -1) { window.STATE.bookmarks.splice(idx, 1); btn.classList.remove('saved'); }
        else { window.STATE.bookmarks.push({id, type:'hadith', text:t, src:src}); btn.classList.add('saved'); }
        localStorage.setItem('wsl_bookmarks', JSON.stringify(window.STATE.bookmarks));
        renderBookmarksList();
    };

    function checkHadithBookmark() {
        const t = document.getElementById('hadithTextContent').textContent;
        const btn = document.getElementById('hadithBookmark');
        if(!btn) return;
        if(window.STATE.bookmarks.some(x => x.id === `hadith_${t.substring(0,10)}`)) btn.classList.add('saved');
        else btn.classList.remove('saved');
    }

    function renderBookmarksList() {
        const l = document.getElementById('bookmarksList');
        const t = TRANSLATIONS[window.STATE.lang];
        if (window.STATE.bookmarks.length === 0) {
            l.innerHTML = `<div style="text-align:center;color:var(--text-muted);font-size:13px;padding:20px;">${t.noBookmarks}</div>`;
            return;
        }
        l.innerHTML = '';
        window.STATE.bookmarks.forEach(b => {
            if (b.type === 'ayah') {
                l.innerHTML += `<div class="surah-item" style="margin-bottom:8px; cursor:pointer;" onclick="jumpToAyah(${b.surahNum}, '${b.surahName}', ${b.ayahNum})">
                        <div class="surah-num" style="width:50px; font-size:10px;">${b.surahNum}:${b.ayahNum}</div>
                        <div style="flex:1; overflow:hidden;">
                            <div style="font-size:13px;"><strong>${b.surahName}</strong></div>
                            <div style="color:var(--text-muted); font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${b.trText}</div>
                        </div>
                    </div>`;
            } else {
                l.innerHTML += `<div class="card" style="padding:12px; margin-bottom:8px; font-size:13px;">
                        <div><strong>Hadith:</strong> ${b.text.substring(0, 80)}...</div>
                    </div>`;
            }
        });
    }

    /* IMPROVED COMPASS LOGIC */
    let lastRotation = 0;
    let qiblaBearing = 0;

    function calcQibla(lat1, lon1) {
        const kaabaLat = 21.422487;
        const kaabaLon = 39.826206;
        const œÜ1 = lat1 * Math.PI/180;
        const Œª1 = lon1 * Math.PI/180;
        const œÜ2 = kaabaLat * Math.PI/180;
        const Œª2 = kaabaLon * Math.PI/180;

        const y = Math.sin(Œª2 - Œª1) * Math.cos(œÜ2);
        const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2 - Œª1);
        let Œ∏ = Math.atan2(y, x) * 180/Math.PI;
        return (Œ∏ + 360) % 360;
    }

    function getScreenAngle() {
        if (screen && screen.orientation && typeof screen.orientation.angle === 'number') return screen.orientation.angle;
        if (typeof window.orientation === 'number') return window.orientation || 0;
        return 0;
    }

    function rotateNeedle(deg) {
        const arrow = document.querySelector('.compass-arrow');
        if (!arrow) return;
        let diff = (deg - lastRotation + 540) % 360 - 180;
        lastRotation += diff;
        arrow.style.transform = `rotate(${lastRotation}deg)`;
    }

    function handleCompass(e) {
        let heading = null;
        if (typeof e.webkitCompassHeading === 'number') {
            heading = e.webkitCompassHeading;
        } else if (e.absolute && typeof e.alpha === 'number') {
            heading = e.alpha;
        } else if (typeof e.alpha === 'number') {
            heading = e.alpha;
        }

        if (heading !== null) {
            const screenAngle = getScreenAngle();
            const magnetic = (360 - heading + screenAngle + 360) % 360;
            rotateNeedle(qiblaBearing - magnetic);
        }
    }

    async function toggleQibla(s) {
        const m = document.getElementById('qiblaModal');
        if(s) {
            qiblaBearing = calcQibla(window.STATE.lat, window.STATE.lon);
            document.getElementById('qiblaDeg').textContent = Math.round(qiblaBearing) + "¬∞";

            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const resp = await DeviceOrientationEvent.requestPermission();
                    if (resp === 'granted') {
                        m.classList.add('active');
                        window.addEventListener('deviceorientationabsolute', handleCompass, true);
                        window.addEventListener('deviceorientation', handleCompass, true);
                    }
                } catch(err) { alert("Sensor access denied."); }
            } else {
                m.classList.add('active');
                window.addEventListener('deviceorientationabsolute', handleCompass, true);
                window.addEventListener('deviceorientation', handleCompass, true);
            }
        } else {
            m.classList.remove('active');
            window.removeEventListener('deviceorientationabsolute', handleCompass);
            window.removeEventListener('deviceorientation', handleCompass);
        }
    }
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // --- YOUR SPECIFIC CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBQMVNRDYsKHRj_-bwKbFICyN6XseL3CDI",
        authDomain: "waktusolatlite.firebaseapp.com",
        databaseURL: "https://waktusolatlite-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "waktusolatlite",
        storageBucket: "waktusolatlite.firebasestorage.app",
        messagingSenderId: "86910439082",
        appId: "1:86910439082:web:e482d01e1451e58179cad3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 1. UNIQUE VISITOR ID (Tracks "Online" Users)
    let visitorId = localStorage.getItem('wsl_vid');
    if (!visitorId) {
        // Create a random ID if not exists
        visitorId = 'u_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('wsl_vid', visitorId);
    }

    // 2. CORE LOGGING FUNCTION
    window.logEvent = async (type, feature = null, details = null) => {
        try {
            await addDoc(collection(db, "analytics"), {
                type: type,          // e.g., 'page_view', 'feature_click', 'install'
                feature: feature,    // e.g., 'Qibla Finder'
                details: details,    // Extra info
                visitorId: visitorId,// To count unique users
                timestamp: serverTimestamp(),
                userAgent: navigator.userAgent
            });
        } catch (e) {
            console.error("Tracking Error (Silent):", e);
        }
    };

    // 3. AUTO-TRACKING TRIGGERS
    
    // A. Log "Page View" on load
    window.logEvent('page_view', 'home');

    // B. Track App Installation
    window.addEventListener('appinstalled', (evt) => {
        window.logEvent('install', 'pwa_installed');
    });

    // C. Track All Interactions automatically
    document.addEventListener('DOMContentLoaded', () => {
        
        // Track Main Feature Buttons
        document.querySelectorAll('.feature-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Get clean text inside the button
                const txt = btn.innerText.replace(/\n/g, ' ').trim();
                window.logEvent('feature_click', txt);
            });
        });

        // Track Bottom Navigation
        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', () => {
                const lbl = btn.querySelector('.nav-label');
                if(lbl) window.logEvent('navigation', lbl.innerText);
            });
        });
        
        // Track External Links (like WhatsApp)
        const waLink = document.querySelector('a[href*="wa.me"]');
        if(waLink) {
            waLink.addEventListener('click', () => window.logEvent('contact', 'whatsapp_click'));
        }
    });
    

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    window.addEventListener('beforeinstallprompt', e => { 
        e.preventDefault(); dp = e; 
        if(!isStandalone) { document.getElementById('pwaInstall').style.display = 'flex'; document.getElementById('pwa-android').style.display = 'flex'; }
    });
    if (isIOS && !isStandalone) { setTimeout(() => { document.getElementById('pwaInstall').style.display = 'flex'; document.getElementById('pwa-ios').style.display = 'flex'; }, 3000); }
    window.installPWA = function() { 
        if(dp) { dp.prompt(); dp.userChoice.then((r) => { if (r.outcome === 'accepted') { document.getElementById('pwaInstall').style.display = 'none'; } dp = null; }); }
    };
    window.closePWA = () => { document.getElementById('pwaInstall').style.display = 'none'; };
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Registration Failed:', err)); }); }
    </script>
</body>
</html>
