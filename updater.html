<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSL Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #A67734; --bg: #F8F9FA; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; }
        .sidebar { background: white; min-height: 100vh; border-right: 1px solid #dee2e6; }
        .nav-link { color: #666; font-weight: 600; padding: 15px 20px; }
        .nav-link.active { background: #fff8ee; color: var(--primary); border-right: 3px solid var(--primary); }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 12px; margin-bottom: 20px; }
        .btn-primary { background: var(--primary); border: none; }
        .btn-primary:hover { background: #8e652b; }
        .item-row { background: #fff; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        
        /* LOCK SCREEN */
        #authOverlay { position: fixed; inset: 0; background: #212529; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        #authOverlay.unlocked { transform: translateY(-100%); pointer-events: none; }
        .pin-display { font-size: 32px; letter-spacing: 15px; margin-bottom: 30px; min-height: 40px; font-weight: bold; color: var(--primary); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 320px; }
        .num-btn { width: 70px; height: 70px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 24px; cursor: pointer; transition: all 0.2s; display:flex; align-items:center; justify-content:center; }
        .num-btn:active { background: rgba(255,255,255,0.2); transform: scale(0.9); }
        .num-btn.submit { background: var(--primary); border-color: var(--primary); }
        
        /* Image Preview */
        #imgPreviewBox img { max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #ddd; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="mb-3"><i class="fas fa-user-shield fa-4x text-muted"></i></div>
        <h3 class="mb-1">Admin Access</h3>
        <p class="text-white-50 mb-4">Enter PIN</p>
        <div class="pin-display" id="pinDisplay"></div>
        <div class="numpad">
            <button class="num-btn" onclick="pressPin('1')">1</button>
            <button class="num-btn" onclick="pressPin('2')">2</button>
            <button class="num-btn" onclick="pressPin('3')">3</button>
            <button class="num-btn" onclick="pressPin('4')">4</button>
            <button class="num-btn" onclick="pressPin('5')">5</button>
            <button class="num-btn" onclick="pressPin('6')">6</button>
            <button class="num-btn" onclick="pressPin('7')">7</button>
            <button class="num-btn" onclick="pressPin('8')">8</button>
            <button class="num-btn" onclick="pressPin('9')">9</button>
            <button class="num-btn" onclick="clearPin()" style="font-size:16px; color:#ff6b6b">CLR</button>
            <button class="num-btn" onclick="pressPin('0')">0</button>
            <button class="num-btn submit" onclick="submitPin()"><i class="fas fa-arrow-right"></i></button>
        </div>
        <div class="mt-4 text-white-50 small">Default PIN: 1234</div>
    </div>

    <div class="d-flex">
        <div class="sidebar d-flex flex-column flex-shrink-0 p-3" style="width: 260px;">
            <a href="#" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-decoration-none">
                <span class="fs-4 fw-bold ps-2" style="color:var(--primary)">WSL Admin</span>
            </a>
            <hr>
            <ul class="nav nav-pills flex-column mb-auto" id="pills-tab" role="tablist">
                <li class="nav-item"><button class="nav-link active w-100 text-start" data-bs-toggle="pill" data-bs-target="#tab-menu"><i class="fas fa-bars me-3"></i>Menu Layout</button></li>
                <li class="nav-item"><button class="nav-link w-100 text-start" data-bs-toggle="pill" data-bs-target="#tab-guides"><i class="fas fa-book-open me-3"></i>Panduan Content</button></li>
                <li class="nav-item"><button class="nav-link w-100 text-start" data-bs-toggle="pill" data-bs-target="#tab-duas"><i class="fas fa-hands-praying me-3"></i>Doa Content</button></li>
                <li class="nav-item"><button class="nav-link w-100 text-start" data-bs-toggle="pill" data-bs-target="#tab-hadith"><i class="fas fa-quote-right me-3"></i>Hadith Pool</button></li>
                <li class="nav-item"><button class="nav-link w-100 text-start" data-bs-toggle="pill" data-bs-target="#tab-announce"><i class="fas fa-bullhorn me-3"></i>Announcement</button></li>
            </ul>
        </div>

        <div class="flex-grow-1 p-4">
            <div class="tab-content">
                
                <div class="tab-pane fade show active" id="tab-menu">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Side Panel Menu</h3>
                        <div>
                            <button class="btn btn-warning text-white me-2" onclick="restoreDefaults()"><i class="fas fa-sync-alt me-1"></i> Restore Default Data</button>
                            <button class="btn btn-primary" onclick="addSection()"><i class="fas fa-plus me-1"></i> New Section</button>
                        </div>
                    </div>
                    <div class="alert alert-light border shadow-sm mb-4">
                        <i class="fas fa-info-circle text-primary me-2"></i> This manages buttons in the side panel.
                    </div>
                    <div id="menuContainer">Loading...</div>
                </div>

                <div class="tab-pane fade" id="tab-guides">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Pustaka Panduan Manager</h3>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#contentModal" onclick="setupContentModal('guide')"><i class="fas fa-plus me-1"></i> Add Guide</button>
                    </div>
                    <div id="guideList" class="row g-3">Loading...</div>
                </div>

                <div class="tab-pane fade" id="tab-duas">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Himpunan Doa Manager</h3>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#contentModal" onclick="setupContentModal('dua')"><i class="fas fa-plus me-1"></i> Add Dua</button>
                    </div>
                    <div id="duaList" class="row g-3">Loading...</div>
                </div>

                <div class="tab-pane fade" id="tab-hadith">
                    <h3>Daily Hadith Pool</h3>
                    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#hadithModal"><i class="fas fa-plus"></i> Add Hadith</button>
                    <div id="hadithList"></div>
                </div>

                <div class="tab-pane fade" id="tab-announce">
                    <h3>Home Screen Banner</h3>
                    <div class="card p-4 shadow-sm">
                        <textarea class="form-control mb-3" id="announceText" rows="3" placeholder="Contoh: Selamat Hari Raya Aidilfitri..."></textarea>
                        <div class="form-check form-switch mb-4">
                            <input class="form-check-input" type="checkbox" id="announceActive">
                            <label class="form-check-label" for="announceActive">Show Banner</label>
                        </div>
                        <button class="btn btn-primary" onclick="saveAnnouncement()">Save Changes</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="itemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Edit Button</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="editSectionIndex"><input type="hidden" id="editItemIndex">
                    <div class="mb-2"><label>Label</label><input type="text" class="form-control" id="itemLabel"></div>
                    <div class="mb-2"><label>Icon (FontAwesome)</label><input type="text" class="form-control" id="itemIcon" placeholder="fas fa-book"></div>
                    <div class="mb-2"><label>Type</label><select class="form-select" id="itemType" onchange="toggleAction()"><option value="function">Internal Function</option><option value="link">External Link (URL)</option></select></div>
                    <div class="mb-2" id="fieldFunc"><label>Function Name</label><input type="text" class="form-control" id="itemFunction" placeholder="openExternalPanduan()"></div>
                    <div class="mb-2 d-none" id="fieldLink"><label>URL</label><input type="text" class="form-control" id="itemUrl" placeholder="https://..."></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveItemChange()">Save Changes</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="contentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="contentModalTitle">Edit Content</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="contentId">
                    <input type="hidden" id="contentType"> <div class="mb-3">
                        <label class="fw-bold">Title</label>
                        <input id="contentTitle" class="form-control" placeholder="e.g. Panduan Solat Jenazah">
                    </div>
                    
                    <div class="mb-3">
                        <label class="fw-bold">Icon</label>
                        <input id="contentIcon" class="form-control" placeholder="Emoji (⚰️) or leave blank">
                        <small class="text-muted">You can use an Emoji, URL to PNG image, or leave blank.</small>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold">Content Format</label>
                        <select id="contentFormat" class="form-select" onchange="toggleContentField()">
                            <option value="html">HTML / Text Code</option>
                            <option value="image">Upload Image (Storage)</option>
                            <option value="url">External Link (Redirect)</option>
                        </select>
                    </div>

                    <div class="mb-3" id="fieldHtml">
                        <label class="fw-bold">HTML Content</label>
                        <textarea id="contentHtml" class="form-control" rows="8" placeholder="Type text here... Use <br> for new lines."></textarea>
                    </div>

                    <div class="mb-3 d-none" id="fieldImage">
                        <label class="fw-bold">Upload Image</label>
                        <input type="file" id="contentFile" class="form-control" accept="image/*">
                        <input type="hidden" id="existingImageUrl">
                        <div id="imgPreviewBox"></div>
                        <div id="uploadStatus" class="small text-primary mt-1"></div>
                        <small class="text-muted">Select a file to upload. If editing, leave empty to keep current image.</small>
                    </div>

                    <div class="mb-3 d-none" id="fieldUrl">
                        <label class="fw-bold">External URL</label>
                        <input id="contentUrl" class="form-control" placeholder="https://youtube.com/...">
                        <small class="text-muted">User will be redirected to this link.</small>
                    </div>

                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="btnSaveContent" class="btn btn-primary" onclick="saveContent()">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="hadithModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-body"><textarea id="newHText" class="form-control mb-2" placeholder="Hadith Text"></textarea><input id="newHSource" class="form-control" placeholder="Source (e.g. Bukhari)"></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveNewHadith()">Add</button></div></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // PIN LOCK
        let currentPin = ""; const CORRECT_PIN = "1234";
        function pressPin(n){ if(currentPin.length<4){ currentPin+=n; document.getElementById('pinDisplay').innerHTML='*'.repeat(currentPin.length); } }
        function clearPin(){ currentPin=""; document.getElementById('pinDisplay').innerHTML=""; }
        function submitPin(){ if(currentPin===CORRECT_PIN){ document.getElementById('authOverlay').classList.add('unlocked'); }else{ alert("Incorrect PIN!"); clearPin(); } }

        // FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyBQMVNRDYsKHRj_-bwKbFICyN6XseL3CDI", authDomain: "waktusolatlite.firebaseapp.com", databaseURL: "https://waktusolatlite-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "waktusolatlite", storageBucket: "waktusolatlite.firebasestorage.app", messagingSenderId: "86910439082", appId: "1:86910439082:web:e482d01e1451e58179cad3" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage(); // Init Storage

        // DEFAULT MENU 
        const defaultMenu = [
            { title: "Hadith Collections", items: [ { label: "Sahih Bukhari", type: "function", action: "openHadithCollection('bukhari')", icon: "fas fa-book" }, { label: "Sahih Muslim", type: "function", action: "openHadithCollection('muslim')", icon: "fas fa-book-open" }, { label: "40 Hadith", type: "function", action: "openHadithCollection('nawawi')", icon: "fas fa-scroll" }, { label: "Asbabun Nuzul", type: "function", action: "openHadithCollection('asbabun')", icon: "fas fa-lightbulb" } ] },
            { title: "Panduan & Rujukan", items: [ { label: "Pustaka Panduan", type: "function", action: "openExternalPanduan()", icon: "fas fa-mosque" } ] },
            { title: "Amalan Harian", items: [ { label: "Himpunan Doa", type: "function", action: "openExternalDoa()", icon: "fas fa-hands-praying" } ] }
        ];

        let menuData = [];
        window.onload = function() { loadMenu(); loadGuides(); loadDuas(); loadHadiths(); loadAnnouncement(); }

        function restoreDefaults() {
            if(confirm("Reset menu to default?")) {
                db.ref('dynamicMenu').set(defaultMenu)
                .then(() => alert("Menu restored!"))
                .catch(e => alert(e.message));
            }
        }

        // MENU LOGIC
        function loadMenu() { db.ref('dynamicMenu').on('value', snap => { menuData = snap.val() || []; renderMenu(); }); }
        function renderMenu() {
            const c = document.getElementById('menuContainer'); c.innerHTML = '';
            menuData.forEach((sec, sIdx) => {
                let items = ''; (sec.items||[]).forEach((it, iIdx) => { items += `<div class="item-row"><div><i class="${it.icon} text-primary me-2"></i>${it.label}</div><div><button class="btn btn-sm btn-light border" onclick="editItem(${sIdx},${iIdx})">Edit</button></div></div>`; });
                c.innerHTML += `<div class="card p-3"><h5>${sec.title}</h5>${items}</div>`;
            });
        }
        
        window.addSection=()=>db.ref('dynamicMenu').set([...menuData, {title:"New Section", items:[]}]);
        window.addItem=(s)=>setupModal(s,'new'); window.editItem=(s,i)=>setupModal(s,i);
        function setupModal(s,i){
            document.getElementById('editSectionIndex').value=s; document.getElementById('editItemIndex').value=i;
            const item=(i==='new')?{label:'',icon:'',type:'function',action:''}:menuData[s].items[i];
            document.getElementById('itemLabel').value=item.label; document.getElementById('itemIcon').value=item.icon; document.getElementById('itemType').value=item.type;
            toggleAction();
            if(item.type==='link') document.getElementById('itemUrl').value=item.action; else document.getElementById('itemFunction').value=item.action;
            new bootstrap.Modal(document.getElementById('itemModal')).show();
        }
        window.toggleAction=()=>{const t=document.getElementById('itemType').value;document.getElementById('fieldLink').classList.toggle('d-none',t!=='link');document.getElementById('fieldFunc').classList.toggle('d-none',t!=='function')};
        window.saveItemChange=()=>{
            const s=document.getElementById('editSectionIndex').value, i=document.getElementById('editItemIndex').value, t=document.getElementById('itemType').value;
            const act=t==='link'?document.getElementById('itemUrl').value:document.getElementById('itemFunction').value;
            const obj={label:document.getElementById('itemLabel').value,icon:document.getElementById('itemIcon').value,type:t,action:act};
            if(!menuData[s].items)menuData[s].items=[]; if(i==='new')menuData[s].items.push(obj); else menuData[s].items[i]=obj;
            db.ref('dynamicMenu').set(menuData); bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
        }

        // --- UNIFIED CONTENT MANAGER (GUIDES & DUAS) ---
        function loadGuides() { loadContent('guides', 'guideList', 'guide'); }
        function loadDuas() { loadContent('duas_content', 'duaList', 'dua'); }

        function loadContent(dbPath, elementId, type) {
            db.ref(dbPath).on('value', snap => {
                const list = document.getElementById(elementId); list.innerHTML = '';
                if(!snap.exists()) return;
                snap.forEach(c => { 
                    const g=c.val(); 
                    let iconDisplay = g.icon;
                    if(g.icon && g.icon.startsWith('http')) {
                        iconDisplay = `<img src="${g.icon}" style="width:24px; height:24px; object-fit:contain;">`;
                    }
                    
                    list.innerHTML += `
                        <div class="col-md-6">
                            <div class="card p-3">
                                <h5>${iconDisplay} ${g.title}</h5>
                                <div class="text-muted small mb-2">${g.format || 'html'}</div>
                                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="editContent('${dbPath}', '${c.key}', '${type}')">Edit Content</button>
                                <button class="btn btn-sm btn-outline-danger mt-2 ms-1" onclick="deleteContent('${dbPath}', '${c.key}')">Delete</button>
                            </div>
                        </div>`; 
                });
            });
        }

        window.setupContentModal = (type) => {
            document.getElementById('contentType').value = type;
            document.getElementById('contentId').value = '';
            document.getElementById('contentTitle').value = '';
            document.getElementById('contentIcon').value = '';
            document.getElementById('contentFormat').value = 'html';
            toggleContentField();
            
            // Clear fields
            document.getElementById('contentHtml').value = '';
            document.getElementById('contentFile').value = ''; // Clear file input
            document.getElementById('existingImageUrl').value = '';
            document.getElementById('imgPreviewBox').innerHTML = '';
            document.getElementById('uploadStatus').innerHTML = '';
            document.getElementById('contentUrl').value = '';
            
            document.getElementById('contentModalTitle').textContent = type === 'guide' ? 'Add Guide' : 'Add Dua';
        }

        window.toggleContentField = () => {
            const fmt = document.getElementById('contentFormat').value;
            document.getElementById('fieldHtml').classList.toggle('d-none', fmt !== 'html');
            document.getElementById('fieldImage').classList.toggle('d-none', fmt !== 'image');
            document.getElementById('fieldUrl').classList.toggle('d-none', fmt !== 'url');
        }

        window.editContent = (dbPath, key, type) => {
            db.ref(dbPath + '/' + key).once('value').then(s => {
                const v = s.val();
                document.getElementById('contentType').value = type;
                document.getElementById('contentId').value = key;
                document.getElementById('contentTitle').value = v.title;
                document.getElementById('contentIcon').value = v.icon || '';
                document.getElementById('contentFormat').value = v.format || 'html';
                toggleContentField();
                
                // Clear all
                document.getElementById('contentHtml').value = '';
                document.getElementById('contentFile').value = '';
                document.getElementById('existingImageUrl').value = '';
                document.getElementById('imgPreviewBox').innerHTML = '';
                document.getElementById('uploadStatus').innerHTML = '';
                document.getElementById('contentUrl').value = '';

                if(v.format === 'image') {
                    document.getElementById('existingImageUrl').value = v.content;
                    document.getElementById('imgPreviewBox').innerHTML = `<img src="${v.content}">`;
                }
                else if(v.format === 'url') {
                    document.getElementById('contentUrl').value = v.content;
                }
                else {
                    document.getElementById('contentHtml').value = v.content;
                }

                document.getElementById('contentModalTitle').textContent = 'Edit ' + (type === 'guide' ? 'Guide' : 'Dua');
                new bootstrap.Modal(document.getElementById('contentModal')).show();
            });
        }

        window.saveContent = async () => {
            const btn = document.getElementById('btnSaveContent');
            const statusDiv = document.getElementById('uploadStatus');
            
            // Lock button
            btn.disabled = true;
            btn.innerHTML = 'Saving...';

            try {
                const type = document.getElementById('contentType').value;
                const dbPath = type === 'guide' ? 'guides' : 'duas_content';
                const k = document.getElementById('contentId').value;
                const fmt = document.getElementById('contentFormat').value;
                
                let contentVal = '';
                
                if(fmt === 'html') {
                    contentVal = document.getElementById('contentHtml').value;
                } 
                else if(fmt === 'image') {
                    const fileInput = document.getElementById('contentFile');
                    // Check if new file selected
                    if(fileInput.files.length > 0) {
                        statusDiv.innerHTML = "Uploading image...";
                        const file = fileInput.files[0];
                        const storageRef = storage.ref('content_images/' + Date.now() + '_' + file.name);
                        
                        // Upload
                        const snapshot = await storageRef.put(file);
                        contentVal = await snapshot.ref.getDownloadURL();
                    } else {
                        // Use existing
                        contentVal = document.getElementById('existingImageUrl').value;
                        if(!contentVal) {
                            throw new Error("Please select an image to upload.");
                        }
                    }
                } 
                else if(fmt === 'url') {
                    contentVal = document.getElementById('contentUrl').value;
                }

                const d = {
                    title: document.getElementById('contentTitle').value,
                    icon: document.getElementById('contentIcon').value,
                    format: fmt,
                    content: contentVal
                };

                if(k) await db.ref(dbPath + '/' + k).update(d);
                else await db.ref(dbPath).push(d);
                
                bootstrap.Modal.getInstance(document.getElementById('contentModal')).hide();

            } catch (error) {
                alert("Error: " + error.message);
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Save';
                statusDiv.innerHTML = '';
            }
        }

        window.deleteContent = (dbPath, key) => {
            if(confirm("Delete this content?")) db.ref(dbPath + '/' + key).remove();
        }

        // ... (Keep Hadith/Announcement logic) ...
        function loadHadiths(){db.ref('hadiths').on('value',s=>{const d=document.getElementById('hadithList');d.innerHTML='';s.forEach(x=>{d.innerHTML+=`<div class="item-row"><span>${x.val().text.substr(0,30)}...</span><button class="btn btn-sm btn-danger" onclick="db.ref('hadiths/${x.key}').remove()">X</button></div>`})})}
        window.saveNewHadith=()=>{db.ref('hadiths').push({text:document.getElementById('newHText').value,source:document.getElementById('newHSource').value});bootstrap.Modal.getInstance(document.getElementById('hadithModal')).hide()}
        function loadAnnouncement(){db.ref('announcement').on('value',s=>{const v=s.val()||{};document.getElementById('announceText').value=v.text||'';document.getElementById('announceActive').checked=v.show})}
        window.saveAnnouncement=()=>{db.ref('announcement').set({text:document.getElementById('announceText').value,show:document.getElementById('announceActive').checked})}
    </script>
</body>
</html>
