<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSL Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background-color: #1a1a1a; color: #f3f4f6; }
        .card { background-color: #2a2a2a; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        #map { height: 500px; width: 100%; border-radius: 12px; z-index: 1; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-yellow-500">WaktuSolatLite Analytics</h1>
            <div class="text-sm text-gray-400">Status: <span id="statusIndicator" class="text-yellow-500">Connecting...</span></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card">
                <div class="text-gray-400 text-sm mb-1">Total Installs</div>
                <div class="text-4xl font-bold" id="totalUsers">0</div>
            </div>
            <div class="card">
                <div class="text-gray-400 text-sm mb-1">Active (Last 24h)</div>
                <div class="text-4xl font-bold text-green-500" id="activeUsers">0</div>
            </div>
            <div class="card">
                <div class="text-gray-400 text-sm mb-1">Latest Activity</div>
                <div class="text-lg font-mono" id="lastActivity">-</div>
            </div>
        </div>

        <div class="card mb-8">
            <h2 class="text-xl font-bold mb-4">User Distributions</h2>
            <div id="map"></div>
        </div>

        <div class="card">
            <h2 class="text-xl font-bold mb-4">Recent Users</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-gray-500 border-b border-gray-700">
                            <th class="p-3">Install ID</th>
                            <th class="p-3">Device</th>
                            <th class="p-3">Coords</th>
                            <th class="p-3">Last Active</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody" class="text-sm">
                        <tr><td colspan="4" class="p-3 text-center text-gray-500">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBQMVNRDYsKHRj_-bwKbFICyN6XseL3CDI",
            authDomain: "waktusolatlite.firebaseapp.com",
            projectId: "waktusolatlite",
            storageBucket: "waktusolatlite.firebasestorage.app",
            messagingSenderId: "86910439082",
            appId: "1:86910439082:web:e482d01e1451e58179cad3"
        };

        // Initialize Map
        const map = L.map('map').setView([3.1390, 101.6869], 6); 
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        const markers = [];

        try {
            // Initialize Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const statusEl = document.getElementById('statusIndicator');

            statusEl.textContent = "Live";
            statusEl.className = "text-green-500";

            // Listen for data
            db.ref('users').on('value', (snapshot) => {
                const users = snapshot.val();
                
                if (!users) {
                    document.getElementById('totalUsers').textContent = "0";
                    document.getElementById('activeUsers').textContent = "0";
                    document.getElementById('userTableBody').innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">No users found yet. Open the app to generate data.</td></tr>';
                    return;
                }

                const userList = Object.keys(users).map(key => ({ id: key, ...users[key] }));
                
                // Sort by last active (newest first)
                userList.sort((a, b) => (b.lastActive || 0) - (a.lastActive || 0));

                // Update Stats
                document.getElementById('totalUsers').textContent = userList.length;
                
                const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
                const activeCount = userList.filter(u => u.lastActive && u.lastActive > oneDayAgo).length;
                document.getElementById('activeUsers').textContent = activeCount;
                
                if(userList.length > 0 && userList[0].lastActive) {
                    document.getElementById('lastActivity').textContent = new Date(userList[0].lastActive).toLocaleTimeString();
                }

                // Update Table
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';
                userList.slice(0, 20).forEach(u => { // Show top 20
                    const date = u.lastActive ? new Date(u.lastActive).toLocaleString() : 'Never';
                    const shortId = u.id.substring(0, 8) + '...';
                    const latLon = u.lat && u.lon ? `${u.lat.toFixed(4)}, ${u.lon.toFixed(4)}` : 'Hidden/N/A';
                    
                    const row = `
                        <tr class="border-b border-gray-800 hover:bg-white/5">
                            <td class="p-3 font-mono text-yellow-600">${shortId}</td>
                            <td class="p-3 text-gray-300">${u.device || 'Unknown'}</td>
                            <td class="p-3 font-mono text-gray-400">${latLon}</td>
                            <td class="p-3 text-gray-400">${date}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                // Update Map Markers
                markers.forEach(m => map.removeLayer(m));
                markers.length = 0;

                userList.forEach(u => {
                    if (u.lat && u.lon) {
                        const marker = L.circleMarker([u.lat, u.lon], {
                            radius: 6,
                            fillColor: "#eab308", // Yellow-500
                            color: "#fff",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(map);
                        
                        const dateStr = u.lastActive ? new Date(u.lastActive).toLocaleDateString() : 'Unknown';
                        marker.bindPopup(`<b>User:</b> ${u.id.substring(0,6)}...<br><b>Last Seen:</b> ${dateStr}`);
                        markers.push(marker);
                    }
                });
            }, (error) => {
                console.error(error);
                statusEl.textContent = "Error: " + error.message;
                statusEl.className = "text-red-500";
            });

        } catch (e) {
            console.error("Firebase Error:", e);
            document.getElementById('statusIndicator').textContent = "Config Error";
            document.getElementById('statusIndicator').className = "text-red-500";
        }
    </script>
</body>
</html>
