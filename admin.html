<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mukmin Admin (Realtime)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; margin: 0; padding: 20px; color: #1f2937; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; color: #A67734; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-val { font-size: 24px; font-weight: 800; }
        .stat-lbl { font-size: 11px; text-transform: uppercase; color: #6b7280; font-weight: 700; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th { background: #f9fafb; padding: 12px; font-size: 11px; text-transform: uppercase; text-align: left; color: #6b7280; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 13px; }
        .badge { padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; }
        .badge-app { background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Admin Dashboard</h1>
        <button onclick="location.reload()" style="padding:8px 16px; background:#A67734; color:white; border:none; border-radius:8px; cursor:pointer;">Refresh</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><div class="stat-lbl">Users</div><div class="stat-val" id="countUsers">0</div></div>
        <div class="stat-card"><div class="stat-lbl">Installs</div><div class="stat-val" id="countInstalls">0</div></div>
        <div class="stat-card"><div class="stat-lbl">Sessions</div><div class="stat-val" id="countSessions">0</div></div>
    </div>

    <table>
        <thead><tr><th>User ID</th><th>Status</th><th>Visits</th><th>Last Seen</th><th>Device</th></tr></thead>
        <tbody id="tableBody"><tr><td colspan="5" style="text-align:center; padding:20px;">Loading...</td></tr></tbody>
    </table>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQMVNRDYsKHRj_-bwKbFICyN6XseL3CDI",
            authDomain: "waktusolatlite.firebaseapp.com",
            databaseURL: "https://waktusolatlite-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "waktusolatlite",
            storageBucket: "waktusolatlite.firebasestorage.app",
            messagingSenderId: "86910439082",
            appId: "1:86910439082:web:e482d01e1451e58179cad3"
        };

        const app = initializeApp(firebaseConfig);
        const dbRef = ref(getDatabase(app));

        get(child(dbRef, `users`)).then((snapshot) => {
            if (snapshot.exists()) {
                const users = snapshot.val();
                let uCount = 0, iCount = 0, sCount = 0;
                let rows = '';

                // Convert object to array and sort by lastActive (newest first)
                const userList = Object.entries(users).sort((a,b) => b[1].lastActive - a[1].lastActive);

                userList.forEach(([key, u]) => {
                    uCount++;
                    if(u.isInstalled) iCount++;
                    sCount += (u.sessionCount || 0);
                    
                    const time = u.lastActive ? new Date(u.lastActive).toLocaleString() : '-';
                    const badge = u.isInstalled ? '<span class="badge badge-app">APP</span>' : '<span style="opacity:0.5">WEB</span>';
                    
                    rows += `<tr>
                        <td style="font-family:monospace">${key.substring(0,8)}...</td>
                        <td>${badge}</td>
                        <td><b>${u.sessionCount||1}</b></td>
                        <td style="color:#666">${time}</td>
                        <td style="color:#666; font-size:11px;">${u.platform}</td>
                    </tr>`;
                });

                document.getElementById('countUsers').textContent = uCount;
                document.getElementById('countInstalls').textContent = iCount;
                document.getElementById('countSessions').textContent = sCount;
                document.getElementById('tableBody').innerHTML = rows;
            } else {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="5" style="text-align:center">No data found</td></tr>';
            }
        }).catch((error) => {
            console.error(error);
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="5" style="color:red; text-align:center">Error loading data</td></tr>';
        });
    </script>
</body>
</html>
