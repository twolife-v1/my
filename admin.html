<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaktuSolatLite Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; }
        .glass { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 24px; }
        
        /* PIN Overlay Styles */
        #pinOverlay { position: fixed; inset: 0; background: #111827; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
        .pin-input { font-size: 32px; letter-spacing: 12px; text-align: center; width: 240px; padding: 15px; border-radius: 16px; border: 2px solid #374151; background: #1F2937; color: white; outline: none; transition: 0.3s; }
        .pin-input:focus { border-color: #A67734; box-shadow: 0 0 20px rgba(166, 119, 52, 0.4); }
    </style>
</head>
<body>

    <div id="pinOverlay">
        <div class="text-white font-bold text-2xl mb-6 tracking-widest">ADMIN ACCESS</div>
        <input type="password" id="pinInput" class="pin-input" maxlength="4" placeholder="••••" autofocus inputmode="numeric">
        <div id="pinError" class="text-red-500 mt-4 text-sm font-semibold opacity-0 transition-opacity">Access Denied</div>
    </div>

    <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
        <aside class="w-full md:w-64 bg-gray-900 text-white flex-shrink-0 shadow-xl z-20">
            <div class="p-6 font-bold text-xl text-amber-500 tracking-wider border-b border-gray-800">MUKMIN ADMIN</div>
            <nav class="p-4 space-y-2">
                <div class="block py-3 px-4 bg-gray-800 rounded-lg text-white font-semibold flex items-center gap-3">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    Analytics
                </div>
                <button onclick="lockScreen()" class="w-full text-left py-3 px-4 text-red-400 hover:text-red-300 hover:bg-gray-800 rounded-lg transition flex items-center gap-3 mt-8">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Lock Screen
                </button>
            </nav>
        </aside>

        <main class="flex-1 p-6 md:p-10 overflow-y-auto bg-gray-50">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-extrabold text-gray-800">Overview</h1>
                    <p class="text-gray-500 text-sm mt-1">Real-time app performance</p>
                </div>
                <button onclick="loadData()" id="refreshBtn" class="bg-white px-5 py-2.5 rounded-xl shadow-sm border border-gray-200 text-sm font-semibold hover:bg-gray-50 active:scale-95 transition flex items-center gap-2 text-gray-700">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                    Refresh Data
                </button>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="glass border-l-4 border-green-500 relative overflow-hidden group hover:shadow-lg transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider">Online Now</div>
                            <div class="text-4xl font-extrabold text-gray-900 mt-2" id="stat-online">0</div>
                            <div class="text-xs text-green-600 font-medium mt-1">Active (15m)</div>
                        </div>
                        <div class="p-2 bg-green-50 rounded-lg text-green-600">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        </div>
                    </div>
                    <div class="absolute right-3 top-3 w-3 h-3 bg-green-500 rounded-full animate-ping opacity-75"></div>
                </div>

                <div class="glass border-l-4 border-blue-500 hover:shadow-lg transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider">Total Installs</div>
                            <div class="text-4xl font-extrabold text-gray-900 mt-2" id="stat-installs">0</div>
                            <div class="text-xs text-blue-600 font-medium mt-1">App Installed</div>
                        </div>
                        <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        </div>
                    </div>
                </div>

                <div class="glass border-l-4 border-amber-500 hover:shadow-lg transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider">Total Views</div>
                            <div class="text-4xl font-extrabold text-gray-900 mt-2" id="stat-views">0</div>
                            <div class="text-xs text-amber-600 font-medium mt-1">Page Opens</div>
                        </div>
                        <div class="p-2 bg-amber-50 rounded-lg text-amber-600">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </div>
                    </div>
                </div>

                <div class="glass border-l-4 border-purple-500 hover:shadow-lg transition">
                    <div class="flex justify-between items-start">
                        <div class="overflow-hidden">
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider">Top Feature</div>
                            <div class="text-xl font-extrabold text-gray-900 mt-3 truncate" id="stat-top">...</div>
                            <div class="text-xs text-purple-600 font-medium mt-1">Most Clicked</div>
                        </div>
                        <div class="p-2 bg-purple-50 rounded-lg text-purple-600 flex-shrink-0">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="glass h-80">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                        Feature Usage
                    </h3>
                    <div class="h-64 flex items-center justify-center">
                         <canvas id="featureChart"></canvas>
                    </div>
                </div>
                <div class="glass h-80">
                    <h3 class="font-bold text-gray-700 mb-4">Activity Trend (Recent)</h3>
                    <div class="h-64">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">Live Feed (Last 10 Events)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 rounded-l-lg">Time</th>
                                <th class="py-3 px-4">Type</th>
                                <th class="py-3 px-4 rounded-r-lg">Details</th>
                            </tr>
                        </thead>
                        <tbody id="logsBody" class="text-sm divide-y">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- YOUR FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBQMVNRDYsKHRj_-bwKbFICyN6XseL3CDI",
            authDomain: "waktusolatlite.firebaseapp.com",
            databaseURL: "https://waktusolatlite-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "waktusolatlite",
            storageBucket: "waktusolatlite.firebasestorage.app",
            messagingSenderId: "86910439082",
            appId: "1:86910439082:web:e482d01e1451e58179cad3"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- PIN LOGIC ---
        const pinInput = document.getElementById('pinInput');
        const pinError = document.getElementById('pinError');
        
        // Auto-focus and check PIN
        pinInput.addEventListener('input', (e) => {
            if(e.target.value === '1234') {
                unlockDashboard();
                e.target.blur();
            } else if (e.target.value.length === 4) {
                pinError.classList.remove('opacity-0');
                pinInput.style.borderColor = "#EF4444";
                e.target.value = '';
                setTimeout(() => {
                    pinError.classList.add('opacity-0');
                    pinInput.style.borderColor = "#374151";
                }, 2000);
            }
        });

        function unlockDashboard() {
            document.getElementById('pinOverlay').classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => document.getElementById('pinOverlay').style.display = 'none', 300);
            document.getElementById('dashboard').classList.remove('hidden');
            loadData();
        }

        function lockScreen() {
            const ol = document.getElementById('pinOverlay');
            ol.style.display = 'flex';
            // Slight delay to allow display flex to apply before opacity transition
            requestAnimationFrame(() => {
                ol.classList.remove('opacity-0', 'pointer-events-none');
                document.getElementById('dashboard').classList.add('hidden');
                pinInput.value = '';
                pinInput.focus();
            });
        }

        // --- DATA LOGIC ---
        async function loadData() {
            const btn = document.getElementById('refreshBtn');
            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Loading...`;
            
            try {
                // 1. Fetch recent logs (Limit 300 for calculation)
                const snap = await db.collection('analytics').orderBy('timestamp', 'desc').limit(300).get();
                const docs = snap.docs.map(d => d.data());

                // 2. Calculate Stats
                let totalViews = 0;
                let totalInstalls = 0;
                let featureCounts = {};
                let onlineUsers = new Set();
                const now = new Date();
                const fifteenMinsAgo = new Date(now - 15 * 60 * 1000);

                docs.forEach(d => {
                    if(!d.timestamp) return;
                    const date = new Date(d.timestamp.seconds * 1000);

                    // Online Count (Active in last 15 mins)
                    if (date > fifteenMinsAgo && d.visitorId) {
                        onlineUsers.add(d.visitorId);
                    }

                    // Event Type Counts
                    if(d.type === 'page_view') totalViews++;
                    if(d.type === 'install') totalInstalls++;
                    
                    // Feature Ranking
                    if(d.type === 'feature_click' && d.feature) {
                        featureCounts[d.feature] = (featureCounts[d.feature] || 0) + 1;
                    }
                });

                // 3. Update DOM
                animateValue("stat-online", 0, onlineUsers.size, 1000);
                animateValue("stat-views", 0, totalViews, 1000); // Note: This is views within the limit 300
                animateValue("stat-installs", 0, totalInstalls, 1000);

                // Find Top Feature
                let topF = "None"; let max = 0;
                for(let [k,v] of Object.entries(featureCounts)) { if(v > max) { max = v; topF = k; } }
                document.getElementById('stat-top').textContent = topF;

                // 4. Update Logs Table
                const tbody = document.getElementById('logsBody');
                tbody.innerHTML = '';
                docs.slice(0, 10).forEach(d => { // Show top 10
                    const t = new Date(d.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    let typeColor = 'text-gray-800';
                    if(d.type === 'install') typeColor = 'text-blue-600 font-bold';
                    if(d.type === 'feature_click') typeColor = 'text-purple-600';
                    
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-100 transition">
                            <td class="py-3 px-4 text-gray-500 font-mono text-xs">${t}</td>
                            <td class="py-3 px-4 font-medium ${typeColor}">${d.type.replace('_', ' ')}</td>
                            <td class="py-3 px-4 text-gray-500">${d.feature || d.details || '-'}</td>
                        </tr>`;
                });

                // 5. Render Charts
                renderFeatureChart(featureCounts);
                renderTrendChart(docs);

            } catch (e) {
                console.error(e);
                alert("Error loading data. Check console.");
            } finally {
                btn.innerHTML = `<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg> Refresh Data`;
            }
        }

        // Helper: Number Animation
        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            const timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) clearInterval(timer);
            }, Math.max(stepTime, 20)); // Min 20ms step
        }

        let fChart, tChart;
        
        function renderFeatureChart(data) {
            const ctx = document.getElementById('featureChart').getContext('2d');
            if(fChart) fChart.destroy();
            
            // Generate clean labels and data
            const labels = Object.keys(data);
            const vals = Object.values(data);
            
            fChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: vals,
                        backgroundColor: ['#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#6366F1'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: {family: "'Inter', sans-serif"} } }
                    }
                }
            });
        }

        function renderTrendChart(docs) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(tChart) tChart.destroy();

            // Bucket by Hour (Last 24h simplified)
            const hours = {};
            docs.forEach(d => {
                if(!d.timestamp) return;
                const date = new Date(d.timestamp.seconds * 1000);
                const h = date.getHours() + ":00";
                hours[h] = (hours[h] || 0) + 1;
            });
            
            // Sort buckets crudely for display (Better logic would be full time series)
            const labels = Object.keys(hours).reverse().slice(0, 7); // Show last 7 active hours found
            const data = labels.map(l => hours[l]);

            tChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Events',
                        data: data,
                        backgroundColor: '#A67734',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, grid: {display:false} }, x: { grid: {display:false} } },
                    plugins: { legend: {display: false} }
                }
            });
        }
    </script>
</body>
</html>
