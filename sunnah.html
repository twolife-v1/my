<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#A67734">
    <title>Sunnah Ultimate - Mukmin.com</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* --- CORE THEME --- */
        :root[data-theme="light"] { --primary:#A67734; --primary-light:#FDF8F0; --bg:#F8F9FA; --surface:#FFFFFF; --text:#1F2937; --text-muted:#6B7280; --border:#E5E7EB; --shadow:0 10px 30px -10px rgba(0,0,0,0.1); }
        :root[data-theme="dark"] { --primary:#D4AF37; --primary-light:#2A2012; --bg:#121212; --surface:#1E1E1E; --text:#F3F4F6; --text-muted:#9CA3AF; --border:#374151; --shadow:0 10px 30px -10px rgba(0,0,0,0.5); }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 80px; transition: background 0.3s; }

        /* HEADER */
        .header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            background: rgba(var(--surface), 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 10px 20px; padding-top: max(10px, env(safe-area-inset-top));
            display: flex; align-items: center; justify-content: space-between;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-title { font-weight: 800; font-size: 18px; }
        .back-btn { background: none; border: none; color: var(--text); font-size: 24px; padding: 0; cursor: pointer; }
        
        .header-right { display: flex; gap: 8px; }
        .icon-btn-glass { 
            background: rgba(150, 150, 150, 0.1); border: 1px solid var(--border); 
            color: var(--text); width: 36px; height: 36px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
            font-size: 11px; font-weight: 700; transition: all 0.2s;
        }

        /* SEARCH BAR */
        .search-container {
            position: sticky; top: calc(55px + env(safe-area-inset-top)); z-index: 90;
            background: var(--bg); padding: 10px 20px;
            transition: top 0.3s;
        }
        .search-input {
            width: 100%; padding: 12px 40px 12px 15px; border-radius: 12px;
            border: 1px solid var(--border); background: var(--surface);
            color: var(--text); font-family: inherit; font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); outline: none;
        }
        .search-icon {
            position: absolute; right: 35px; top: 50%; transform: translateY(-50%);
            color: var(--text-muted); pointer-events: none;
        }

        /* CATEGORY CHIPS */
        .category-scroll {
            display: flex; gap: 8px; overflow-x: auto; padding: 0 20px 15px 20px;
            scrollbar-width: none;
        }
        .category-scroll::-webkit-scrollbar { display: none; }
        .chip {
            white-space: nowrap; padding: 8px 14px; border-radius: 20px;
            font-size: 12px; font-weight: 600; border: 1px solid var(--border);
            background: var(--surface); color: var(--text-muted); cursor: pointer;
            transition: all 0.2s;
        }
        .chip.active {
            background: var(--primary); color: #fff; border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(166, 119, 52, 0.3);
        }

        /* HERO CARD */
        .quote-hero {
            background: linear-gradient(135deg, var(--primary) 0%, #8a622a 100%);
            color: #fff; padding: 25px; border-radius: 24px; margin: 20px;
            position: relative; overflow: hidden; display: flex; flex-direction: column; gap: 15px;
            min-height: 180px; justify-content: space-between; box-shadow: 0 10px 30px rgba(166, 119, 52, 0.3);
        }
        .quote-text { 
            font-family: 'Amiri', serif; font-size: 18px; line-height: 1.6; z-index: 2; 
            transition: opacity 0.3s ease; 
        }
        .btn-random {
            align-self: flex-start; background: rgba(255,255,255,0.2); 
            border: 1px solid rgba(255,255,255,0.3); color: white;
            padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 700;
            cursor: pointer; backdrop-filter: blur(4px); z-index: 2;
            display: flex; align-items: center; gap: 6px;
            transition: transform 0.2s;
        }
        .btn-random:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }

        /* SUNNAH CARDS */
        .container { padding: 0 20px; display: grid; gap: 12px; }
        .sunnah-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 16px; padding: 16px;
            display: flex; gap: 15px; align-items: flex-start;
            animation: fadeIn 0.4s ease; cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        .sunnah-card:active { transform: scale(0.97); background: var(--bg); }
        
        .icon-box {
            width: 40px; height: 40px; border-radius: 10px;
            background: var(--primary-light); color: var(--primary);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; flex-shrink: 0;
        }
        .card-content { flex: 1; pointer-events: none; }
        .card-header-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .card-title { font-weight: 800; font-size: 15px; color: var(--text); }
        .card-cat { font-size: 10px; text-transform: uppercase; color: var(--primary); font-weight: 700; background: rgba(166,119,52,0.1); padding: 2px 6px; border-radius: 4px; height: fit-content; }
        .card-body { 
            font-size: 13px; line-height: 1.5; color: var(--text-muted); 
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- FLOATING MODAL STYLES --- */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 2000;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center;
            padding: 20px; animation: fadeIn 0.2s ease;
        }
        .modal-overlay.open { display: flex; }

        .modal-card {
            width: 100%; max-width: 360px;
            background: var(--surface); border-radius: 28px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center; text-align: center;
            padding: 30px 25px; position: relative;
            transform: scale(0.9); opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.open .modal-card { transform: scale(1); opacity: 1; }

        .modal-icon-wrapper {
            width: 70px; height: 70px; border-radius: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, #8a622a 100%);
            color: #fff; font-size: 32px; display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px; box-shadow: 0 10px 20px rgba(166, 119, 52, 0.3);
        }

        .modal-title { font-size: 20px; font-weight: 800; color: var(--text); margin-bottom: 5px; line-height: 1.3; }
        .modal-cat { 
            font-size: 10px; text-transform: uppercase; letter-spacing: 1px; 
            font-weight: 700; color: var(--text-muted); margin-bottom: 20px; 
            background: var(--bg); padding: 4px 10px; border-radius: 20px;
        }
        .modal-body { font-size: 15px; line-height: 1.6; color: var(--text); margin-bottom: 20px; }
        .modal-ref { 
            font-size: 12px; font-weight: 600; color: var(--primary); 
            background: var(--primary-light); padding: 8px 16px; border-radius: 12px;
            margin-bottom: 25px; display: inline-block;
        }

        /* Actions container - Hidden during screenshot */
        .modal-actions { display: flex; width: 100%; gap: 10px; }
        
        .btn-modal { 
            flex: 1; padding: 12px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; 
            font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--text); color: var(--bg); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        
        .btn-close-abs {
            position: absolute; top: 15px; right: 15px;
            background: var(--bg); border: none; width: 32px; height: 32px;
            border-radius: 50%; color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* Branding shown ONLY during screenshot */
        .screenshot-brand {
            display: none; /* Hidden normally */
            margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px; width: 100%;
        }
        .brand-flex { display: flex; justify-content: space-between; align-items: center; }
        .brand-name { font-size: 12px; font-weight: 800; color: var(--primary); letter-spacing: 1px; text-transform: uppercase; }
        .brand-sub { font-size: 10px; color: var(--text-muted); opacity: 0.8; }

        /* TOAST */
        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.9); color: white; padding: 12px 24px; border-radius: 30px;
            font-size: 13px; font-weight: 600; transition: all 0.3s; z-index: 3000; opacity: 0;
        }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-left">
            <button class="back-btn" onclick="window.location.href='indexx.html'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <div class="header-title">Sunnah Ultimate</div>
        </div>
        <div class="header-right">
            <button class="icon-btn-glass" onclick="toggleLang()" id="langBtn">EN</button>
            <button class="icon-btn-glass" onclick="toggleTheme()">
                <svg id="themeIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="5"></circle>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
                </svg>
            </button>
        </div>
    </header>

    <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="Search Sunnah..." onkeyup="filterList()">
        <div class="search-icon">üîç</div>
    </div>

    <div class="category-scroll" id="chipContainer"></div>

    <div class="quote-hero">
        <div style="position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.1;">‚ú®</div>
        <div class="quote-text" id="heroQuote">...</div>
        <button class="btn-random" onclick="showRandom()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg>
            <span id="btnRandomTxt">Discover Random Sunnah</span>
        </button>
    </div>

    <div class="container" id="sunnahList"></div>
    <div style="text-align:center; padding: 20px; opacity: 0.5; font-size: 11px;" id="countDisplay"></div>

    <div id="detailModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-card screenshot-target" onclick="event.stopPropagation()">
            
            <button class="btn-close-abs" onclick="closeModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            
            <div class="modal-icon-wrapper" id="mIcon">‚ú®</div>
            <div class="modal-title" id="mTitle">Title</div>
            <div class="modal-cat" id="mCat">Category</div>
            <div class="modal-body" id="mBody">Description goes here...</div>
            <div class="modal-ref" id="mRef">Ref: Bukhari</div>
            
            <div class="screenshot-brand" id="brandWatermark">
                <div class="brand-flex">
                    <div class="brand-name">MUKMIN.COM</div>
                    <div class="brand-sub">Daily Sunnah</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn-modal btn-outline" onclick="copyModalContent()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    Copy
                </button>
                <button class="btn-modal btn-primary" onclick="shareScreenshot()" id="btnShare">
                    <span id="shareSpin" style="display:none; width:16px; height:16px; border:2px solid rgba(255,255,255,0.3); border-top:2px solid #fff; border-radius:50%; animation:spin 1s linear infinite;"></span>
                    <span id="shareIcon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                    </span>
                    <span id="shareTxt">Share Card</span>
                </button>
            </div>
        </div>
    </div>

    <div id="toast">Copied!</div>

<script src="sunnah-data.js"></script>
<script>
    const STATE = {
        theme: localStorage.getItem('wsl_theme') || 'light',
        lang: localStorage.getItem('wsl_lang') || 'en',
        db: typeof SUNNAH_DB_SOURCE !== 'undefined' ? SUNNAH_DB_SOURCE : []
    };

    const TRANSLATIONS = {
        en: {
            title: "Sunnah Ultimate",
            searchPlaceholder: "Search (e.g. Sleep, Eat)...",
            randomBtn: "Random Sunnah",
            heroQuote: "Whoever revives a Sunnah from my Sunnah and the people practice it, will have a reward similar to those who practice it...",
            cats: { all: "All", daily: "Daily", social: "Social", eating: "Food", sleep: "Sleep", ibadah: "Worship", hygiene: "Hygiene", friday: "Friday", travel: "Travel", general: "General" },
            count: "Items",
            error: "Data source missing. Please check sunnah-data.js",
            shareTitle: "Sunnah Reminder",
            shareText: "Check out this Sunnah from Mukmin.com",
            shareBtn: "Share Card"
        },
        ms: {
            title: "Sunnah Teragung",
            searchPlaceholder: "Cari (cth: Tidur, Makan)...",
            randomBtn: "Sunnah Rawak",
            heroQuote: "Barangsiapa yang menghidupkan satu Sunnah daripada Sunnah-Sunnahku... dia akan beroleh pahala seperti pengamalnya.",
            cats: { all: "Semua", daily: "Harian", social: "Adab", eating: "Makan", sleep: "Tidur", ibadah: "Ibadah", hygiene: "Kebersihan", friday: "Jumaat", travel: "Musafir", general: "Umum" },
            count: "Item",
            error: "Data hilang. Sila semak sunnah-data.js",
            shareTitle: "Peringatan Sunnah",
            shareText: "Jom amalkan Sunnah ini dari Mukmin.com",
            shareBtn: "Kongsi Kad"
        }
    };

    let currentFilter = 'all';
    let currentModalItem = null;

    function init() {
        applyTheme();
        applyLang();
        
        if (STATE.db.length === 0) {
            document.getElementById('sunnahList').innerHTML = `<div style="text-align:center; padding:40px; color:red;">${TRANSLATIONS[STATE.lang].error}</div>`;
            return;
        }

        renderChips();
        renderList();
    }

    /* --- MODAL LOGIC --- */
    function openModal(index) {
        const item = STATE.db[index];
        if (!item) return;
        
        currentModalItem = item;
        const content = item[STATE.lang];
        const catName = TRANSLATIONS[STATE.lang].cats[item.c] || item.c;

        document.getElementById('mIcon').textContent = item.i;
        document.getElementById('mTitle').textContent = content.t;
        document.getElementById('mCat').textContent = catName;
        document.getElementById('mBody').textContent = content.d;
        document.getElementById('mRef').textContent = "Ref: " + content.r;

        const modal = document.getElementById('detailModal');
        modal.classList.add('open');
        
        if(navigator.vibrate) navigator.vibrate(10);
    }

    function closeModal(e) {
        if (e && e.target.id !== 'detailModal' && !e.target.classList.contains('btn-close-abs')) return;
        const modal = document.getElementById('detailModal');
        modal.classList.remove('open');
        currentModalItem = null;
    }

    function copyModalContent() {
        if(!currentModalItem) return;
        const content = currentModalItem[STATE.lang];
        const text = `‚ú® ${content.t}\n\n${content.d}\n\n(Ref: ${content.r})`;
        navigator.clipboard.writeText(text).then(() => { showToast(); });
    }

    /* --- ROBUST SCREENSHOT SHARE LOGIC --- */
    async function shareScreenshot() {
        const btnShare = document.getElementById('btnShare');
        const spin = document.getElementById('shareSpin');
        const icon = document.getElementById('shareIcon');

        // 1. UI Loading State
        spin.style.display = 'block';
        icon.style.display = 'none';
        btnShare.style.opacity = '0.7';
        btnShare.disabled = true;

        try {
            // 2. Prepare Data
            const content = currentModalItem[STATE.lang];
            const catName = TRANSLATIONS[STATE.lang].cats[currentModalItem.c] || currentModalItem.c;

            // 3. Create a BRAND NEW container for the screenshot (The "Clone" Method)
            // This ensures we have total control over styling without affecting the visible modal
            const wrapper = document.createElement('div');
            
            // STYLE: Fixed Width for Story format, High Padding
            Object.assign(wrapper.style, {
                position: 'fixed',
                top: '0',
                left: '0',
                width: '500px', // Fixed high-res width
                padding: '100px 50px', // High padding for "Story" look
                background: 'linear-gradient(135deg, var(--primary-light) 0%, var(--surface) 100%)',
                zIndex: '-1000', // Behind everything but visible to DOM
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                fontFamily: "'Inter', sans-serif"
            });

            // 4. Build the Inner Card (Manually constructed to be cleaner than cloning)
            const cardHTML = `
                <div style="
                    background: ${getComputedStyle(document.body).getPropertyValue('--surface')};
                    border-radius: 32px;
                    padding: 40px 30px;
                    box-shadow: 0 30px 60px rgba(0,0,0,0.15);
                    width: 100%;
                    text-align: center;
                    border: 1px solid rgba(0,0,0,0.05);
                    display: flex; flex-direction: column; align-items: center;
                ">
                    <div style="
                        width: 80px; height: 80px; border-radius: 24px;
                        background: linear-gradient(135deg, var(--primary) 0%, #8a622a 100%);
                        color: #fff; font-size: 36px; display: flex; align-items: center; justify-content: center;
                        margin-bottom: 25px; box-shadow: 0 10px 20px rgba(166, 119, 52, 0.3);
                    ">${currentModalItem.i}</div>
                    
                    <div style="font-size: 24px; font-weight: 800; color: ${getComputedStyle(document.body).getPropertyValue('--text')}; margin-bottom: 8px; line-height: 1.3;">
                        ${content.t}
                    </div>
                    
                    <div style="
                        font-size: 11px; text-transform: uppercase; letter-spacing: 2px;
                        font-weight: 700; color: #888; margin-bottom: 25px;
                    ">${catName}</div>
                    
                    <div style="
                        font-size: 16px; line-height: 1.8; color: ${getComputedStyle(document.body).getPropertyValue('--text')}; margin-bottom: 30px;
                    ">${content.d}</div>
                    
                    <div style="
                        font-size: 12px; font-weight: 700; color: var(--primary);
                        background: var(--primary-light); padding: 8px 16px; border-radius: 12px;
                        display: inline-block;
                    ">Ref: ${content.r}</div>

                    <div style="margin-top: 40px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 20px; width: 100%;">
                        <div style="font-size: 12px; font-weight: 800; color: var(--primary); letter-spacing: 1px; text-transform: uppercase;">
                            MUKMIN.COM
                        </div>
                        <div style="font-size: 10px; color: #999; margin-top: 4px;">Daily Sunnah App</div>
                    </div>
                </div>
            `;
            
            wrapper.innerHTML = cardHTML;
            document.body.appendChild(wrapper);

            // 5. Wait for render (Important for images/fonts)
            await new Promise(resolve => setTimeout(resolve, 100));

            // 6. Capture
            const canvas = await html2canvas(wrapper, {
                scale: 2, // 2x Resolution
                useCORS: true,
                backgroundColor: null // Transparent logic handled by wrapper
            });

            // 7. Cleanup
            document.body.removeChild(wrapper);

            // 8. Share Process
            canvas.toBlob(async (blob) => {
                const file = new File([blob], "sunnah-card.png", { type: "image/png" });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: TRANSLATIONS[STATE.lang].shareTitle,
                            text: TRANSLATIONS[STATE.lang].shareText
                        });
                    } catch (err) { console.log("Share closed"); }
                } else {
                    // Fallback download
                    const link = document.createElement('a');
                    link.download = 'sunnah-card.png';
                    link.href = canvas.toDataURL();
                    link.click();
                    showToast("Saved to Photos");
                }
                resetShareUI();
            });

        } catch (err) {
            console.error("Screenshot Error:", err);
            resetShareUI();
            alert("Could not generate image. Please screenshot manually.");
        }

        function resetShareUI() {
            spin.style.display = 'none';
            icon.style.display = 'block';
            btnShare.style.opacity = '1';
            btnShare.disabled = false;
        }
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        if(msg) toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => { 
            toast.classList.remove('show');
            setTimeout(() => toast.textContent = "Copied!", 300);
        }, 2000);
    }

    /* --- THEME & LANG --- */
    function toggleTheme() {
        STATE.theme = STATE.theme === 'light' ? 'dark' : 'light';
        localStorage.setItem('wsl_theme', STATE.theme);
        applyTheme();
    }

    function applyTheme() {
        document.documentElement.setAttribute('data-theme', STATE.theme);
        const meta = document.querySelector('meta[name="theme-color"]');
        if(meta) meta.setAttribute("content", STATE.theme === 'light' ? '#A67734' : '#121212');
    }

    function toggleLang() {
        STATE.lang = STATE.lang === 'en' ? 'ms' : 'en';
        localStorage.setItem('wsl_lang', STATE.lang);
        applyLang();
        renderChips();
        renderList();
    }

    function applyLang() {
        const t = TRANSLATIONS[STATE.lang];
        document.getElementById('langBtn').textContent = STATE.lang.toUpperCase();
        document.getElementById('searchInput').placeholder = t.searchPlaceholder;
        document.getElementById('btnRandomTxt').textContent = t.randomBtn;
        document.getElementById('shareTxt').textContent = t.shareBtn;
        
        if(!document.getElementById('heroQuote').innerHTML.includes('<div')) {
            document.getElementById('heroQuote').textContent = `"${t.heroQuote}"`;
        }
    }

    /* --- RENDERING --- */
    function renderChips() {
        const t = TRANSLATIONS[STATE.lang].cats;
        const cats = ['all', 'daily', 'social', 'eating', 'sleep', 'ibadah', 'hygiene', 'friday', 'travel', 'general'];
        const container = document.getElementById('chipContainer');
        container.innerHTML = cats.map(key => 
            `<div class="chip ${currentFilter === key ? 'active' : ''}" 
                  onclick="setFilter('${key}')">${t[key] || key}</div>`
        ).join('');
    }

    function renderList(data = STATE.db) {
        const container = document.getElementById('sunnahList');
        const filtered = currentFilter === 'all' ? data : data.filter(i => i.c === currentFilter);
        
        document.getElementById('countDisplay').textContent = 
            `${TRANSLATIONS[STATE.lang].title} ‚Ä¢ ${filtered.length} ${TRANSLATIONS[STATE.lang].count}`;

        if(filtered.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">No items found.</div>`;
            return;
        }

        container.innerHTML = filtered.map(item => {
            const content = item[STATE.lang];
            const originalIndex = STATE.db.indexOf(item);
            
            return `
            <div class="sunnah-card" onclick="openModal(${originalIndex})">
                <div class="icon-box">${item.i}</div>
                <div class="card-content">
                    <div class="card-header-row">
                        <div class="card-title">${content.t}</div>
                        <div class="card-cat">${TRANSLATIONS[STATE.lang].cats[item.c] || item.c}</div>
                    </div>
                    <div class="card-body">${content.d}</div>
                    <div class="card-meta">
                        <div class="ref-text">Ref: ${content.r}</div>
                        <div style="opacity:0.5; transform:scale(0.8)">‚û§</div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function setFilter(id) {
        currentFilter = id;
        document.getElementById('searchInput').value = '';
        renderChips();
        renderList();
    }

    function filterList() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = STATE.db.filter(item => {
            const c = item[STATE.lang];
            return c.t.toLowerCase().includes(term) || c.d.toLowerCase().includes(term);
        });
        renderList(filtered);
    }

    function showRandom() {
        if(STATE.db.length === 0) return;
        const heroEl = document.getElementById('heroQuote');
        const r = STATE.db[Math.floor(Math.random() * STATE.db.length)];
        const content = r[STATE.lang];

        heroEl.style.opacity = 0;
        setTimeout(() => {
            heroEl.innerHTML = `
                <div style="font-weight:700; font-size:20px; margin-bottom:8px;">${content.t}</div>
                <div>${content.d}</div>
                <div style="font-size:12px; margin-top:10px; opacity:0.8; font-weight:600;">Ref: ${content.r}</div>
            `;
            heroEl.style.opacity = 1;
        }, 300);
    }

    /* --- ANIMATION CSS --- */
    const styleSheet = document.createElement("style");
    styleSheet.type = "text/css";
    styleSheet.innerText = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
    document.head.appendChild(styleSheet);
    
    function escapeStr(str) { return str.replace(/'/g, "\\'"); }

    init();
</script>

</body>
</html>
