<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kisah 25 Rasul</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>

    <style>
        /* THEME */
        :root[data-theme="light"] { --primary:#A67734; --bg:#E5E5E5; --surface:#FFFFFF; --text:#1F2937; --border:#ccc; --accent:#e74c3c; }
        :root[data-theme="dark"] { --primary:#D4AF37; --bg:#121212; --surface:#1E1E1E; --text:#F3F4F6; --border:#374151; --accent:#ff6b6b; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .sticky-header { 
            flex-shrink: 0; z-index: 100; background: var(--surface); 
            border-bottom: 1px solid var(--border); padding: 10px 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        /* Title Style */
        .header-title { font-weight: 800; font-size: 18px; color: var(--primary); }

        .header-controls { display: flex; gap: 15px; align-items: center; }
        .back-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text); }
        .btn { background: var(--bg); border: 1px solid var(--border); padding: 6px 12px; border-radius: 15px; font-weight: bold; font-size: 12px; cursor: pointer; color: var(--text); }

        /* BOOKMARK BUTTON */
        .bookmark-btn { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--text); transition: color 0.2s; display: flex; align-items: center; }
        .bookmark-btn.saved { color: var(--accent); } 

        /* TOAST ALERT */
        #jump-toast {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            background: var(--surface); border: 1px solid var(--primary);
            color: var(--primary); padding: 8px 16px; border-radius: 20px;
            font-size: 13px; font-weight: bold; z-index: 95;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer;
            display: none; animation: popIn 0.3s ease;
        }
        @keyframes popIn { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* DOWNLOAD BUTTON */
        #download-btn {
            position: absolute; top: 70px; right: 20px; z-index: 90;
            background: var(--primary); color: white; border: none; padding: 8px 16px; 
            border-radius: 20px; font-weight: bold; font-size: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none;
        }

        /* ZOOM CONTROLS */
        .zoom-controls { position: absolute; bottom: 80px; right: 20px; z-index: 90; display: flex; flex-direction: column; gap: 10px; }
        .zoom-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--surface); color: var(--text); font-size: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* STAGE & PAGE */
        .stage-wrapper { flex: 1; overflow: hidden; position: relative; background: var(--bg); display: flex; align-items: center; justify-content: center; }
        #zoom-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .my-page { background-color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 5px rgba(0,0,0,0.2); position: relative; }
        canvas { width: 100%; height: 100%; object-fit: contain; }

        /* PAGE MARKER RIBBON */
        .page-marker {
            position: absolute; top: 0; right: 20px; width: 30px; height: 40px;
            background: var(--accent); clip-path: polygon(0 0, 100% 0, 100% 100%, 50% 80%, 0 100%);
            display: none; z-index: 10;
        }

        /* LOADER */
        #loader { position: absolute; inset: 0; background: var(--bg); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .bar-bg { width: 70%; height: 6px; background: var(--border); border-radius: 10px; overflow: hidden; margin-top: 15px; }
        .bar-fill { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }

        /* NAVIGATION */
        .nav-btn { position: absolute; bottom: 20px; background: var(--surface); color: var(--primary); border: 1px solid var(--border); width: 50px; height: 50px; border-radius: 50%; font-size: 22px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 40; display: flex; align-items: center; justify-content: center; }
        #btn-prev { left: 20px; }
        #btn-next { right: 20px; }
    </style>
</head>
<body>

    <div class="sticky-header">
        <button class="back-btn" onclick="history.back()">‚Üê</button>
        
        <div class="header-title">Kisah 25 Rasul</div>
        
        <div class="header-controls">
            <button class="bookmark-btn" id="mark-btn" onclick="toggleBookmark()">üîñ</button>
            <button class="btn" onclick="toggleTheme()">‚óë</button>
        </div>
    </div>

    <div id="jump-toast" onclick="jumpToMark()">
        Go to Bookmark (Page <span id="mark-num">0</span>) ‚ûú
    </div>

    <button id="download-btn" onclick="saveForOffline()">‚¨á Save Offline</button>

    <div class="zoom-controls">
        <button class="zoom-btn" onclick="handleZoom('in')">+</button>
        <button class="zoom-btn" onclick="handleZoom('out')">-</button>
        <button class="zoom-btn" onclick="handleZoom('reset')">‚Ü∫</button>
    </div>

    <div class="stage-wrapper">
        <div id="loader">
            <div id="status">Starting...</div>
            <div class="bar-bg"><div class="bar-fill" id="fill"></div></div>
        </div>

        <div id="zoom-container">
            <div id="book"></div>
        </div>

        <button class="nav-btn" id="btn-prev">‚Üê</button>
        <button class="nav-btn" id="btn-next">‚Üí</button>
    </div>

<script>
    // === CONFIGURATION ===
    const PDF_PATH = 'books/25_Kisah_Para_Nabi.pdf'; // Ensure your PDF is named exactly this!
    const HD_SCALE = 3.0; 
    // =====================

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    // Elements
    const status = document.getElementById('status');
    const loader = document.getElementById('loader');
    const downloadBtn = document.getElementById('download-btn');
    const zoomContainer = document.getElementById('zoom-container');
    const markBtn = document.getElementById('mark-btn');
    const jumpToast = document.getElementById('jump-toast');
    const markNumSpan = document.getElementById('mark-num');

    // State
    let pdfDoc = null;
    let pageFlip = null;
    let pdfBlob = null;
    let panzoomInstance = null;
    let savedPage = null; 

    // Database
    const db = localforage.createInstance({ name: "KisahApp", storeName: "book_data" });

    // Theme
    let currentTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', currentTheme);
    function toggleTheme() {
        currentTheme = currentTheme === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', currentTheme);
        document.documentElement.setAttribute('data-theme', currentTheme);
    }

    // 1. START
    window.addEventListener('DOMContentLoaded', () => {
        panzoomInstance = Panzoom(zoomContainer, { maxScale: 4, minScale: 1, contain: 'outside', noBind: false });
        zoomContainer.addEventListener('panzoomstart', () => { if(pageFlip) pageFlip.updateOrientation('portrait'); }); 
        
        loadBook();
    });

    // 2. LOAD BOOK
    async function loadBook() {
        try {
            // Load Bookmark from DB
            savedPage = await db.getItem('user_bookmark');
            updateBookmarkUI();

            const savedPdf = await db.getItem('cached_pdf');

            if (savedPdf) {
                status.innerText = "Loading from Storage...";
                pdfBlob = savedPdf;
                downloadBtn.style.display = 'none';
            } else {
                status.innerText = "Downloading PDF...";
                const response = await fetch(PDF_PATH);
                if (!response.ok) throw new Error("File missing: " + PDF_PATH);
                pdfBlob = await response.blob();
                downloadBtn.style.display = 'block';
            }

            const arrayBuffer = await pdfBlob.arrayBuffer();
            pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            
            initFlipbook(pdfDoc.numPages);

        } catch (err) {
            status.innerText = "Error: " + err.message;
            status.style.color = "red";
        }
    }

    // 3. FLIPBOOK INIT
    function initFlipbook(totalPages) {
        status.innerText = "Rendering...";
        const bookEl = document.getElementById('book');

        for (let i = 1; i <= totalPages; i++) {
            const d = document.createElement('div');
            d.className = 'my-page';
            // Marker Ribbon
            d.innerHTML = `<div class="page-marker" id="marker-${i}"></div><canvas id="canvas-${i}"></canvas>`;
            bookEl.appendChild(d);
        }

        pageFlip = new St.PageFlip(bookEl, {
            width: 400, height: 600, size: 'stretch',
            minWidth: 300, maxWidth: 1000,
            showCover: true, mobileScrollSupport: false
        });

        pageFlip.loadFromHTML(document.querySelectorAll('.my-page'));

        setTimeout(() => { loader.style.display = 'none'; }, 500);

        // Events
        pageFlip.on('flip', (e) => {
            const p = e.data + 1;
            checkIfPageIsMarked(p);
            renderPage(p); renderPage(p+1); renderPage(p+2);
        });

        // Initial Render
        renderPage(1); renderPage(2);
        checkIfPageIsMarked(1);

        // Show Toast if Bookmark exists
        if(savedPage && savedPage > 1) {
            markNumSpan.innerText = savedPage;
            jumpToast.style.display = 'block';
            setTimeout(() => { jumpToast.style.display = 'none'; }, 5000);
        }

        document.getElementById('btn-prev').onclick = () => pageFlip.flipPrev();
        document.getElementById('btn-next').onclick = () => pageFlip.flipNext();
    }

    // 4. RENDER PAGE (Vector)
    async function renderPage(num) {
        if (num < 1 || num > pdfDoc.numPages) return;
        const canvas = document.getElementById(`canvas-${num}`);
        if (!canvas || canvas.getAttribute('data-done')) return;
        
        canvas.setAttribute('data-done', 'true');
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale: HD_SCALE });
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
    }

    // 5. BOOKMARK SYSTEM
    function toggleBookmark() {
        const currentPageIndex = pageFlip.getCurrentPageIndex(); 
        const pageNum = currentPageIndex + 1; // 0-based to 1-based

        if (savedPage === pageNum) {
            savedPage = null; // Remove
            db.removeItem('user_bookmark');
            alert("Bookmark Removed");
        } else {
            savedPage = pageNum; // Save
            db.setItem('user_bookmark', pageNum);
            alert(`Marked Page ${pageNum}`);
        }
        updateBookmarkUI();
        checkIfPageIsMarked(pageNum);
    }

    function updateBookmarkUI() {
        if(savedPage) markBtn.classList.add('saved');
        else markBtn.classList.remove('saved');
    }

    function checkIfPageIsMarked(current) {
        document.querySelectorAll('.page-marker').forEach(el => el.style.display = 'none');
        if (savedPage) {
            const ribbon = document.getElementById(`marker-${savedPage}`);
            if(ribbon) ribbon.style.display = 'block';
            if(savedPage === current) markBtn.classList.add('saved');
        }
    }

    function jumpToMark() {
        if(savedPage) {
            pageFlip.turnToPage(savedPage - 1);
            jumpToast.style.display = 'none';
        }
    }

    // 6. ZOOM
    function handleZoom(action) {
        if (!panzoomInstance) return;
        if (action === 'in') panzoomInstance.zoomIn();
        if (action === 'out') panzoomInstance.zoomOut();
        if (action === 'reset') panzoomInstance.reset();
    }

    // 7. OFFLINE SAVE
    async function saveForOffline() {
        if (!pdfBlob) return;
        downloadBtn.innerText = "Saving...";
        try {
            await db.setItem('cached_pdf', pdfBlob);
            downloadBtn.innerText = "‚úÖ Saved";
            setTimeout(() => downloadBtn.style.display = 'none', 2000);
        } catch (e) { alert("Error: " + e.message); }
    }
</script>
</body>
</html>
