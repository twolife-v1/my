<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Islamic Quiz</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- MUKMIN THEME STYLES --- */
        :root { 
            --primary: #A67734; --primary-light: #FDF8F0; --bg: #F8F9FA; 
            --surface: #FFFFFF; --text: #1F2937; --text-muted: #6B7280;
            --success: #059669; --danger: #DC2626; --border: #E5E7EB;
        }
        @media (prefers-color-scheme: dark) { 
            :root { 
                --primary: #D4AF37; --primary-light: #2A2012; --bg: #121212; 
                --surface: #1E1E1E; --text: #F3F4F6; --text-muted: #9CA3AF; --border: #374151;
            } 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 20px; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { background: none; border: none; font-weight: 700; color: var(--text); font-size: 14px; opacity: 0.7; cursor: pointer; display: flex; align-items: center; gap: 5px; padding: 0; }
        
        .stats-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: var(--surface); padding: 10px; border-radius: 16px; text-align: center; border: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 700; }
        .stat-val { font-size: 18px; font-weight: 800; color: var(--primary); }

        .quiz-card { background: var(--surface); border-radius: 24px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); flex: 1; display: flex; flex-direction: column; justify-content: center; position: relative; overflow: hidden; border: 1px solid var(--border); }
        
        .progress-bg { position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: var(--border); display: block; }
        .progress-bar { height: 100%; background: var(--primary); width: 100%; transition: width 1s linear; }
        
        .cat-tag { position: absolute; top: 15px; right: 15px; font-size: 10px; font-weight: 700; text-transform: uppercase; background: var(--primary-light); color: var(--primary); padding: 4px 8px; border-radius: 6px; }

        .question-text { font-size: 18px; font-weight: 800; margin-bottom: 25px; line-height: 1.5; text-align: center; margin-top: 20px; }
        
        .options-grid { display: grid; gap: 10px; width: 100%; overflow-y: auto; max-height: 40vh; padding-bottom: 5px; }
        .opt-btn { background: var(--bg); border: 2px solid transparent; color: var(--text); padding: 14px; border-radius: 14px; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; font-family: 'Inter', sans-serif; text-align: left; position: relative; }
        .opt-btn:active { transform: scale(0.98); background: var(--primary-light); }
        .opt-btn.correct { background: var(--success); color: white; border-color: var(--success); }
        .opt-btn.wrong { background: var(--danger); color: white; border-color: var(--danger); opacity: 0.8; }
        .disabled { pointer-events: none; }

        .nav-controls { display: flex; justify-content: space-between; margin-top: 20px; gap: 10px; }
        .nav-btn { flex: 1; background: var(--bg); border: 1px solid var(--border); padding: 12px; border-radius: 12px; font-weight: 700; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        #startScreen, #endScreen { text-align: center; display: flex; flex-direction: column; justify-content: center; height: 100%; align-items: center; }
        .big-icon { font-size: 60px; margin-bottom: 20px; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-weight: 700; font-size: 16px; margin-top: 10px; cursor: pointer; box-shadow: 0 5px 15px rgba(166, 119, 52, 0.3); transition: transform 0.2s; width: 80%; max-width: 300px; }
        .btn-outline { background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 15px 40px; border-radius: 50px; font-weight: 700; font-size: 16px; margin-top: 10px; cursor: pointer; transition: transform 0.2s; width: 80%; max-width: 300px; }
        .btn-primary:active, .btn-outline:active { transform: scale(0.95); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="startScreen">
        <div class="big-icon">üïå</div>
        <h1 style="margin:0; font-weight:800; color:var(--primary);" id="lbl-title">Islamic Quiz</h1>
        <p style="color:var(--text-muted); margin-top:10px; margin-bottom: 30px;" id="lbl-subtitle">Choose your mode</p>
        
        <button class="btn-primary" onclick="startGame('timed')">
            <span id="lbl-timed">‚ö° Timed Challenge</span>
        </button>
        
        <button class="btn-outline" onclick="startGame('free')">
            <span id="lbl-free">üßò Free Practice</span>
        </button>

        <button onclick="goBack()" style="background:none; border:none; color:var(--text-muted); margin-top:30px; font-weight:600; font-size:13px; cursor:pointer;" id="lbl-exit">Exit</button>
    </div>

    <div id="gameUI" class="hidden">
        <div class="game-header">
            <button class="back-btn" onclick="goBack()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5"></path><polyline points="12 19 5 12 12 5"></polyline></svg>
                <span id="lbl-exit-game">Exit</span>
            </button>
            <div style="font-weight:800; color:var(--primary); font-size:14px;">Q. <span id="qNum">1</span>/<span id="totalQ">10</span></div>
        </div>

        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label" id="lbl-score">Score</div>
                <div class="stat-val" id="score">0</div>
            </div>
            <div class="stat-card" id="timerBox">
                <div class="stat-label" id="lbl-time">Time</div>
                <div class="stat-val" id="timer">15</div>
            </div>
        </div>

        <div class="quiz-card">
            <div class="progress-bg" id="timerBarBg"><div class="progress-bar" id="timeBar"></div></div>
            <span id="catTag" class="cat-tag">General</span>
            
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                <div id="question" class="question-text">Loading...</div>
                <div class="options-grid" id="options"></div>
            </div>

            <div class="nav-controls hidden" id="navControls">
                <button class="nav-btn" id="btnPrev" onclick="prevQuestion()">Previous</button>
                <button class="nav-btn active" id="btnNext" onclick="nextQuestion()">Next</button>
            </div>
        </div>
    </div>

    <div id="endScreen" class="hidden">
        <div class="big-icon" id="endIcon">üèÜ</div>
        <h1 id="endTitle" style="margin:0; font-weight:800;">Quiz Complete!</h1>
        <p style="color:var(--text-muted); margin-top:5px;" id="lbl-final-score">Your Final Score</p>
        <div style="font-size:48px; font-weight:800; color:var(--primary); margin: 10px 0;" id="finalScore">0</div>
        <button class="btn-primary" onclick="startGame('timed')" id="lbl-replay-timed">Play Timed</button>
        <button class="btn-outline" onclick="startGame('free')" id="lbl-replay-free">Play Practice</button>
        <button onclick="goBack()" style="background:none; border:none; color:var(--text-muted); margin-top:20px; font-weight:600; font-size:13px; cursor:pointer;" id="lbl-back-menu">Back to Menu</button>
    </div>

    <script>
        /* LANGUAGE DATA */
        let currentLang = 'en';

        const TEXTS = {
            en: {
                title: "Islamic Quiz", subtitle: "Choose your mode",
                timed: "‚ö° Timed Challenge", free: "üßò Free Practice", exit: "Exit",
                score: "Score", time: "Time", prev: "Previous", next: "Next", finish: "Finish",
                complete: "Quiz Complete!", finalScore: "Your Final Score",
                replayTimed: "Play Timed", replayFree: "Play Practice", backMenu: "Back to Menu"
            },
            ms: {
                title: "Kuiz Islamik", subtitle: "Pilih mod anda",
                timed: "‚ö° Cabaran Masa", free: "üßò Latihan Bebas", exit: "Keluar",
                score: "Markah", time: "Masa", prev: "Sebelum", next: "Seterusnya", finish: "Tamat",
                complete: "Kuiz Tamat!", finalScore: "Markah Akhir",
                replayTimed: "Main Berwaktu", replayFree: "Main Latihan", backMenu: "Menu Utama"
            }
        };

        /* BILINGUAL QUESTION DATABASE */
        const DB = [
            { 
                cat: {en:"General", ms:"Umum"}, 
                q: {en:"Which Surah is the 'Heart of the Quran'?", ms:"Surah manakah digelar 'Jantung Al-Quran'?"}, 
                a: {en:["Al-Mulk","Yasin","Rahman","Fatiha"], ms:["Al-Mulk","Yasin","Rahman","Fatihah"]}, 
                c: 1 
            },
            { 
                cat: {en:"General", ms:"Umum"}, 
                q: {en:"What is the first pillar of Islam?", ms:"Apakah rukun Islam pertama?"}, 
                a: {en:["Salah","Zakat","Shahada","Hajj"], ms:["Solat","Zakat","Syahadah","Haji"]}, 
                c: 2 
            },
            { 
                cat: {en:"General", ms:"Umum"}, 
                q: {en:"Which Prophet built the Kaaba?", ms:"Nabi manakah yang membina Kaabah?"}, 
                a: {en:["Musa (AS)","Isa (AS)","Ibrahim (AS)","Nuh (AS)"], ms:["Musa (AS)","Isa (AS)","Ibrahim (AS)","Nuh (AS)"]}, 
                c: 2 
            },
            { 
                cat: {en:"General", ms:"Umum"}, 
                q: {en:"Rakats in Fard Maghrib prayer?", ms:"Berapa rakaat solat Fardu Maghrib?"}, 
                a: {en:["2","3","4","5"], ms:["2","3","4","5"]}, 
                c: 1 
            },
            { 
                cat: {en:"Sirah", ms:"Sirah"}, 
                q: {en:"Companion known as 'As-Siddiq'?", ms:"Sahabat digelar 'As-Siddiq'?"}, 
                a: {en:["Abu Bakr","Umar","Ali","Uthman"], ms:["Abu Bakar","Umar","Ali","Uthman"]}, 
                c: 0 
            },
            { 
                cat: {en:"Sirah", ms:"Sirah"}, 
                q: {en:"First wife of Prophet (SAW)?", ms:"Isteri pertama Nabi Muhammad SAW?"}, 
                a: {en:["Aisha","Khadijah","Hafsah","Fatimah"], ms:["Aisyah","Khadijah","Hafsah","Fatimah"]}, 
                c: 1 
            },
            { 
                cat: {en:"History", ms:"Sejarah"}, 
                q: {en:"Conqueror of Constantinople?", ms:"Penakluk Kota Konstantinopel?"}, 
                a: {en:["Suleiman","Mehmed II","Selim","Murad"], ms:["Suleiman","Muhammad Al-Fatih","Selim","Murad"]}, 
                c: 1 
            },
            { 
                cat: {en:"History", ms:"Sejarah"}, 
                q: {en:"Liberator of Jerusalem?", ms:"Pembebas Baitulmaqdis?"}, 
                a: {en:["Salahuddin","Tariq","Khalid","Saad"], ms:["Salahuddin","Tariq","Khalid","Saad"]}, 
                c: 0 
            }
        ];

        /* INIT & LANGUAGE CHECK */
        window.addEventListener('DOMContentLoaded', () => {
            // Check language from Parent App (index.html)
            const savedLang = localStorage.getItem('wsl_lang');
            if (savedLang && (savedLang === 'ms' || savedLang === 'en')) {
                currentLang = savedLang;
            }
            updateUIText();
        });

        function updateUIText() {
            const t = TEXTS[currentLang];
            document.getElementById('lbl-title').textContent = t.title;
            document.getElementById('lbl-subtitle').textContent = t.subtitle;
            document.getElementById('lbl-timed').textContent = t.timed;
            document.getElementById('lbl-free').textContent = t.free;
            document.getElementById('lbl-exit').textContent = t.exit;
            document.getElementById('lbl-exit-game').textContent = t.exit;
            document.getElementById('lbl-score').textContent = t.score;
            document.getElementById('lbl-time').textContent = t.time;
            document.getElementById('endTitle').textContent = t.complete;
            document.getElementById('lbl-final-score').textContent = t.finalScore;
            document.getElementById('lbl-replay-timed').textContent = t.replayTimed;
            document.getElementById('lbl-replay-free').textContent = t.replayFree;
            document.getElementById('lbl-back-menu').textContent = t.backMenu;
            
            document.getElementById('btnPrev').textContent = t.prev;
            // Next button text is dynamic (Next/Finish), handled in loadQuestion
        }

        /* GAME LOGIC (UNCHANGED) */
        let currentQ = 0;
        let score = 0;
        let timeLeft = 15;
        let timerInt = null;
        let isFreeMode = false;
        let activeQuestions = []; 
        let userAnswers = {}; 

        function goBack() {
            if (window.parent && window.parent.closeReader) window.parent.closeReader();
            else window.location.href = 'index.html';
        }

        function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

        function startGame(mode) {
            isFreeMode = (mode === 'free');
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('gameUI').classList.remove('hidden');
            
            currentQ = 0; score = 0; userAnswers = {};
            activeQuestions = shuffle([...DB]).slice(0, 8); // Pick 8 random questions
            document.getElementById('totalQ').innerText = activeQuestions.length;

            if (isFreeMode) {
                document.getElementById('timerBox').style.visibility = 'hidden';
                document.getElementById('timerBarBg').style.display = 'none';
                document.getElementById('navControls').classList.remove('hidden');
            } else {
                document.getElementById('timerBox').style.visibility = 'visible';
                document.getElementById('timerBarBg').style.display = 'block';
                document.getElementById('navControls').classList.add('hidden');
            }
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQ >= activeQuestions.length) return endGame();

            const qData = activeQuestions[currentQ];
            timeLeft = 15;
            
            document.getElementById('qNum').innerText = currentQ + 1;
            document.getElementById('score').innerText = score;
            document.getElementById('timer').innerText = timeLeft;
            document.getElementById('timeBar').style.width = '100%';
            
            // USE CURRENT LANG FOR TEXT
            document.getElementById('question').innerText = qData.q[currentLang];
            document.getElementById('catTag').innerText = qData.cat[currentLang];
            
            const optsDiv = document.getElementById('options');
            optsDiv.innerHTML = '';
            
            const savedAnswer = userAnswers[currentQ];
            const isAnswered = (savedAnswer !== undefined);

            qData.a[currentLang].forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = opt;
                if (isAnswered) {
                    btn.classList.add('disabled');
                    if (idx === qData.c) btn.classList.add('correct');
                    if (idx === savedAnswer && idx !== qData.c) btn.classList.add('wrong');
                } else {
                    btn.onclick = () => checkAnswer(idx, btn, qData.c);
                }
                optsDiv.appendChild(btn);
            });

            if (isFreeMode) {
                const t = TEXTS[currentLang];
                const btnPrev = document.getElementById('btnPrev');
                const btnNext = document.getElementById('btnNext');
                btnPrev.disabled = (currentQ === 0);
                
                if (currentQ === activeQuestions.length - 1) {
                    btnNext.innerText = t.finish;
                    btnNext.classList.add('active'); 
                } else {
                    btnNext.innerText = t.next;
                    isAnswered ? btnNext.classList.add('active') : btnNext.classList.remove('active'); 
                }
            } else {
                startTimer();
            }
        }

        function startTimer() {
            if(timerInt) clearInterval(timerInt);
            timerInt = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                document.getElementById('timeBar').style.width = (timeLeft/15 * 100) + '%';
                if(timeLeft <= 0) { clearInterval(timerInt); handleTimeOut(); }
            }, 1000);
        }

        function checkAnswer(selectedIdx, btn, correctIdx) {
            if(timerInt) clearInterval(timerInt);
            userAnswers[currentQ] = selectedIdx;

            const buttons = document.querySelectorAll('.opt-btn');
            buttons.forEach(b => b.classList.add('disabled'));

            if(selectedIdx === correctIdx) {
                btn.classList.add('correct');
                score += isFreeMode ? 100 : (10 + Math.ceil(timeLeft / 2)); 
            } else {
                btn.classList.add('wrong');
                buttons[correctIdx].classList.add('correct'); 
            }

            if (isFreeMode) {
                document.getElementById('btnNext').classList.add('active');
                document.getElementById('score').innerText = score;
            } else {
                document.getElementById('score').innerText = score;
                setTimeout(() => { currentQ++; loadQuestion(); }, 1500);
            }
        }

        function handleTimeOut() {
            const qData = activeQuestions[currentQ];
            const buttons = document.querySelectorAll('.opt-btn');
            buttons[qData.c].classList.add('correct');
            buttons.forEach(b => b.classList.add('disabled'));
            setTimeout(() => { currentQ++; loadQuestion(); }, 1500);
        }

        function prevQuestion() { if (currentQ > 0) { currentQ--; loadQuestion(); } }
        function nextQuestion() { if (currentQ < activeQuestions.length) { currentQ++; if (currentQ === activeQuestions.length) endGame(); else loadQuestion(); } }

        function endGame() {
            if(timerInt) clearInterval(timerInt);
            document.getElementById('gameUI').classList.add('hidden');
            document.getElementById('endScreen').classList.remove('hidden');
            document.getElementById('finalScore').innerText = score;
        }
    </script>
</body>
</html>
