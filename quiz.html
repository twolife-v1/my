<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Islamic Quiz</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- MUKMIN THEME STYLES --- */
        :root { 
            --primary: #A67734; --primary-light: #FDF8F0; --bg: #F8F9FA; 
            --surface: #FFFFFF; --text: #1F2937; --text-muted: #6B7280;
            --success: #059669; --danger: #DC2626; --border: #E5E7EB;
        }
        @media (prefers-color-scheme: dark) { 
            :root { 
                --primary: #D4AF37; --primary-light: #2A2012; --bg: #121212; 
                --surface: #1E1E1E; --text: #F3F4F6; --text-muted: #9CA3AF; --border: #374151;
            } 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 20px; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { background: none; border: none; font-weight: 700; color: var(--text); font-size: 14px; opacity: 0.7; cursor: pointer; display: flex; align-items: center; gap: 5px; padding: 0; }
        
        .stats-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: var(--surface); padding: 10px; border-radius: 16px; text-align: center; border: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 700; }
        .stat-val { font-size: 18px; font-weight: 800; color: var(--primary); }

        .quiz-card { background: var(--surface); border-radius: 24px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); flex: 1; display: flex; flex-direction: column; justify-content: center; position: relative; overflow: hidden; border: 1px solid var(--border); }
        
        .progress-bg { position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: var(--border); display: block; }
        .progress-bar { height: 100%; background: var(--primary); width: 100%; transition: width 1s linear; }
        
        .cat-tag { position: absolute; top: 15px; right: 15px; font-size: 10px; font-weight: 700; text-transform: uppercase; background: var(--primary-light); color: var(--primary); padding: 4px 8px; border-radius: 6px; }

        .question-text { font-size: 18px; font-weight: 800; margin-bottom: 25px; line-height: 1.5; text-align: center; margin-top: 20px; }
        
        .options-grid { display: grid; gap: 10px; width: 100%; overflow-y: auto; max-height: 40vh; padding-bottom: 5px; }
        .opt-btn { background: var(--bg); border: 2px solid transparent; color: var(--text); padding: 14px; border-radius: 14px; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; font-family: 'Inter', sans-serif; text-align: left; position: relative; }
        .opt-btn:active { transform: scale(0.98); background: var(--primary-light); }
        .opt-btn.correct { background: var(--success); color: white; border-color: var(--success); }
        .opt-btn.wrong { background: var(--danger); color: white; border-color: var(--danger); opacity: 0.8; }
        .disabled { pointer-events: none; }

        .nav-controls { display: flex; justify-content: space-between; margin-top: 20px; gap: 10px; }
        .nav-btn { flex: 1; background: var(--bg); border: 1px solid var(--border); padding: 12px; border-radius: 12px; font-weight: 700; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- NEW START SCREEN STYLES --- */
        #startScreen, #endScreen { text-align: center; display: flex; flex-direction: column; justify-content: center; height: 100%; align-items: center; width: 100%; max-width: 400px; margin: 0 auto; }
        .big-icon { font-size: 60px; margin-bottom: 10px; }
        
        /* Mode Switcher */
        .mode-switch { background: var(--surface); border: 1px solid var(--border); border-radius: 50px; padding: 5px; display: flex; width: 100%; margin-bottom: 20px; position: relative; }
        .mode-btn { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 40px; font-weight: 700; font-size: 13px; color: var(--text-muted); cursor: pointer; z-index: 2; transition: color 0.2s; }
        .mode-btn.active { color: white; }
        .mode-slider { position: absolute; top: 5px; left: 5px; width: calc(50% - 5px); height: calc(100% - 10px); background: var(--primary); border-radius: 40px; transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); z-index: 1; }

        /* Category Grid */
        .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; overflow-y: auto; max-height: 50vh; padding: 5px; }
        .cat-card { background: var(--surface); border: 1px solid var(--border); padding: 15px; border-radius: 16px; cursor: pointer; transition: 0.2s; text-align: left; display: flex; flex-direction: column; justify-content: space-between; height: 80px; }
        .cat-card:active { transform: scale(0.96); border-color: var(--primary); background: var(--primary-light); }
        .cat-name { font-weight: 800; font-size: 14px; color: var(--text); }
        .cat-count { font-size: 10px; color: var(--text-muted); font-weight: 600; margin-top: 5px; }
        .cat-icon { font-size: 18px; margin-bottom: 5px; }

        .btn-primary { background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-weight: 700; font-size: 16px; margin-top: 10px; cursor: pointer; box-shadow: 0 5px 15px rgba(166, 119, 52, 0.3); transition: transform 0.2s; width: 80%; max-width: 300px; }
        .btn-outline { background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 15px 40px; border-radius: 50px; font-weight: 700; font-size: 16px; margin-top: 10px; cursor: pointer; transition: transform 0.2s; width: 80%; max-width: 300px; }
        .btn-primary:active, .btn-outline:active { transform: scale(0.95); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="startScreen">
        <div class="big-icon">üïå</div>
        <h1 style="margin:0; font-weight:800; color:var(--primary); font-size: 24px;" id="lbl-title">Islamic Quiz</h1>
        <p style="color:var(--text-muted); margin-top:5px; margin-bottom: 20px; font-size: 13px;" id="lbl-subtitle">Select Mode & Topic</p>
        
        <div class="mode-switch">
            <div class="mode-slider" id="modeSlider"></div>
            <button class="mode-btn active" onclick="setMode('timed')" id="btn-timed">‚ö° Timed</button>
            <button class="mode-btn" onclick="setMode('free')" id="btn-free">üßò Practice</button>
        </div>

        <div class="cat-grid" id="categoryGrid">
            </div>

        <button onclick="goBack()" style="background:none; border:none; color:var(--text-muted); margin-top:20px; font-weight:600; font-size:13px; cursor:pointer;" id="lbl-exit">Exit</button>
    </div>

    <div id="gameUI" class="hidden">
        <div class="game-header">
            <button class="back-btn" onclick="returnToMenu()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5"></path><polyline points="12 19 5 12 12 5"></polyline></svg>
                <span id="lbl-exit-game">Menu</span>
            </button>
            <div style="font-weight:800; color:var(--primary); font-size:14px;">Q. <span id="qNum">1</span>/<span id="totalQ">10</span></div>
        </div>

        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label" id="lbl-score">Score</div>
                <div class="stat-val" id="score">0</div>
            </div>
            <div class="stat-card" id="timerBox">
                <div class="stat-label" id="lbl-time">Time</div>
                <div class="stat-val" id="timer">15</div>
            </div>
        </div>

        <div class="quiz-card">
            <div class="progress-bg" id="timerBarBg"><div class="progress-bar" id="timeBar"></div></div>
            <span id="catTag" class="cat-tag">General</span>
            
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                <div id="question" class="question-text">Loading...</div>
                <div class="options-grid" id="options"></div>
            </div>

            <div class="nav-controls hidden" id="navControls">
                <button class="nav-btn" id="btnPrev" onclick="prevQuestion()">Previous</button>
                <button class="nav-btn active" id="btnNext" onclick="nextQuestion()">Next</button>
            </div>
        </div>
    </div>

    <div id="endScreen" class="hidden">
        <div class="big-icon" id="endIcon">üèÜ</div>
        <h1 id="endTitle" style="margin:0; font-weight:800;">Quiz Complete!</h1>
        <p style="color:var(--text-muted); margin-top:5px;" id="lbl-final-score">Your Final Score</p>
        <div style="font-size:48px; font-weight:800; color:var(--primary); margin: 10px 0;" id="finalScore">0</div>
        
        <button class="btn-primary" onclick="returnToMenu()" id="lbl-back-menu">Back to Menu</button>
    </div>

    <script>
        /* LANGUAGE DATA */
        let currentLang = 'en';
        let selectedMode = 'timed'; // Default

        const TEXTS = {
            en: {
                title: "Islamic Quiz", subtitle: "Select Mode & Topic",
                timed: "‚ö° Timed", free: "üßò Practice", exit: "Exit",
                score: "Score", time: "Time", prev: "Previous", next: "Next", finish: "Finish",
                complete: "Quiz Complete!", finalScore: "Your Final Score",
                backMenu: "Back to Menu", allTopics: "All Topics"
            },
            ms: {
                title: "Kuiz Islamik", subtitle: "Pilih Mod & Topik",
                timed: "‚ö° Masa", free: "üßò Latihan", exit: "Keluar",
                score: "Markah", time: "Masa", prev: "Sebelum", next: "Seterusnya", finish: "Tamat",
                complete: "Kuiz Tamat!", finalScore: "Markah Akhir",
                backMenu: "Menu Utama", allTopics: "Semua Topik"
            }
        };

        /* MEGA BILINGUAL QUESTION DATABASE */
        const DB = [
            // --- GENERAL / UMUM ---
            { cat: {en:"General", ms:"Umum"}, q: {en:"Which Surah is 'Heart of Quran'?", ms:"Surah manakah 'Jantung Al-Quran'?"}, a: {en:["Al-Mulk","Yasin","Rahman","Fatiha"], ms:["Al-Mulk","Yasin","Rahman","Fatihah"]}, c: 1 },
            { cat: {en:"General", ms:"Umum"}, q: {en:"First pillar of Islam?", ms:"Rukun Islam pertama?"}, a: {en:["Salah","Zakat","Shahada","Hajj"], ms:["Solat","Zakat","Syahadah","Haji"]}, c: 2 },
            { cat: {en:"General", ms:"Umum"}, q: {en:"Prophet who built the Kaaba?", ms:"Nabi pembina Kaabah?"}, a: {en:["Musa","Isa","Ibrahim","Nuh"], ms:["Musa","Isa","Ibrahim","Nuh"]}, c: 2 },
            { cat: {en:"General", ms:"Umum"}, q: {en:"Solar eclipse prayer name?", ms:"Nama solat gerhana matahari?"}, a: {en:["Kusuf","Khusuf","Istisqa","Duha"], ms:["Kusuf","Khusuf","Istisqa","Dhuha"]}, c: 0 },
            { cat: {en:"General", ms:"Umum"}, q: {en:"Angels carrying the Throne?", ms:"Bilangan Malaikat pemikul Arasy?"}, a: {en:["4","8","10","99"], ms:["4","8","10","99"]}, c: 1 },
            { cat: {en:"General", ms:"Umum"}, q: {en:"Guardian of Hell?", ms:"Penjaga Neraka?"}, a: {en:["Ridwan","Malik","Israfil","Munkar"], ms:["Ridwan","Malik","Israfil","Munkar"]}, c: 1 },
            
            // --- FARDHU AIN ---
            { cat: {en:"Fardhu Ain", ms:"Fardu Ain"}, q: {en:"Pillars (Rukun) of Salah?", ms:"Bilangan Rukun Solat?"}, a: {en:["5","10","13","17"], ms:["5","10","13","17"]}, c: 2 },
            { cat: {en:"Fardhu Ain", ms:"Fardu Ain"}, q: {en:"Najis Mughallazah example?", ms:"Contoh Najis Mughallazah?"}, a: {en:["Baby urine","Blood","Dog Saliva","Vomit"], ms:["Air kencing bayi","Darah","Air liur Anjing","Muntah"]}, c: 2 },
            { cat: {en:"Fardhu Ain", ms:"Fardu Ain"}, q: {en:"Aurah limit for men?", ms:"Had Aurat lelaki?"}, a: {en:["Knee to ankle","Navel to knees","Shoulder to knees","Whole body"], ms:["Lutut ke buku lali","Pusat ke lutut","Bahu ke lutut","Seluruh badan"]}, c: 1 },
            { cat: {en:"Fardhu Ain", ms:"Fardu Ain"}, q: {en:"Invalidates Wudu?", ms:"Membatalkan Wuduk?"}, a: {en:["Eating camel","Deep sleep","Laughing","Crying"], ms:["Makan unta","Tidur nyenyak","Ketawa","Menangis"]}, c: 1 },
            { cat: {en:"Fardhu Ain", ms:"Fardu Ain"}, q: {en:"First Rukun of Salah?", ms:"Rukun Solat pertama?"}, a: {en:["Al-Fatihah","Ruku","Niyyah","Takbir"], ms:["Al-Fatihah","Rukuk","Niat","Takbir"]}, c: 2 },
            { cat: {en:"Fardhu Ain", ms:"Fardu Ain"}, q: {en:"Reciting Al-Fatihah is?", ms:"Hukum baca Al-Fatihah?"}, a: {en:["Sunnah","Makruh","Rukun","Harus"], ms:["Sunat","Makruh","Rukun","Harus"]}, c: 2 },
            { cat: {en:"Fardhu Ain", ms:"Fardu Ain"}, q: {en:"Water for purification?", ms:"Air untuk bersuci?"}, a: {en:["Mutlaq","Musta'mal","Juice","Coffee"], ms:["Mutlak","Musta'mal","Jus","Kopi"]}, c: 0 },
            
            // --- QURAN ---
            { cat: {en:"Quran", ms:"Al-Quran"}, q: {en:"Shortest Surah?", ms:"Surah terpendek?"}, a: {en:["Al-Ikhlas","Al-Nas","Al-Kawthar","Al-Asr"], ms:["Al-Ikhlas","An-Nas","Al-Kawthar","Al-Asr"]}, c: 2 },
            { cat: {en:"Quran", ms:"Al-Quran"}, q: {en:"Taurat revealed to?", ms:"Taurat diturunkan kepada?"}, a: {en:["Isa","Musa","Dawud","Ibrahim"], ms:["Isa","Musa","Daud","Ibrahim"]}, c: 1 },
            { cat: {en:"Quran", ms:"Al-Quran"}, q: {en:"Quran revelation period?", ms:"Tempoh turun Al-Quran?"}, a: {en:["10 years","23 years","25 years","40 years"], ms:["10 tahun","23 tahun","25 tahun","40 tahun"]}, c: 1 },
            { cat: {en:"Quran", ms:"Al-Quran"}, q: {en:"Surah without Bismillah?", ms:"Surah tanpa Bismillah?"}, a: {en:["At-Tawbah","Al-Fatiha","Yasin","Al-Mulk"], ms:["At-Taubah","Al-Fatihah","Yasin","Al-Mulk"]}, c: 0 },
            { cat: {en:"Quran", ms:"Al-Quran"}, q: {en:"Surah 'The Bee'?", ms:"Surah 'Lebah'?"}, a: {en:["An-Nahl","An-Naml","Al-Ankabut","Al-Baqarah"], ms:["An-Nahl","An-Naml","Al-Ankabut","Al-Baqarah"]}, c: 0 },

            // --- SIRAH ---
            { cat: {en:"Sirah", ms:"Sirah"}, q: {en:"'As-Siddiq' Companion?", ms:"Sahabat 'As-Siddiq'?"}, a: {en:["Abu Bakr","Umar","Ali","Uthman"], ms:["Abu Bakar","Umar","Ali","Uthman"]}, c: 0 },
            { cat: {en:"Sirah", ms:"Sirah"}, q: {en:"First wife of Prophet?", ms:"Isteri pertama Nabi?"}, a: {en:["Aisha","Khadijah","Hafsah","Fatimah"], ms:["Aisyah","Khadijah","Hafsah","Fatimah"]}, c: 1 },
            { cat: {en:"Sirah", ms:"Sirah"}, q: {en:"Battle in Ramadan?", ms:"Perang dalam Ramadan?"}, a: {en:["Uhud","Badar","Khandaq","Tabuk"], ms:["Uhud","Badar","Khandaq","Tabuk"]}, c: 1 },
            { cat: {en:"Sirah", ms:"Sirah"}, q: {en:"First Muazzin?", ms:"Muazzin pertama?"}, a: {en:["Bilal","Zaid","Mus'ab","Salman"], ms:["Bilal","Zaid","Mus'ab","Salman"]}, c: 0 },
            { cat: {en:"Sirah", ms:"Sirah"}, q: {en:"Prophet died in?", ms:"Nabi wafat di?"}, a: {en:["Makkah","Madinah","Taif","Jerusalem"], ms:["Makkah","Madinah","Taif","Baitulmaqdis"]}, c: 1 },

            // --- PROPHETS ---
            { cat: {en:"Prophets", ms:"Para Nabi"}, q: {en:"Swallowed by whale?", ms:"Ditelan ikan nun?"}, a: {en:["Musa","Yunus","Yusuf","Yahya"], ms:["Musa","Yunus","Yusuf","Yahya"]}, c: 1 },
            { cat: {en:"Prophets", ms:"Para Nabi"}, q: {en:"Father of mankind?", ms:"Bapa manusia?"}, a: {en:["Adam","Nuh","Ibrahim","Idris"], ms:["Adam","Nuh","Ibrahim","Idris"]}, c: 0 },
            { cat: {en:"Prophets", ms:"Para Nabi"}, q: {en:"Spoke to animals?", ms:"Bicara dengan haiwan?"}, a: {en:["Sulaiman","Daud","Musa","Isa"], ms:["Sulaiman","Daud","Musa","Isa"]}, c: 0 },
            { cat: {en:"Prophets", ms:"Para Nabi"}, q: {en:"Thrown into fire?", ms:"Dicampak ke api?"}, a: {en:["Musa","Ibrahim","Yusuf","Isa"], ms:["Musa","Ibrahim","Yusuf","Isa"]}, c: 1 },

            // --- HISTORY ---
            { cat: {en:"History", ms:"Sejarah"}, q: {en:"Father of Algebra?", ms:"Bapa Algebra?"}, a: {en:["Al-Khwarizmi","Al-Kindi","Al-Farabi","Ibn Battuta"], ms:["Al-Khwarizmi","Al-Kindi","Al-Farabi","Ibnu Batutah"]}, c: 0 },
            { cat: {en:"History", ms:"Sejarah"}, q: {en:"Conqueror of Constantinople?", ms:"Penakluk Konstantinopel?"}, a: {en:["Suleiman","Mehmed II","Selim","Murad"], ms:["Suleiman","Al-Fatih","Selim","Murad"]}, c: 1 },
            { cat: {en:"History", ms:"Sejarah"}, q: {en:"Liberator of Jerusalem?", ms:"Pembebas Baitulmaqdis?"}, a: {en:["Salahuddin","Tariq","Khalid","Saad"], ms:["Salahuddin","Tariq","Khalid","Saad"]}, c: 0 },
            { cat: {en:"History", ms:"Sejarah"}, q: {en:"Author 'Sabilal Muhtadin'?", ms:"Pengarang 'Sabilal Muhtadin'?"}, a: {en:["Hamzah Fansuri","Arsyad Al-Banjari","Tok Kenali","Wali Songo"], ms:["Hamzah Fansuri","Arsyad Al-Banjari","Tok Kenali","Wali Songo"]}, c: 1 },
            { cat: {en:"History", ms:"Sejarah"}, q: {en:"Founder of Malacca?", ms:"Pengasas Melaka?"}, a: {en:["Tun Perak","Parameswara","Hang Tuah","Sultan Muzaffar"], ms:["Tun Perak","Parameswara","Hang Tuah","Sultan Muzaffar"]}, c: 1 }
        ];

        /* INIT & LANGUAGE CHECK */
        window.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('wsl_lang');
            if (savedLang && (savedLang === 'ms' || savedLang === 'en')) {
                currentLang = savedLang;
            }
            updateUIText();
            renderCategoryGrid();
        });

        function updateUIText() {
            const t = TEXTS[currentLang];
            document.getElementById('lbl-title').textContent = t.title;
            document.getElementById('lbl-subtitle').textContent = t.subtitle;
            document.getElementById('btn-timed').textContent = t.timed;
            document.getElementById('btn-free').textContent = t.free;
            document.getElementById('lbl-exit').textContent = t.exit;
            document.getElementById('lbl-exit-game').textContent = t.backMenu; // "Menu" button
            
            document.getElementById('lbl-score').textContent = t.score;
            document.getElementById('lbl-time').textContent = t.time;
            document.getElementById('endTitle').textContent = t.complete;
            document.getElementById('lbl-final-score').textContent = t.finalScore;
            document.getElementById('lbl-back-menu').textContent = t.backMenu;
            
            document.getElementById('btnPrev').textContent = t.prev;
        }

        /* START SCREEN LOGIC */
        function setMode(mode) {
            selectedMode = mode;
            const slider = document.getElementById('modeSlider');
            const btnTimed = document.getElementById('btn-timed');
            const btnFree = document.getElementById('btn-free');

            if (mode === 'timed') {
                slider.style.transform = 'translateX(0)';
                btnTimed.classList.add('active');
                btnFree.classList.remove('active');
            } else {
                slider.style.transform = 'translateX(100%)';
                btnFree.classList.add('active');
                btnTimed.classList.remove('active');
            }
        }

        function renderCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';
            
            // 1. Extract Unique Categories
            const categories = {};
            DB.forEach(item => {
                const enKey = item.cat.en;
                if (!categories[enKey]) {
                    categories[enKey] = {
                        en: item.cat.en,
                        ms: item.cat.ms,
                        count: 0
                    };
                }
                categories[enKey].count++;
            });

            // 2. Add "All Topics" Button
            const allBtn = document.createElement('div');
            allBtn.className = 'cat-card';
            allBtn.style.backgroundColor = 'var(--primary-light)';
            allBtn.style.borderColor = 'var(--primary)';
            allBtn.onclick = () => startGame('all');
            allBtn.innerHTML = `
                <div class="cat-icon">üåé</div>
                <div>
                    <div class="cat-name" style="color:var(--primary)">${TEXTS[currentLang].allTopics}</div>
                    <div class="cat-count">${DB.length} Qs</div>
                </div>
            `;
            grid.appendChild(allBtn);

            // 3. Add Other Categories
            // Map simple icons to categories for flair
            const icons = {
                "General": "üïå", "Fardhu Ain": "ü§≤", "Quran": "üìñ", 
                "Sirah": "üìú", "Prophets": "üë≥", "History": "‚öîÔ∏è", "Science": "üß™"
            };

            Object.values(categories).forEach(cat => {
                const btn = document.createElement('div');
                btn.className = 'cat-card';
                btn.onclick = () => startGame(cat.en);
                const icon = icons[cat.en] || "‚ú®";
                
                btn.innerHTML = `
                    <div class="cat-icon">${icon}</div>
                    <div>
                        <div class="cat-name">${currentLang === 'ms' ? cat.ms : cat.en}</div>
                        <div class="cat-count">${cat.count} Qs</div>
                    </div>
                `;
                grid.appendChild(btn);
            });
        }

        /* GAME LOGIC */
        let currentQ = 0;
        let score = 0;
        let timeLeft = 15;
        let timerInt = null;
        let isFreeMode = false;
        let activeQuestions = []; 
        let userAnswers = {}; 

        function goBack() {
            if (window.parent && window.parent.closeReader) window.parent.closeReader();
            else window.location.href = 'index.html';
        }

        function returnToMenu() {
            if(timerInt) clearInterval(timerInt);
            document.getElementById('gameUI').classList.add('hidden');
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        }

        function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

        function startGame(categoryKey) {
            isFreeMode = (selectedMode === 'free');
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameUI').classList.remove('hidden');
            
            currentQ = 0; score = 0; userAnswers = {};
            
            // Filter DB based on category
            let pool = [];
            if (categoryKey === 'all') {
                pool = [...DB];
            } else {
                pool = DB.filter(i => i.cat.en === categoryKey);
            }

            // Shuffle and slice (limit to 20 or max available)
            activeQuestions = shuffle(pool).slice(0, 20); 
            document.getElementById('totalQ').innerText = activeQuestions.length;

            // UI Setup
            if (isFreeMode) {
                document.getElementById('timerBox').style.visibility = 'hidden';
                document.getElementById('timerBarBg').style.display = 'none';
                document.getElementById('navControls').classList.remove('hidden');
            } else {
                document.getElementById('timerBox').style.visibility = 'visible';
                document.getElementById('timerBarBg').style.display = 'block';
                document.getElementById('navControls').classList.add('hidden');
            }
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQ >= activeQuestions.length) return endGame();

            const qData = activeQuestions[currentQ];
            timeLeft = 15;
            
            document.getElementById('qNum').innerText = currentQ + 1;
            document.getElementById('score').innerText = score;
            document.getElementById('timer').innerText = timeLeft;
            document.getElementById('timeBar').style.width = '100%';
            
            document.getElementById('question').innerText = qData.q[currentLang];
            document.getElementById('catTag').innerText = qData.cat[currentLang];
            
            const optsDiv = document.getElementById('options');
            optsDiv.innerHTML = '';
            
            const savedAnswer = userAnswers[currentQ];
            const isAnswered = (savedAnswer !== undefined);

            qData.a[currentLang].forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = opt;
                if (isAnswered) {
                    btn.classList.add('disabled');
                    if (idx === qData.c) btn.classList.add('correct');
                    if (idx === savedAnswer && idx !== qData.c) btn.classList.add('wrong');
                } else {
                    btn.onclick = () => checkAnswer(idx, btn, qData.c);
                }
                optsDiv.appendChild(btn);
            });

            if (isFreeMode) {
                const t = TEXTS[currentLang];
                const btnPrev = document.getElementById('btnPrev');
                const btnNext = document.getElementById('btnNext');
                btnPrev.disabled = (currentQ === 0);
                
                if (currentQ === activeQuestions.length - 1) {
                    btnNext.innerText = t.finish;
                    btnNext.classList.add('active'); 
                } else {
                    btnNext.innerText = t.next;
                    isAnswered ? btnNext.classList.add('active') : btnNext.classList.remove('active'); 
                }
            } else {
                startTimer();
            }
        }

        function startTimer() {
            if(timerInt) clearInterval(timerInt);
            timerInt = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                document.getElementById('timeBar').style.width = (timeLeft/15 * 100) + '%';
                if(timeLeft <= 0) { clearInterval(timerInt); handleTimeOut(); }
            }, 1000);
        }

        function checkAnswer(selectedIdx, btn, correctIdx) {
            if(timerInt) clearInterval(timerInt);
            userAnswers[currentQ] = selectedIdx;

            const buttons = document.querySelectorAll('.opt-btn');
            buttons.forEach(b => b.classList.add('disabled'));

            if(selectedIdx === correctIdx) {
                btn.classList.add('correct');
                score += isFreeMode ? 100 : (10 + Math.ceil(timeLeft / 2)); 
            } else {
                btn.classList.add('wrong');
                buttons[correctIdx].classList.add('correct'); 
            }

            if (isFreeMode) {
                document.getElementById('btnNext').classList.add('active');
                document.getElementById('score').innerText = score;
            } else {
                document.getElementById('score').innerText = score;
                setTimeout(() => { currentQ++; loadQuestion(); }, 1500);
            }
        }

        function handleTimeOut() {
            const qData = activeQuestions[currentQ];
            const buttons = document.querySelectorAll('.opt-btn');
            buttons[qData.c].classList.add('correct');
            buttons.forEach(b => b.classList.add('disabled'));
            setTimeout(() => { currentQ++; loadQuestion(); }, 1500);
        }

        function prevQuestion() { if (currentQ > 0) { currentQ--; loadQuestion(); } }
        function nextQuestion() { if (currentQ < activeQuestions.length) { currentQ++; if (currentQ === activeQuestions.length) endGame(); else loadQuestion(); } }

        function endGame() {
            if(timerInt) clearInterval(timerInt);
            document.getElementById('gameUI').classList.add('hidden');
            document.getElementById('endScreen').classList.remove('hidden');
            document.getElementById('finalScore').innerText = score;
        }
    </script>
</body>
</html>
