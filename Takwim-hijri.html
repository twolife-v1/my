<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Takwim Hijri — Calendar</title>
<style>
:root{--primary:#A67734;--muted:#666;--card:rgba(255,255,255,0.36);--glass-blur:4px}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:linear-gradient(180deg,#fff 0%,#f6f4ef 100%);color:#222}

/* --- SCALED DOWN SIZING --- */
.header{padding:8px;display:flex;justify-content:space-between;align-items:center;gap:6px;flex-wrap:wrap}
.brand{font-weight:700;color:var(--primary);font-size:14px}
.controls{display:flex;gap:4px;align-items:center;flex-wrap:wrap}
.controls input,.controls select{padding:4px;border-radius:6px;border:1px solid #ddd;background:#fff;font-size:12px}
.btn{background:var(--primary);color:#fff;padding:4px 8px;border-radius:6px;border:0;cursor:pointer;font-size:12px;}

.wrap{
    max-width:100%;
    margin:4px auto;
    padding:0;
    font-size: 13px;
}
.month-head{display:flex;justify-content:space-between;align-items:center;gap:6px;margin:4px 0;flex-wrap:wrap}
.weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-top:4px}
.weekday{text-align:center;color:var(--muted);font-size:11px;padding:3px}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-top:4px}

.day{
    background:var(--card);
    backdrop-filter:blur(var(--glass-blur));
    min-height:45px;
    border-radius:6px;
    padding:4px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;cursor:pointer;transition:transform .12s;position:relative
}
.day:hover{transform:translateY(-2px)}
.gdate{font-weight:700;font-size:13px;}
.hdate{font-size:10px;color:var(--primary);margin-top:2px}
.outside{opacity:.35}
.badge{position:absolute;right:4px;top:4px;background:rgba(166,119,52,0.12);padding:1px 4px;border-radius:999px;font-size:9px;color:var(--primary)}

.footer{margin-top:6px;padding:6px;background:#fff;border-radius:6px;box-shadow:0 4px 10px rgba(0,0,0,0.04);display:flex;justify-content:space-between;align-items:center;gap:6px;flex-wrap:wrap}
.small-muted{font-size:11px;color:var(--muted)}

.modal-back{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);visibility:hidden;opacity:0;transition:opacity .18s;z-index:999}
.modal-back.show{visibility:visible;opacity:1}
.modal{width:96%;max-width:500px;background:#fff;border-radius:8px;padding:8px;box-shadow:0 10px 30px rgba(0,0,0,0.18)}
.modal-body{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px !important;}
.prayers{flex:1 1 180px;display:flex;flex-direction:column;gap:4px;font-size:13px;}
.prayer{display:flex;justify-content:space-between;padding:6px;border-radius:6px;background:#f5f5f5}
.holidays{flex:1 1 120px;font-size:13px;}
.holiday-item{background:#fff3f0;padding:6px;border-radius:6px;margin-bottom:4px}

.day.today{border:2px solid var(--primary);background:rgba(166,119,52,0.15);}
.day.searched{border:2px dashed var(--primary);background:rgba(255,223,186,0.3);}
@media(max-width:420px){.day{min-height:40px;padding:3px}.gdate{font-size:12px}.hdate{font-size:9px}}
</style>
</head>
<body>
  <div class="header">
    <div class="brand">Takwim Hijri</div>
    <div class="controls">
      <input id="searchDay" type="number" min="1" max="31" placeholder="DD" style="width:40px">
      <select id="searchMonth"></select>
      <input id="searchYear" type="number" placeholder="YYYY" style="width:60px">
      <button id="goBtn" class="btn">Go</button>
    </div>
  </div>

  <div class="wrap">
    <div class="month-head">
      <div>
        <div id="monthYearTitle" class="month-title"></div>
        <div class="small-muted" id="globalYears"></div>
      </div>
      <div style="display:flex;gap:4px;align-items:center">
        <button id="prev" class="btn">◀</button>
        <button id="next" class="btn">▶</button>
        <button id="todayBtn" class="btn">Today</button>
      </div>
    </div>

    <div class="weekdays">
      <div class="weekday">Sun</div><div class="weekday">Mon</div><div class="weekday">Tue</div>
      <div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div>
    </div>

    <div class="grid" id="calendarGrid" aria-live="polite"></div>

    <div class="footer">
      <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap">
        <div class="small-muted">Loc:</div>
        <input id="lat" placeholder="lat" style="width:70px;padding:4px;border-radius:6px;border:1px solid #ddd" value="3.046">
        <input id="lng" placeholder="lng" style="width:70px;padding:4px;border-radius:6px;border:1px solid #ddd" value="101.58">
        <input id="tz" placeholder="UTC" style="width:40px;padding:4px;border-radius:6px;border:1px solid #ddd" value="8">
        
        <button id="recalc" class="btn">Recalc</button>
      </div>
      <div style="text-align:right;">
        <div class="small-muted">Note: hijri/holiday dates are approx.</div>
      </div>
    </div>
  </div>

  <div class="modal-back" id="modalBack">
    <div class="modal">
      <button id="closeModal" style="float:right;border:0;background:transparent;cursor:pointer;font-size:18px">✕</button>
      <h3 id="modalTitle" style="font-size:16px; margin: 4px 0;"></h3>
      <div class="small-muted" id="modalSub"></div>
      <div class="modal-body">
        <div class="prayers" id="prayersBox"></div>
        <div class="holidays" id="holidaysBox"></div>
      </div>
    </div>
  </div>

<script>
/* ----------------------------------------------------- */
/* INJECTED UTILITIES FROM index (4).html               */
/* ----------------------------------------------------- */
const APP = { location: null, use24:false, kaaba:{lat:21.422487, lon:39.826206} };
const storage = { get(k){try{return JSON.parse(localStorage.getItem(k))}catch(e){return null}}, set(k,v){localStorage.setItem(k,JSON.stringify(v))} };
// MODIFIED: Added Imsak to default timings
const DEFAULT_TIMINGS = {Imsak:'05:35', Fajr:'05:45',Dhuhr:'13:00',Asr:'16:30',Maghrib:'19:00',Isha:'20:15'};

// Placeholder for Reverse Geocoding
async function reverseGeocode(lat, lon) {
  return "Current GPS Location"; 
}

// Format time (reusing function from index.html)
function formatTime(t){
  if(!t) return '--:--';
  const [h,m]=t.split(':').map(n=>parseInt(n));
  const dt=new Date(); dt.setHours(h,m,0,0);
  return dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:true});
}

// Get user location (reusing function from index.html)
async function getLocation(){
  let loc=storage.get('loc') || APP.location;
  if(loc?.lat && loc?.lon && loc?.name) { 
      APP.location=loc; 
      document.getElementById('lat').value = loc.lat;
      document.getElementById('lng').value = loc.lon;
      return loc; 
  }
  
  if(navigator.geolocation){
    try{
      const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:12000,enableHighAccuracy:true}));
      const name = await reverseGeocode(pos.coords.latitude, pos.coords.longitude);
      loc = { lat: pos.coords.latitude, lon: pos.coords.longitude, name };
      
      APP.location = loc;
      storage.set('loc', loc);
      document.getElementById('lat').value = loc.lat;
      document.getElementById('lng').value = loc.lon;
      return loc;
      
    }catch(e){
        console.warn('Geolocation error (user denied or timeout):', e);
    }
  }
  // Set Fallback location to Subang Jaya
  const fallbackLoc = { lat: 3.046, lon: 101.58, name: 'Subang Jaya (Default)' };
  APP.location = fallbackLoc;
  return fallbackLoc;
}

// Fetch accurate prayer times (reusing function from index.html)
async function fetchOnlinePrayerTimes(lat, lon) {
  try {
    // Using method 11 (Singapore/JAKIM Proxy)
    let apiMethod = 11; 
    const ts = Math.floor(Date.now() / 1000);
    
    const res = await fetch(`https://api.aladhan.com/v1/timings/${ts}?latitude=${lat}&longitude=${lon}&method=${apiMethod}`);
    const data = await res.json();
    const timings = { 
        // ADDED: Imsak extraction
        Imsak: data.data.timings.Imsak,
        Fajr: data.data.timings.Fajr, 
        Dhuhr: data.data.timings.Dhuhr, 
        Asr: data.data.timings.Asr, 
        Maghrib: data.data.timings.Maghrib, 
        Isha: data.data.timings.Isha
        // REMOVED: Sunrise
    };
    localStorage.setItem('lastPrayerTimes', JSON.stringify(timings));
    return timings;
  } catch(e) {
    console.warn("API Error: Unable to fetch fresh data.");
    return null;
  }
}
/* ----------------------------------------------------- */
/* END INJECTED UTILITIES                               */
/* ----------------------------------------------------- */

/* ====== Hijri Utilities ====== */
const hijriMonths = ['Muharram','Safar','Rabiul-Awal','Rabiul-Akhir','Jamadil-Awal','Jamadil-Akhir','Rejab','Syaaban','Ramadhan','Shawal','Dzul-Qaedah','Dzul-Hijjah'];

function jdFromDate(y,m,d){ var a = Math.floor((14-m)/12); var y2=y+4800-a; var m2=m+12*a-3; return d + Math.floor((153*m2+2)/5) + 365*y2 + Math.floor(y2/4) - Math.floor(y2/100)+Math.floor(y2/400)-32045; }
function islamicToJd(y,m,d){return d+Math.ceil(29.5*(m-1)) + (y-1)*354 + Math.floor((3+11*y)/30)+1948440-1;}
function jdToIslamic(jd){jd=Math.floor(jd)+0.5; var days=jd-1948439.5; var y=Math.floor((30*days+10646)/10631); var m=Math.min(12,Math.ceil((jd-islamicToJd(y,1,1)+1)/29.5)); var d=jd-islamicToJd(y,m,1)+1; return {iy:y,im:m,id:Math.floor(d)};}
function formatIslamic(i){return i.id + ' ' + hijriMonths[i.im-1] + ' ' + i.iy;}

/* ====== Prayer Times Algorithm (Simplified Fallback ONLY) ====== */
var PT=(function(){
  function dtr(d){return d*Math.PI/180;}
  function rtd(r){return r*180/Math.PI;}
  function sin(d){return Math.sin(dtr(d));}
  function cos(d){return Math.cos(dtr(d));}
  function fixHour(h){h=h%24; if(h<0) h+=24; return h;}
  function julianDate(y,m,d){return jdFromDate(y,m,d)-0.5;}
  function sunPos(jd){
    var D=jd-2451545.0; var g=(357.529+0.98560028*D)%360; var q=(280.459+0.98564736*D)%360;
    var L=(q+1.915*Math.sin(dtr(g))+0.02*Math.sin(dtr(2*g)))%360;
    var e=23.439-0.00000036*D;
    var RA=rtd(Math.atan2(Math.cos(dtr(e))*Math.sin(dtr(L)), Math.cos(dtr(L))))/15;
    var decl=rtd(Math.asin(Math.sin(dtr(e))*Math.sin(dtr(L))));
    var eqt=(q/15-RA); return {decl:decl, eqt:eqt};
  }
  function hourAngle(lat, decl, angle){ var term=(Math.sin(dtr(angle))-Math.sin(dtr(lat))*Math.sin(dtr(decl)))/(Math.cos(dtr(lat))*Math.cos(dtr(decl))); if(term>1)term=1;if(term<-1)term=-1; return rtd(Math.acos(term))/15;}
  function toTimeStr(t){var H=Math.floor(t);var M=Math.floor((t-H)*60+0.5); if(M===60){H+=1;M=0;} H=(H+24)%24; var ap=H>=12?'PM':'AM'; var h12=H%12; if(h12===0)h12=12; return String(h12).padStart(2,'0')+':'+String(M).padStart(2,'0')+' '+ap;}
  // Helper to subtract 10 minutes for Imsak (for fallback)
  function subtract10Minutes(timeStr) {
      if (!timeStr) return '--:--';
      const [h, m] = timeStr.split(':').map(Number);
      let totalMinutes = h * 60 + m - 10;
      let newH = Math.floor(totalMinutes / 60);
      let newM = totalMinutes % 60;
      if (newM < 0) { newM += 60; newH -= 1; }
      if (newH < 0) { newH += 24; }
      return String(newH).padStart(2, '0') + ':' + String(newM).padStart(2, '0');
  }

  return {
    getTimes:function(date,coords,tz){
      var y=date.getFullYear(), m=date.getMonth()+1, d=date.getDate();
      var jd=julianDate(y,m,d); var sp=sunPos(jd);
      var lat=coords.lat||0,lng=coords.lng||0; var noon=fixHour(12-sp.eqt-(lng/15)+tz);

      var FajrAngle = -20; // JAKIM/Singapore angle
      var IshaAngle = -18; // JAKIM/Singapore angle
      var MaghribAngle = 0.833;

      var fajr=noon-hourAngle(lat,sp.decl,FajrAngle);
      // Sunrise calculation removed
      var dhuhr=noon;
      
      var asrAlt = rtd(Math.atan(1 / (1 + Math.tan(Math.abs(dtr(lat - sp.decl))))));
      var asr = noon + hourAngle(lat, sp.decl, asrAlt);
      
      var maghrib=noon+hourAngle(lat,sp.decl,MaghribAngle);
      var isha=noon+hourAngle(lat,sp.decl,IshaAngle);
      
      const FajrTime = toTimeStr(fajr);

      return {
        Imsak: subtract10Minutes(FajrTime), // Calculated Imsak for fallback
        Fajr: FajrTime,
        // Sunrise:toTimeStr(sunrise), // REMOVED
        Dhuhr:toTimeStr(dhuhr),
        Asr:toTimeStr(asr),
        Maghrib:toTimeStr(maghrib),
        Isha:toTimeStr(isha)
      };
    }
  };
})();

/* ---------- Holidays (sample Malaysia) ---------- */
const publicHolidays=[{m:1,d:1,name:"New Year's Day"},{m:5,d:1,name:"Labour Day"},{m:8,d:31,name:"National Day"},{m:9,d:16,name:"Malaysia Day"},{m:12,d:25,name:"Christmas Day"}];
const islamicDays=[{im:1,id:1,name:'Islamic New Year'},{im:9,id:1,name:'Start of Ramadan (est.)'},{im:10,id:1,name:'Eid al-Fitr'},{im:12,id:9,name:'Arafah'},{im:12,id:10,name:'Eid al-Adha'}];

/* ---------- Calendar State ---------- */
let now=new Date(); let viewYear=now.getFullYear(); let viewMonth=now.getMonth(); let searchDay=null;
const monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const monthSelect=document.getElementById('searchMonth');
monthNames.forEach((n,i)=>{let o=document.createElement('option'); o.value=i+1; o.textContent=n; monthSelect.appendChild(o);});
document.getElementById('searchYear').value=viewYear;

function findPublicHoliday(gd){for(let h of publicHolidays) if(h.m===gd.getMonth()+1&&h.d===gd.getDate()) return h.name; return null;}
function findIslamicEvent(is){for(let e of islamicDays) if(e.im===is.im&&e.id===is.id) return e.name; return null;}

/* ---------- Events ---------- */
document.getElementById('prev').addEventListener('click',()=>{viewMonth--; if(viewMonth<0){viewMonth=11;viewYear--;} renderCalendar();});
document.getElementById('next').addEventListener('click',()=>{viewMonth++; if(viewMonth>11){viewMonth=0;viewYear++;} renderCalendar();});
document.getElementById('todayBtn').addEventListener('click',()=>{let t=new Date(); viewYear=t.getFullYear(); viewMonth=t.getMonth(); searchDay=null; renderCalendar();});
document.getElementById('recalc').addEventListener('click', renderCalendar);
document.getElementById('closeModal').addEventListener('click',()=>{document.getElementById('modalBack').classList.remove('show'); document.getElementById('modalBack').style.visibility='hidden';});
document.getElementById('goBtn').addEventListener('click',()=>{
  let dd=parseInt(document.getElementById('searchDay').value,10);
  let mm=parseInt(document.getElementById('searchMonth').value,10);
  let yy=parseInt(document.getElementById('searchYear').value,10);
  if(!yy) return alert('Enter year'); if(!mm) mm=1; if(!dd) dd=1;
  viewYear=yy; viewMonth=mm-1; searchDay={date:dd,month:mm-1,year:yy}; renderCalendar();
});

/* ---------- Render Calendar ---------- */
function renderCalendar(){
  const grid=document.getElementById('calendarGrid'); grid.innerHTML='';
  const first=new Date(viewYear,viewMonth,1); const startDay=first.getDay();
  const daysInMonth=new Date(viewYear,viewMonth+1,0).getDate();
  const totalCells=Math.ceil((startDay+daysInMonth)/7)*7;
  document.getElementById('monthYearTitle').textContent=first.toLocaleString(undefined,{month:'long'})+' '+viewYear;
  const firstJd=jdFromDate(viewYear,viewMonth+1,1), lastJd=jdFromDate(viewYear,viewMonth+1,daysInMonth);
  const firstIs=jdToIslamic(firstJd), lastIs=jdToIslamic(lastJd);
  document.getElementById('globalYears').textContent='Hijri: '+firstIs.iy+' — '+lastIs.iy;
  const today=new Date();

  for(let i=0;i<totalCells;i++){
    const cell=document.createElement('div'); cell.className='day';
    const cellIndex=i-startDay+1;
    let gd;
    if(i<startDay||cellIndex>daysInMonth){
      gd=new Date(viewYear,viewMonth,cellIndex); cell.classList.add('outside'); cell.innerHTML=`<div class="gdate">${gd.getDate()}</div>`;
    } else {
      const d=cellIndex; gd=new Date(viewYear,viewMonth,d);
      const jd=jdFromDate(gd.getFullYear(),gd.getMonth()+1,gd.getDate());
      const is=jdToIslamic(jd);
      cell.innerHTML=`<div class="gdate">${d}</div><div class="hdate">${is.id} ${hijriMonths[is.im-1]}</div>`;
      const pub=findPublicHoliday(gd); const iev=findIslamicEvent(is);
      if(pub) cell.innerHTML+=`<div class="badge">H</div>`;
      if(iev) cell.innerHTML+=`<div class="badge" style="right:26px">✪</div>`;
      if(gd.toDateString()===today.toDateString()) cell.classList.add('today');
      if(searchDay && gd.getDate()===searchDay.date && gd.getMonth()===searchDay.month && gd.getFullYear()===searchDay.year) cell.classList.add('searched');
      cell.addEventListener('click',()=>openModal(gd,is));
    }
    grid.appendChild(cell);
  }
}

/* ---------- Open Modal (FIXED) ---------- */
function openModal(gd,is){
  const modalBack=document.getElementById('modalBack'); modalBack.style.visibility='visible'; modalBack.classList.add('show');
  document.getElementById('modalTitle').textContent=gd.toDateString();
  document.getElementById('modalSub').textContent='Hijri: '+formatIslamic(is);

  const pb=document.getElementById('prayersBox'); pb.innerHTML='';
  
  let times;
  const todayDateStr = new Date().toDateString();
  const selectedDateStr = gd.toDateString();

  if (selectedDateStr === todayDateStr) {
      // Prioritize the timings cached from the main page (which uses method=11)
      times = JSON.parse(localStorage.getItem('lastPrayerTimes'));
  } 

  if (!times || !times.Imsak) {
      // If cached data is missing Imsak or is not present, use the simplified fallback or fetch fresh data
      const lat=parseFloat(document.getElementById('lat').value)||0;
      const lng=parseFloat(document.getElementById('lng').value)||0;
      const tz=parseFloat(document.getElementById('tz').value)||0;
      times=PT.getTimes(gd,{lat:lat,lng:lng},tz);
  }

  // FIXED: Removed Sunrise from the prayerOrder list
  const prayerOrder = ['Imsak', 'Fajr', 'Dhuhr','Asr','Maghrib','Isha'];
  
  // Render times
  prayerOrder.forEach(k=>{
    const timeStr = times ? (formatTime(times[k]) || '-') : '-';
    const r=document.createElement('div'); r.className='prayer';
    r.innerHTML=`<div>${k}</div><div style="font-weight:700">${timeStr}</div>`;
    pb.appendChild(r);
  });

  const hb=document.getElementById('holidaysBox'); hb.innerHTML='';
  
  const pub=findPublicHoliday(gd); 
  if(pub){ 
    const el=document.createElement('div'); 
    el.className='holiday-item'; 
    el.innerHTML=`<strong>Public</strong><div>${pub}</div>`; 
    hb.appendChild(el); 
  }
  
  const iev=findIslamicEvent(is); 
  if(iev){ 
    const el2=document.createElement('div'); 
    el2.className='holiday-item'; 
    el2.innerHTML=`<strong>Islamic</strong><div>${iev}</div>`; 
    hb.appendChild(el2); 
  }
  
  if(!pub && !iev) hb.innerHTML='<div class="small-muted">No public or islamic events on this date (edit list in script to add).</div>';
}

/* ---------- Initial Execution (MODIFIED) ---------- */
async function runTakwim() {
    await getLocation();
    
    const lat = parseFloat(document.getElementById('lat').value);
    const lng = parseFloat(document.getElementById('lng').value);
    // Fetch fresh data once to populate local storage correctly (method=11)
    await fetchOnlinePrayerTimes(lat, lng); 

    renderCalendar();
}

window.addEventListener('DOMContentLoaded', runTakwim);
</script>
</body>
</html>
