<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Takwim Hijri Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
    /* THEME VARIABLES (Synced with Mukmin.com) */
    :root[data-theme="light"] { 
        --primary: #A67734; --bg: #F8F9FA; --surface: #FFFFFF; 
        --text: #1F2937; --text-muted: #6B7280; --border: #E5E7EB; 
        --glass: rgba(255,255,255,0.95); --highlight: rgba(166,119,52,0.1); 
    }
    :root[data-theme="dark"] { 
        --primary: #D4AF37; --bg: #121212; --surface: #1E1E1E; 
        --text: #F3F4F6; --text-muted: #9CA3AF; --border: #374151; 
        --glass: rgba(30,30,30,0.95); --highlight: rgba(212,175,55,0.15); 
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    /* LAYOUT: Forces the body to fit exactly in the iframe height (320px) */
    body { 
        margin: 0; font-family: 'Inter', sans-serif; 
        background: var(--bg); color: var(--text); 
        height: 100vh; width: 100vw; overflow: hidden; 
        position: relative;
    }

    /* --- PAGE 1: CALENDAR VIEW --- */
    #view-calendar {
        height: 100%; display: flex; flex-direction: column;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* HEADER */
    .header { 
        padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; 
        background: var(--surface); border-bottom: 1px solid var(--border); 
        height: 50px; flex-shrink: 0;
    }
    .title-main { font-weight: 800; font-size: 15px; color: var(--primary); }
    .title-sub { font-family: 'Amiri', serif; font-size: 11px; color: var(--text-muted); margin-top: -2px; }
    
    .nav-group { display: flex; gap: 4px; }
    .btn-icon { 
        width: 28px; height: 28px; border-radius: 6px; border: 1px solid var(--border); 
        background: var(--surface); color: var(--text); display: flex; align-items: center; justify-content: center; 
        cursor: pointer; padding: 0;
    }
    .btn-today { font-size: 9px; font-weight: 700; width: auto; padding: 0 8px; }

    /* GRID */
    .calendar-body { flex: 1; padding: 5px; overflow-y: auto; display: flex; flex-direction: column; }
    .week-row { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 4px; }
    .w-day { font-size: 9px; text-align: center; color: var(--text-muted); font-weight: 700; }
    
    .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; flex: 1; align-content: start; }
    .day-cell {
        aspect-ratio: 1; background: var(--surface); border-radius: 6px; border: 1px solid var(--border);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        position: relative; cursor: pointer; transition: 0.1s;
    }
    .day-cell:active { transform: scale(0.92); background: var(--border); }
    .day-cell.today { background: var(--primary); border-color: var(--primary); }
    .day-cell.today * { color: white !important; }
    .day-cell.empty { background: transparent; border: none; pointer-events: none; }
    
    .num-g { font-weight: 700; font-size: 12px; }
    .num-h { font-family: 'Amiri', serif; font-size: 9px; color: var(--primary); margin-top: -2px; }
    
    .dot { width: 3px; height: 3px; border-radius: 50%; position: absolute; top: 3px; right: 3px; }
    .dot.islam { background: #22c55e; }
    .dot.public { background: #ef4444; }

    /* --- PAGE 2: DETAIL SLIDE (The "Modal") --- */
    #view-detail {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: var(--bg); z-index: 50;
        transform: translateY(100%); /* Hidden by default (pushed down) */
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex; flex-direction: column;
    }
    #view-detail.active { transform: translateY(0); } /* Slides Up to cover iframe */

    .detail-header {
        padding: 10px 15px; background: var(--surface); border-bottom: 1px solid var(--border);
        display: flex; align-items: center; gap: 10px; height: 50px; flex-shrink: 0;
    }
    .back-btn { 
        background: none; border: none; color: var(--text); font-size: 14px; 
        font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; 
    }
    
    .detail-content { flex: 1; overflow-y: auto; padding: 15px; }
    
    /* Detail Cards */
    .info-box { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .box-label { font-size: 10px; text-transform: uppercase; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; letter-spacing: 0.5px; }
    
    .date-lg { font-size: 20px; font-weight: 800; color: var(--primary); line-height: 1.1; }
    .hijri-lg { font-family: 'Amiri', serif; font-size: 14px; color: var(--text); }
    
    .prayer-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed var(--border); font-size: 12px; }
    .prayer-row:last-child { border-bottom: none; }
    
    .tag { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-right: 5px; margin-bottom: 4px; }
    .tag.red { background: rgba(239,68,68,0.1); color: #ef4444; }
    .tag.green { background: rgba(34,197,94,0.1); color: #16a34a; }

    /* SCROLLBAR HIDING */
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 10px; opacity: 0.3; }
</style>
</head>
<body>

    <div id="view-calendar">
        <div class="header">
            <div>
                <div id="mTitle" class="title-main">Loading...</div>
                <div id="hTitle" class="title-sub">...</div>
            </div>
            <div class="nav-group">
                <button class="btn-icon btn-today" onclick="goToday()">TODAY</button>
                <button class="btn-icon" onclick="changeMonth(-1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                <button class="btn-icon" onclick="changeMonth(1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
                </button>
            </div>
        </div>
        
        <div class="calendar-body">
            <div class="week-row">
                <div class="w-day">SUN</div><div class="w-day">MON</div><div class="w-day">TUE</div><div class="w-day">WED</div>
                <div class="w-day">THU</div><div class="w-day">FRI</div><div class="w-day">SAT</div>
            </div>
            <div id="grid" class="days-grid"></div>
        </div>
    </div>

    <div id="view-detail">
        <div class="detail-header">
            <button class="back-btn" onclick="closeDetail()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                BACK
            </button>
            <div style="font-size:12px; font-weight:700; color:var(--text-muted);">Detail View</div>
        </div>
        
        <div class="detail-content">
            <div class="info-box" style="text-align:center;">
                <div id="dDate" class="date-lg"></div>
                <div id="dHijri" class="hijri-lg"></div>
                <div id="dEvents" style="margin-top:8px;"></div>
            </div>

            <div class="info-box">
                <div class="box-label">Prayer Times</div>
                <div id="dPrayers"></div>
            </div>
            
            <div style="text-align:center; font-size:9px; color:var(--text-muted); opacity:0.5; margin-top:10px;">
                Times approximated for <span id="dLoc">KL</span>
            </div>
        </div>
    </div>

<script>
    /* --- STATE --- */
    const STORAGE = { 
        get(k) { try{ return JSON.parse(localStorage.getItem(k)) } catch(e){ return null } },
        set(k,v) { localStorage.setItem(k, JSON.stringify(v)) }
    };

    // Detect Theme
    const savedTheme = localStorage.getItem('wsl_theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    let currDate = new Date(); // Real Today
    let viewDate = new Date(); // Calendar View Month
    let userLoc = STORAGE.get('wsl_coords') || { lat: 3.1390, lon: 101.6869 };

    /* --- DATA --- */
    const HIJRI_M = ['Muharram','Safar','Rabiul Awal','Rabiul Akhir','Jamadil Awal','Jamadil Akhir','Rejab','Syaaban','Ramadan','Syawal','Zulkaedah','Zulhijjah'];
    const HOLIDAYS = [
        {m:1,d:1,n:"New Year"}, {m:5,d:1,n:"Labour Day"}, {m:8,d:31,n:"Merdeka"}, {m:9,d:16,n:"Malaysia Day"}, {m:12,d:25,n:"Christmas"}
    ];
    const ISLAMIC = [
        {im:1,id:1,n:'Maal Hijrah'}, {im:9,id:1,n:'Ramadan Starts'}, {im:10,id:1,n:'Aidilfitri'}, {im:12,id:10,n:'Aidiladha'}
    ];

    /* --- MATH: UPDATED TO MATCH INDEX.HTML --- */
    const PrayerCalc = {
        calc: function(lat, lng, timezone, date) {
            let julianDate = this.julian(date.getFullYear(), date.getMonth() + 1, date.getDate());
            return {
                Imsak: this.computeTime(19.5, julianDate, lat, lng, timezone, 'fajr') - (10/60), 
                Fajr: this.computeTime(20, julianDate, lat, lng, timezone, 'fajr'),
                Dhuhr: this.computeTime(0, julianDate, lat, lng, timezone, 'dhuhr'),
                Asr: this.computeTime(0, julianDate, lat, lng, timezone, 'asr'),
                Maghrib: this.computeTime(0.833, julianDate, lat, lng, timezone, 'maghrib'),
                Isha: this.computeTime(18, julianDate, lat, lng, timezone, 'isha')
            };
        },
        julian: function(year, month, day) {
            if (month <= 2) { year -= 1; month += 12; }
            let A = Math.floor(year / 100);
            let B = 2 - A + Math.floor(A / 4);
            return Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + B - 1524.5;
        },
        computeTime: function(angle, jd, lat, lng, tz, type) {
            let n = jd - 2451545.0;
            let g = 357.529 + 0.98560028 * n;
            let q = 280.459 + 0.98564736 * n;
            let L = q + 1.915 * Math.sin(g * Math.PI/180) + 0.020 * Math.sin(2 * g * Math.PI/180);
            let e = 23.439 - 0.00000036 * n;
            let RA = Math.atan2(Math.cos(e * Math.PI/180) * Math.sin(L * Math.PI/180), Math.cos(L * Math.PI/180)) * 180/Math.PI;
            RA = RA / 15; if(RA < 0) RA += 24;
            let D = Math.asin(Math.sin(e * Math.PI/180) * Math.sin(L * Math.PI/180)) * 180/Math.PI;
            let EqT = q/15 - RA;
            let HA = 0;
            let latRad = lat * Math.PI/180;
            let dRad = D * Math.PI/180;
            if(type === 'dhuhr') { HA = 0; } 
            else if (type === 'asr') {
                let alt = Math.atan(1 / (1 + Math.tan(Math.abs(lat - D) * Math.PI/180)));
                HA = Math.acos((Math.sin(alt) - Math.sin(latRad)*Math.sin(dRad)) / (Math.cos(latRad)*Math.cos(dRad))) * 180/Math.PI;
            } else {
                let factor = (type === 'maghrib' || type === 'fajr' && angle < 1) ? 0.833 : angle;
                let alt = -factor * Math.PI/180; 
                let cosHA = (Math.sin(alt) - Math.sin(latRad)*Math.sin(dRad)) / (Math.cos(latRad)*Math.cos(dRad));
                HA = (cosHA < -1 || cosHA > 1) ? 0 : Math.acos(cosHA) * 180/Math.PI;
            }
            let time = 12 + EqT;
            if (type === 'fajr') time = time - HA/15;
            else if (type !== 'dhuhr') time = time + HA/15;
            time = time + tz - lng/15;
            return (time + 24) % 24; 
        },
        getHijriDate: function(date) {
            let jd = this.julian(date.getFullYear(), date.getMonth() + 1, date.getDate());
            let l = jd - 1948440 + 10632;
            let n = Math.floor((l - 1) / 10631);
            let l1 = l - 10631 * n + 354;
            let j = (Math.floor((10985 - l1) / 5316)) * (Math.floor((50 * l1) / 17719)) + (Math.floor(l1 / 5670)) * (Math.floor((43 * l1) / 15238));
            let l2 = l1 - (Math.floor((30 - j) / 15)) * (Math.floor((17719 * j) / 50)) - (Math.floor(j / 16)) * (Math.floor((15238 * j) / 43)) + 29;
            let m = Math.floor((24 * l2) / 709);
            let d = l2 - Math.floor((709 * m) / 24);
            let y = 30 * n + j - 30;
            return { day: d, month: m - 1, year: y };
        }
    };

    // Helper to get Hijri only (using the same engine)
    function getHijriForGrid(y, m, d) {
        return PrayerCalc.getHijriDate(new Date(y, m, d));
    }

    /* --- UI LOGIC --- */
    function render() {
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        const firstDay = new Date(y, m, 1);
        const lastDay = new Date(y, m + 1, 0);
        
        // Titles
        document.getElementById('mTitle').textContent = firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        const startH = getHijriForGrid(y, m, 1);
        const endH = getHijriForGrid(y, m, lastDay.getDate());
        document.getElementById('hTitle').textContent = `${startH.day} ${HIJRI_M[startH.month]} - ${endH.day} ${HIJRI_M[endH.month]}`;

        // Grid
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        // Padding Days
        for(let i=0; i<firstDay.getDay(); i++) grid.innerHTML += `<div class="day-cell empty"></div>`;

        // Real Days
        for(let d=1; d<=lastDay.getDate(); d++) {
            const date = new Date(y, m, d);
            const isToday = (date.toDateString() === currDate.toDateString());
            const h = getHijriForGrid(y, m, d);
            
            // Note: Our Hijri engine is 0-indexed for month (0=Muharram), Array is 0-indexed
            // Holidays array is 1-indexed for month. Adjusted below:
            const pub = HOLIDAYS.find(x => x.m === m+1 && x.d === d);
            const isl = ISLAMIC.find(x => x.im === h.month+1 && x.id === h.day);

            const el = document.createElement('div');
            el.className = `day-cell ${isToday ? 'today' : ''}`;
            el.innerHTML = `
                <div class="num-g">${d}</div>
                <div class="num-h">${h.day}</div>
                ${isl ? '<div class="dot islam"></div>' : ''}
                ${pub ? '<div class="dot public" style="right:${isl?7:3}px"></div>' : ''}
            `;
            el.onclick = () => openDetail(date, h, pub, isl);
            grid.appendChild(el);
        }
    }

    function openDetail(date, h, pub, isl) {
        document.getElementById('dDate').textContent = date.toLocaleDateString('en-US', { weekday:'short', day:'numeric', month:'short' });
        document.getElementById('dHijri').textContent = `${h.day} ${HIJRI_M[h.month]} ${h.year}`;
        document.getElementById('dLoc').textContent = `Lat: ${userLoc.lat.toFixed(2)}`;

        // Events
        const evBox = document.getElementById('dEvents');
        evBox.innerHTML = '';
        if(pub) evBox.innerHTML += `<span class="tag red">${pub.n}</span>`;
        if(isl) evBox.innerHTML += `<span class="tag green">${isl.n}</span>`;

        // Prayers (Using New Engine)
        const tz = date.getTimezoneOffset() / -60;
        const raw = PrayerCalc.calc(userLoc.lat, userLoc.lon, tz, date);
        const fmt = (t) => { let h=Math.floor(t), m=Math.floor((t-h)*60); return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; };
        
        // Format the Raw Output
        const times = {
            Imsak: fmt(raw.Imsak), 
            Subuh: fmt(raw.Fajr), 
            Zohor: fmt(raw.Dhuhr), 
            Asar: fmt(raw.Asr), 
            Maghrib: fmt(raw.Maghrib), 
            Isyak: fmt(raw.Isha)
        };

        const pBox = document.getElementById('dPrayers');
        pBox.innerHTML = '';
        Object.entries(times).forEach(([k,v]) => {
            pBox.innerHTML += `
                <div class="prayer-row">
                    <span style="font-weight:500">${k}</span>
                    <span style="font-weight:700">${v}</span>
                </div>`;
        });

        document.getElementById('view-detail').classList.add('active');
    }

    function closeDetail() { document.getElementById('view-detail').classList.remove('active'); }
    function changeMonth(d) { viewDate.setMonth(viewDate.getMonth() + d); render(); }
    function goToday() { viewDate = new Date(); render(); }

    render();
</script>
</body>
</html>
