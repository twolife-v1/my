<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Takwim Hijri — Calendar</title>
<style>
:root{--primary:#A67734;--muted:#666;--card:rgba(255,255,255,0.36);--glass-blur:6px}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:linear-gradient(180deg,#fff 0%,#f6f4ef 100%);color:#222}
.header{padding:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.brand{font-weight:700;color:var(--primary);font-size:16px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.controls input,.controls select{padding:6px;border-radius:8px;border:1px solid #ddd;background:#fff;font-size:13px}
.btn{background:var(--primary);color:#fff;padding:6px 10px;border-radius:9px;border:0;cursor:pointer}
.wrap{max-width:1100px;margin:8px auto;padding:8px}
.month-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin:6px 0;flex-wrap:wrap}
.weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:6px}
.weekday{text-align:center;color:var(--muted);font-size:12px;padding:4px}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:6px}
.day{background:var(--card);backdrop-filter:blur(var(--glass-blur));min-height:70px;border-radius:8px;padding:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;cursor:pointer;transition:transform .12s;position:relative}
.day:hover{transform:translateY(-3px)}
.gdate{font-weight:700}
.hdate{font-size:11px;color:var(--primary);margin-top:4px}
.outside{opacity:.35}
.badge{position:absolute;right:8px;top:8px;background:rgba(166,119,52,0.12);padding:2px 6px;border-radius:999px;font-size:11px;color:var(--primary)}
.footer{margin-top:10px;padding:10px;background:#fff;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,0.04);display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap}
.modal-back{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);visibility:hidden;opacity:0;transition:opacity .18s;z-index:999}
.modal-back.show{visibility:visible;opacity:1}
.modal{width:94%;max-width:720px;background:#fff;border-radius:10px;padding:12px;box-shadow:0 20px 50px rgba(0,0,0,0.18)}
.modal-body{display:flex;gap:12px;flex-wrap:wrap}
.prayers{flex:1 1 220px;display:flex;flex-direction:column;gap:6px}
.prayer{display:flex;justify-content:space-between;padding:8px;border-radius:8px;background:#f5f5f5}
.holidays{flex:1 1 160px}
.holiday-item{background:#fff3f0;padding:8px;border-radius:8px;margin-bottom:6px}
.small-muted{font-size:12px;color:var(--muted)}
.day.today{border:2px solid var(--primary);background:rgba(166,119,52,0.15);}
.day.searched{border:2px dashed var(--primary);background:rgba(255,223,186,0.3);}
@media(max-width:420px){.day{min-height:56px;padding:5px}.gdate{font-size:13px}.hdate{font-size:10px}}
</style>
</head>
<body>
  <div class="header">
    <div class="brand">Takwim Hijri</div>
    <div class="controls">
      <input id="searchDay" type="number" min="1" max="31" placeholder="DD" style="width:64px">
      <select id="searchMonth"></select>
      <input id="searchYear" type="number" placeholder="YYYY" style="width:90px">
      <button id="goBtn" class="btn">Go</button>
    </div>
  </div>

  <div class="wrap">
    <div class="month-head">
      <div>
        <div id="monthYearTitle" class="month-title"></div>
        <div class="small-muted" id="globalYears"></div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <button id="prev" class="btn">◀</button>
        <button id="next" class="btn">▶</button>
        <button id="todayBtn" class="btn">Today</button>
      </div>
    </div>

    <div class="weekdays">
      <div class="weekday">Sun</div><div class="weekday">Mon</div><div class="weekday">Tue</div>
      <div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div>
    </div>

    <div class="grid" id="calendarGrid" aria-live="polite"></div>

    <div class="footer">
      <div class="small-muted">Hijri dates are approximate. Prayer times calculated by parent page.</div>
    </div>
  </div>

  <div class="modal-back" id="modalBack">
    <div class="modal">
      <button id="closeModal" style="float:right;border:0;background:transparent;cursor:pointer;font-size:18px">✕</button>
      <h3 id="modalTitle"></h3>
      <div class="small-muted" id="modalSub"></div>
      <div class="modal-body" style="margin-top:10px">
        <!-- Prayer times and holidays will be inserted here -->
        <div class="prayers" id="prayersBox">
          <div style="text-align:center; padding:16px;">Loading prayer times...</div>
        </div>
        <div class="holidays" id="holidaysBox"></div>
      </div>
    </div>
  </div>

<script>
/* ====== Hijri Utilities ====== */
const hijriMonths = ['Muharram','Safar','Rabiul-Awal','Rabiul-Akhir','Jamadil-Awal','Jamadil-Akhir','Rejab','Syaaban','Ramadhan','Shawal','Dzul-Qaedah','Dzul-Hijjah'];

function jdFromDate(y,m,d){ var a = Math.floor((14-m)/12); var y2=y+4800-a; var m2=m+12*a-3; return d + Math.floor((153*m2+2)/5) + 365*y2 + Math.floor(y2/4) - Math.floor(y2/100)+Math.floor(y2/400)-32045; }
function islamicToJd(y,m,d){return d+Math.ceil(29.5*(m-1)) + (y-1)*354 + Math.floor((3+11*y)/30)+1948440-1;}
function jdToIslamic(jd){jd=Math.floor(jd)+0.5; var days=jd-1948439.5; var y=Math.floor((30*days+10646)/10631); var m=Math.min(12,Math.ceil((jd-islamicToJd(y,1,1)+1)/29.5)); var d=jd-islamicToJd(y,m,1)+1; return {iy:y,im:m,id:Math.floor(d)};}
function formatIslamic(i){return i.id + ' ' + hijriMonths[i.im-1] + ' ' + i.iy;}

/* ---------- State and Globals ---------- */
let now=new Date(); 
let viewYear=now.getFullYear(); 
let viewMonth=now.getMonth(); 
let searchDay=null;
let pendingRequest = {}; // To store the details of the request while waiting for API response
let currentRequestId = 0; // Unique ID for each request

const monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const monthSelect=document.getElementById('searchMonth');
monthNames.forEach((n,i)=>{let o=document.createElement('option'); o.value=i+1; o.textContent=n; monthSelect.appendChild(o);});
document.getElementById('searchYear').value=viewYear;

/* ---------- Holidays (sample Malaysia) ---------- */
const publicHolidays=[{m:1,d:1,name:"New Year's Day"},{m:5,d:1,name:"Labour Day"},{m:8,d:31,name:"National Day"},{m:9,d:16,name:"Malaysia Day"},{m:12,d:25,name:"Christmas Day"}];
const islamicDays=[{im:1,id:1,name:'Islamic New Year'},{im:9,id:1,name:'Start of Ramadan (est.)'},{im:10,id:1,name:'Eid al-Fitr'},{im:12,id:9,name:'Arafah'},{im:12,id:10,name:'Eid al-Adha'}];

function findPublicHoliday(gd){for(let h of publicHolidays) if(h.m===gd.getMonth()+1&&h.d===gd.getDate()) return h.name; return null;}
function findIslamicEvent(is){for(let e of islamicDays) if(e.im===is.im&&e.id===is.id) return e.name; return null;}

/* ---------- Events ---------- */
document.getElementById('prev').addEventListener('click',()=>{viewMonth--; if(viewMonth<0){viewMonth=11;viewYear--;} renderCalendar();});
document.getElementById('next').addEventListener('click',()=>{viewMonth++; if(viewMonth>11){viewMonth=0;viewYear++;} renderCalendar();});
document.getElementById('todayBtn').addEventListener('click',()=>{let t=new Date(); viewYear=t.getFullYear(); viewMonth=t.getMonth(); searchDay=null; renderCalendar();});
document.getElementById('closeModal').addEventListener('click',()=>{document.getElementById('modalBack').classList.remove('show'); document.getElementById('modalBack').style.visibility='hidden';});
document.getElementById('goBtn').addEventListener('click',()=>{
  let dd=parseInt(document.getElementById('searchDay').value,10);
  let mm=parseInt(document.getElementById('searchMonth').value,10);
  let yy=parseInt(document.getElementById('searchYear').value,10);
  if(!yy) return console.error('Enter year'); 
  if(!mm) mm=1; 
  if(!dd) dd=1;
  viewYear=yy; viewMonth=mm-1; searchDay={date:dd,month:mm-1,year:yy}; renderCalendar();
});

/* ---------- Render Calendar ---------- */
function renderCalendar(){
  const grid=document.getElementById('calendarGrid'); grid.innerHTML='';
  const first=new Date(viewYear,viewMonth,1); const startDay=first.getDay();
  const daysInMonth=new Date(viewYear,viewMonth+1,0).getDate();
  const totalCells=Math.ceil((startDay+daysInMonth)/7)*7;
  document.getElementById('monthYearTitle').textContent=first.toLocaleString(undefined,{month:'long'})+' '+viewYear;
  const firstJd=jdFromDate(viewYear,viewMonth+1,1), lastJd=jdFromDate(viewYear,viewMonth+1,daysInMonth);
  const firstIs=jdToIslamic(firstJd), lastIs=jdToIslamic(lastJd);
  document.getElementById('globalYears').textContent='Hijri: '+firstIs.iy+' — '+lastIs.iy;
  const today=new Date();

  for(let i=0;i<totalCells;i++){
    const cell=document.createElement('div'); cell.className='day';
    const cellIndex=i-startDay+1;
    let gd;
    if(i<startDay||cellIndex>daysInMonth){
      gd=new Date(viewYear,viewMonth,cellIndex); cell.classList.add('outside'); cell.innerHTML=`<div class="gdate">${gd.getDate()}</div>`;
    } else {
      const d=cellIndex; gd=new Date(viewYear,viewMonth,d);
      const jd=jdFromDate(gd.getFullYear(),gd.getMonth()+1,gd.getDate());
      const is=jdToIslamic(jd);
      cell.innerHTML=`<div class="gdate">${d}</div><div class="hdate">${is.id} ${hijriMonths[is.im-1]}</div>`;
      const pub=findPublicHoliday(gd); const iev=findIslamicEvent(is);
      if(pub) cell.innerHTML+=`<div class="badge">H</div>`;
      if(iev) cell.innerHTML+=`<div class="badge" style="right:44px">✪</div>`;
      if(gd.toDateString()===today.toDateString()) cell.classList.add('today');
      if(searchDay && gd.getDate()===searchDay.date && gd.getMonth()===searchDay.month && gd.getFullYear()===searchDay.year) cell.classList.add('searched');
      cell.addEventListener('click',()=>openModal(gd,is));
    }
    grid.appendChild(cell);
  }
}

/**
 * Sends a request to the parent window (index.html) to fetch prayer times.
 * @param {Date} gd - Gregorian Date object.
 */
function requestPrayerTimes(gd) {
    const y=gd.getFullYear(), m=gd.getMonth()+1, d=gd.getDate();
    const dateStr = `${String(d).padStart(2, '0')}-${String(m).padStart(2, '0')}-${y}`;
    
    // Increment and store the request ID to match response
    currentRequestId++;
    const requestId = currentRequestId;

    // Show loading state
    const pb = document.getElementById('prayersBox');
    pb.innerHTML = '<div style="text-align:center; padding:16px;">Loading prayer times...</div>';

    // Send message to parent
    if (window.parent !== window) {
        window.parent.postMessage({
            type: 'PRAYER_TIME_REQUEST',
            payload: {
                dateStr: dateStr,
                // Note: We use a placeholder methodId (4) here, but the parent
                // is expected to override it with its own configured method.
                methodId: 4, 
                requestId: requestId
            }
        }, '*');
    } else {
        // Fallback for standalone view (no parent to request from)
        console.warn("Running standalone, cannot request prayer times from parent.");
        const pb = document.getElementById('prayersBox');
        pb.innerHTML = '<div style="text-align:center; padding:16px; color:red;">Cannot fetch prayer times (Run in main page to calculate).</div>';
    }
}

/* ---------- Open Modal ---------- */
function openModal(gd,is){
  const modalBack=document.getElementById('modalBack'); 
  modalBack.style.visibility='visible'; 
  modalBack.classList.add('show');
  document.getElementById('modalTitle').textContent=gd.toDateString();
  document.getElementById('modalSub').textContent='Hijri: '+formatIslamic(is);

  // Request prayer times from parent
  requestPrayerTimes(gd);

  // Load Holiday/Event data
  const hb=document.getElementById('holidaysBox'); hb.innerHTML='';
  const pub=findPublicHoliday(gd); 
  if(pub){ 
    const el=document.createElement('div'); el.className='holiday-item'; 
    el.innerHTML=`<strong>Public Holiday</strong><div>${pub}</div>`; 
    hb.appendChild(el); 
  }
  const iev=findIslamicEvent(is); 
  if(iev){ 
    const el2=document.createElement('div'); el2.className='holiday-item'; 
    el2.innerHTML=`<strong>Islamic Event</strong><div>${iev}</div>`; 
    hb.appendChild(el2); 
  }
  if(!pub && !iev) hb.innerHTML='<div class="small-muted">No public or islamic events on this date.</div>';
}

/* ---------- Handle Response from Parent ---------- */
window.addEventListener('message', (event) => {
    // Check if the message is a prayer time response from the parent
    if (event.data && event.data.type === 'PRAYER_TIME_RESPONSE') {
        const { timings, requestId } = event.data.payload;

        // Check if the modal is currently open and this is the latest request
        if (requestId === currentRequestId && document.getElementById('modalBack').classList.contains('show')) {
            const pb = document.getElementById('prayersBox');
            pb.innerHTML = '';
            
            const prayers = timings || { Fajr: '--:--', Sunrise: '--:--', Dhuhr: '--:--', Asr: '--:--', Maghrib: '--:--', Isha: '--:--'};

            ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'].forEach(k => {
                const r = document.createElement('div'); 
                r.className = 'prayer';
                r.innerHTML = `<div>${k}</div><div style="font-weight:700">${prayers[k] || '--:--'}</div>`;
                pb.appendChild(r);
            });
        }
    }
});

/* ---------- Initial Render ---------- */
renderCalendar();
</script>
</body>
</html>

