<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Takwim Hijri Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
    /* THEME VARIABLES (Synced with Mukmin.com) */
    :root[data-theme="light"] { 
        --primary: #A67734; --bg: #F8F9FA; --surface: #FFFFFF; 
        --text: #1F2937; --text-muted: #6B7280; --border: #E5E7EB; 
        --glass: rgba(255,255,255,0.95); --highlight: rgba(166,119,52,0.1); 
    }
    :root[data-theme="dark"] { 
        --primary: #D4AF37; --bg: #121212; --surface: #1E1E1E; 
        --text: #F3F4F6; --text-muted: #9CA3AF; --border: #374151; 
        --glass: rgba(30,30,30,0.95); --highlight: rgba(212,175,55,0.15); 
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    /* LAYOUT: Forces the body to fit exactly in the iframe height (320px) */
    body { 
        margin: 0; font-family: 'Inter', sans-serif; 
        background: var(--bg); color: var(--text); 
        height: 100vh; width: 100vw; overflow: hidden; 
        position: relative;
    }

    /* --- PAGE 1: CALENDAR VIEW --- */
    #view-calendar {
        height: 100%; display: flex; flex-direction: column;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* HEADER */
    .header { 
        padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; 
        background: var(--surface); border-bottom: 1px solid var(--border); 
        height: 50px; flex-shrink: 0;
    }
    .title-main { font-weight: 800; font-size: 15px; color: var(--primary); }
    .title-sub { font-family: 'Amiri', serif; font-size: 11px; color: var(--text-muted); margin-top: -2px; }
    
    .nav-group { display: flex; gap: 4px; }
    .btn-icon { 
        width: 28px; height: 28px; border-radius: 6px; border: 1px solid var(--border); 
        background: var(--surface); color: var(--text); display: flex; align-items: center; justify-content: center; 
        cursor: pointer; padding: 0;
    }
    .btn-today { font-size: 9px; font-weight: 700; width: auto; padding: 0 8px; }

    /* GRID */
    .calendar-body { flex: 1; padding: 5px; overflow-y: auto; display: flex; flex-direction: column; }
    .week-row { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 4px; }
    .w-day { font-size: 9px; text-align: center; color: var(--text-muted); font-weight: 700; }
    
    .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; flex: 1; align-content: start; }
    .day-cell {
        aspect-ratio: 1; background: var(--surface); border-radius: 6px; border: 1px solid var(--border);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        position: relative; cursor: pointer; transition: 0.1s;
    }
    .day-cell:active { transform: scale(0.92); background: var(--border); }
    .day-cell.today { background: var(--primary); border-color: var(--primary); }
    .day-cell.today * { color: white !important; }
    .day-cell.empty { background: transparent; border: none; pointer-events: none; }
    
    .num-g { font-weight: 700; font-size: 12px; }
    .num-h { font-family: 'Amiri', serif; font-size: 9px; color: var(--primary); margin-top: -2px; }
    
    .dot { width: 3px; height: 3px; border-radius: 50%; position: absolute; top: 3px; right: 3px; }
    .dot.islam { background: #22c55e; }
    .dot.public { background: #ef4444; }

    /* --- PAGE 2: DETAIL SLIDE (The "Modal") --- */
    #view-detail {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: var(--bg); z-index: 50;
        transform: translateY(100%); /* Hidden by default (pushed down) */
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex; flex-direction: column;
    }
    #view-detail.active { transform: translateY(0); } /* Slides Up to cover iframe */

    .detail-header {
        padding: 10px 15px; background: var(--surface); border-bottom: 1px solid var(--border);
        display: flex; align-items: center; gap: 10px; height: 50px; flex-shrink: 0;
    }
    .back-btn { 
        background: none; border: none; color: var(--text); font-size: 14px; 
        font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; 
    }
    
    .detail-content { flex: 1; overflow-y: auto; padding: 15px; }
    
    /* Detail Cards */
    .info-box { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .box-label { font-size: 10px; text-transform: uppercase; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; letter-spacing: 0.5px; }
    
    .date-lg { font-size: 20px; font-weight: 800; color: var(--primary); line-height: 1.1; }
    .hijri-lg { font-family: 'Amiri', serif; font-size: 14px; color: var(--text); }
    
    .prayer-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed var(--border); font-size: 12px; }
    .prayer-row:last-child { border-bottom: none; }
    
    .tag { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-right: 5px; margin-bottom: 4px; }
    .tag.red { background: rgba(239,68,68,0.1); color: #ef4444; }
    .tag.green { background: rgba(34,197,94,0.1); color: #16a34a; }

    /* SCROLLBAR HIDING */
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 10px; opacity: 0.3; }
</style>
</head>
<body>

    <div id="view-calendar">
        <div class="header">
            <div>
                <div id="mTitle" class="title-main">Loading...</div>
                <div id="hTitle" class="title-sub">...</div>
            </div>
            <div class="nav-group">
                <button class="btn-icon btn-today" onclick="goToday()">TODAY</button>
                <button class="btn-icon" onclick="changeMonth(-1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                <button class="btn-icon" onclick="changeMonth(1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
                </button>
            </div>
        </div>
        
        <div class="calendar-body">
            <div class="week-row">
                <div class="w-day">SUN</div><div class="w-day">MON</div><div class="w-day">TUE</div><div class="w-day">WED</div>
                <div class="w-day">THU</div><div class="w-day">FRI</div><div class="w-day">SAT</div>
            </div>
            <div id="grid" class="days-grid"></div>
        </div>
    </div>

    <div id="view-detail">
        <div class="detail-header">
            <button class="back-btn" onclick="closeDetail()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                BACK
            </button>
            <div style="font-size:12px; font-weight:700; color:var(--text-muted);">Detail View</div>
        </div>
        
        <div class="detail-content">
            <div class="info-box" style="text-align:center;">
                <div id="dDate" class="date-lg"></div>
                <div id="dHijri" class="hijri-lg"></div>
                <div id="dEvents" style="margin-top:8px;"></div>
            </div>

            <div class="info-box">
                <div class="box-label">Prayer Times</div>
                <div id="dPrayers"></div>
            </div>
            
            <div style="text-align:center; font-size:9px; color:var(--text-muted); opacity:0.5; margin-top:10px;">
                Times approximated for <span id="dLoc">KL</span>
            </div>
        </div>
    </div>

<script>
    /* --- STATE --- */
    const STORAGE = { 
        get(k) { try{ return JSON.parse(localStorage.getItem(k)) } catch(e){ return null } },
        set(k,v) { localStorage.setItem(k, JSON.stringify(v)) }
    };

    // Detect Theme
    const savedTheme = localStorage.getItem('wsl_theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    let currDate = new Date(); // Real Today
    let viewDate = new Date(); // Calendar View Month
    let userLoc = STORAGE.get('wsl_coords') || { lat: 3.1390, lon: 101.6869 };

    /* --- DATA --- */
    const HIJRI_M = ['Muharram','Safar','Rabiul Awal','Rabiul Akhir','Jamadil Awal','Jamadil Akhir','Rejab','Syaaban','Ramadan','Syawal','Zulkaedah','Zulhijjah'];
    const HOLIDAYS = [
        {m:1,d:1,n:"New Year"}, {m:5,d:1,n:"Labour Day"}, {m:8,d:31,n:"Merdeka"}, {m:9,d:16,n:"Malaysia Day"}, {m:12,d:25,n:"Christmas"}
    ];
    const ISLAMIC = [
        {im:1,id:1,n:'Maal Hijrah'}, {im:9,id:1,n:'Ramadan Starts'}, {im:10,id:1,n:'Aidilfitri'}, {im:12,id:10,n:'Aidiladha'}
    ];

    /* --- MATH --- */
    function jdFromDate(y,m,d){ var a=Math.floor((14-m)/12), y2=y+4800-a, m2=m+12*a-3; return d+Math.floor((153*m2+2)/5)+365*y2+Math.floor(y2/4)-Math.floor(y2/100)+Math.floor(y2/400)-32045; }
    function islamicToJd(y,m,d){ return d+Math.ceil(29.5*(m-1))+(y-1)*354+Math.floor((3+11*y)/30)+1948440-1; }
    function jdToIslamic(jd){ jd=Math.floor(jd)+0.5; var days=jd-1948439.5, y=Math.floor((30*days+10646)/10631), m=Math.min(12,Math.ceil((jd-islamicToJd(y,1,1)+1)/29.5)), d=jd-islamicToJd(y,m,1)+1; return {iy:y,im:m,id:Math.floor(d)}; }

    const PrayerCalc = {
        calc(date, lat, lng) {
            // Simplified Offline Algo (Matches Index.html logic)
            const D2R = Math.PI/180, R2D = 180/Math.PI;
            const jd = jdFromDate(date.getFullYear(), date.getMonth()+1, date.getDate()) - 2451545.0;
            const g = (357.529 + 0.98560028 * jd) % 360;
            const q = (280.459 + 0.98564736 * jd) % 360;
            const L = (q + 1.915 * Math.sin(g*D2R) + 0.02 * Math.sin(2*g*D2R)) % 360;
            const e = 23.439 - 0.00000036 * jd;
            const RA = R2D * Math.atan2(Math.cos(e*D2R) * Math.sin(L*D2R), Math.cos(L*D2R)) / 15;
            const decl = R2D * Math.asin(Math.sin(e*D2R) * Math.sin(L*D2R));
            const eqt = q/15 - RA;
            const noon = 12 - eqt - (lng/15) + 8; // UTC+8
            
            const hourAngle = (angle) => {
                const term = (Math.sin(angle*D2R) - Math.sin(lat*D2R)*Math.sin(decl*D2R)) / (Math.cos(lat*D2R)*Math.cos(decl*D2R));
                return Math.abs(term) <= 1 ? R2D * Math.acos(term) / 15 : 0;
            }

            const imsak = noon - hourAngle(-19.5) - (10/60); 
            const fajr = noon - hourAngle(-20);
            const asr = noon + (Math.abs((Math.sin(Math.atan(1/(1+Math.tan(Math.abs(lat-decl)*D2R))))) - Math.sin(lat*D2R)*Math.sin(decl*D2R)) <= 1 ? R2D*Math.acos((Math.sin(Math.atan(1/(1+Math.tan(Math.abs(lat-decl)*D2R))))) - Math.sin(lat*D2R)*Math.sin(decl*D2R))/(Math.cos(lat*D2R)*Math.cos(decl*D2R)) : 0)/15;
            const maghrib = noon + hourAngle(0.833);
            const isha = noon + hourAngle(-18);

            const fmt = (t) => { t=(t+24)%24; let h=Math.floor(t), m=Math.floor((t-h)*60); return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; };
            
            return { Imsak: fmt(imsak), Subuh: fmt(fajr), Zohor: fmt(noon), Asar: fmt(asr), Maghrib: fmt(maghrib), Isyak: fmt(isha) };
        }
    };

    /* --- UI LOGIC --- */
    function render() {
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        const firstDay = new Date(y, m, 1);
        const lastDay = new Date(y, m + 1, 0);
        
        // Titles
        document.getElementById('mTitle').textContent = firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        const startH = jdToIslamic(jdFromDate(y, m+1, 1));
        const endH = jdToIslamic(jdFromDate(y, m+1, lastDay.getDate()));
        document.getElementById('hTitle').textContent = `${startH.id} ${HIJRI_M[startH.im-1]} - ${endH.id} ${HIJRI_M[endH.im-1]}`;

        // Grid
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        // Padding Days
        for(let i=0; i<firstDay.getDay(); i++) grid.innerHTML += `<div class="day-cell empty"></div>`;

        // Real Days
        for(let d=1; d<=lastDay.getDate(); d++) {
            const date = new Date(y, m, d);
            const isToday = (date.toDateString() === currDate.toDateString());
            const jd = jdFromDate(y, m+1, d);
            const h = jdToIslamic(jd);
            
            const pub = HOLIDAYS.find(x => x.m === m+1 && x.d === d);
            const isl = ISLAMIC.find(x => x.im === h.im && x.id === h.id);

            const el = document.createElement('div');
            el.className = `day-cell ${isToday ? 'today' : ''}`;
            el.innerHTML = `
                <div class="num-g">${d}</div>
                <div class="num-h">${h.id}</div>
                ${isl ? '<div class="dot islam"></div>' : ''}
                ${pub ? '<div class="dot public" style="right:${isl?7:3}px"></div>' : ''}
            `;
            el.onclick = () => openDetail(date, h, pub, isl);
            grid.appendChild(el);
        }
    }

    function openDetail(date, h, pub, isl) {
        document.getElementById('dDate').textContent = date.toLocaleDateString('en-US', { weekday:'short', day:'numeric', month:'short' });
        document.getElementById('dHijri').textContent = `${h.id} ${HIJRI_M[h.im-1]} ${h.iy}`;
        document.getElementById('dLoc').textContent = `Lat: ${userLoc.lat.toFixed(2)}`;

        // Events
        const evBox = document.getElementById('dEvents');
        evBox.innerHTML = '';
        if(pub) evBox.innerHTML += `<span class="tag red">${pub.n}</span>`;
        if(isl) evBox.innerHTML += `<span class="tag green">${isl.n}</span>`;

        // Prayers
        const times = PrayerCalc.calc(date, userLoc.lat, userLoc.lon);
        const pBox = document.getElementById('dPrayers');
        pBox.innerHTML = '';
        Object.entries(times).forEach(([k,v]) => {
            pBox.innerHTML += `
                <div class="prayer-row">
                    <span style="font-weight:500">${k}</span>
                    <span style="font-weight:700">${v}</span>
                </div>`;
        });

        document.getElementById('view-detail').classList.add('active');
    }

    function closeDetail() { document.getElementById('view-detail').classList.remove('active'); }
    function changeMonth(d) { viewDate.setMonth(viewDate.getMonth() + d); render(); }
    function goToday() { viewDate = new Date(); render(); }

    render();
</script>
</body>
</html>
